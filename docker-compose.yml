services:
  engine:
    image: ghcr.io/sickfar/klaw-engine:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/engine/Dockerfile
    env_file: ~/.config/klaw/.env
    environment:
      - HOME=/home/klaw
      - KLAW_WORKSPACE=/workspace
      - KLAW_SOCKET_PATH=/home/klaw/.local/state/klaw/run/engine.sock
      - KLAW_SOCKET_PERMS=rw-rw-rw-
    volumes:
      - ~/.local/state/klaw:/home/klaw/.local/state/klaw
      - klaw-run:/home/klaw/.local/state/klaw/run
      - ~/.local/share/klaw:/home/klaw/.local/share/klaw
      - ~/workspace:/workspace
      - ~/.config/klaw:/home/klaw/.config/klaw:ro
    restart: unless-stopped

  gateway:
    image: ghcr.io/sickfar/klaw-gateway:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/gateway/Dockerfile
    env_file: ~/.config/klaw/.env
    depends_on:
      - engine
    environment:
      - HOME=/home/klaw
      - KLAW_SOCKET_PATH=/home/klaw/.local/state/klaw/run/engine.sock
    ports:
      - "37474:37474"
    volumes:
      - ~/.local/state/klaw:/home/klaw/.local/state/klaw
      - klaw-run:/home/klaw/.local/state/klaw/run
      - ~/.local/share/klaw:/home/klaw/.local/share/klaw
      - ~/.config/klaw:/home/klaw/.config/klaw:ro
    restart: unless-stopped

  cli:
    image: ghcr.io/sickfar/klaw-cli:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/cli/Dockerfile
    env_file: ~/.config/klaw/.env
    environment:
      - HOME=/home/klaw
      - KLAW_WORKSPACE=/workspace
      - KLAW_SOCKET_PATH=/home/klaw/.local/state/klaw/run/engine.sock
      - KLAW_IMAGE_TAG=${KLAW_IMAGE_TAG:-latest}
    volumes:
      - ~/.local/state/klaw:/home/klaw/.local/state/klaw
      - klaw-run:/home/klaw/.local/state/klaw/run
      - ~/.local/share/klaw:/home/klaw/.local/share/klaw
      - ~/workspace:/workspace
      - ~/.config/klaw:/home/klaw/.config/klaw
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.yml:/app/docker-compose.yml:ro
    profiles:
      - cli
    stdin_open: true
    tty: true

# Named volume for socket â€” bind-mounts don't support Unix sockets on macOS Docker Desktop (virtiofs).
# On Linux (Pi) hybrid mode, ConfigTemplates uses a bind-mount instead (Linux filesystems support sockets).
volumes:
  klaw-run:
    name: klaw-run
