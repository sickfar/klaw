# Klaw โ Design Document v0.4

> ะัะณะบะธะน, ะฝะฐะดัะถะฝัะน, ะผะพะดัะปัะฝัะน AI-ะฐะณะตะฝั ะดะปั Raspberry Pi 5 ั ะฟะพะดะดะตัะถะบะพะน ะบะธัะฐะนัะบะธั LLM.  
> ะะฐะทะฒะฐะฝะธะต ัะฐะฑะพัะตะต. Klaw โ ะพั ะฐะฝะณะป. claw (ะบะปะตัะฝั) ๐ฆ

---

## 1. ะะพัะธะฒะฐัะธั ะธ ัะตะปะธ

### ะัะพะฑะปะตะผะฐ

ะกััะตััะฒัััะธะต "claw"-ะฐะณะตะฝัั (OpenClaw, NanoClaw) ัััะฐะดะฐัั ะพั ััะฝะดะฐะผะตะฝัะฐะปัะฝัั ะฐััะธัะตะบัััะฝัั ะฟัะพะฑะปะตะผ:

- **OpenClaw**: heartbeat ะฟะพััะตะฑะปัะตั 170kโ210k ัะพะบะตะฝะพะฒ ะทะฐ ะทะฐะฟััะบ, cron-ะทะฐะดะฐัะธ ัะตัััััั ะฟัะธ ะบะพะผะฟะฐะบัะธะธ ัะตััะธะน, ัะพะปะปะพะฒะตั ะฒ 4 ัััะฐ ะปะพะผะฐะตั ะดะพะปะณะธะต ะทะฐะดะฐัะธ. ะะพะฝะพะปะธั ะฝะฐ 430k ัััะพะบ, ะณะดะต ะฟะปะฐะฝะธัะพะฒัะธะบ, gateway ะธ LLM-ัะตััะธั ะดะตะปัั ัะพััะพัะฝะธะต.
- **NanoClaw**: ะดะตะดะปะพะบะธ ะฟัะธ ะบะพะฝะบััะตะฝัะฝะพะผ ะดะพัััะฟะต ะบ ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝัะผ ะทะฐะดะฐัะฐะผ, ะฒะตะฝะดะพั-ะปะพะบ ะฝะฐ Claude Agent SDK (ะฝะธะบะฐะบะธั ะบะธัะฐะนัะบะธั LLM), ะผะธะฝะธะผะฐะปัะฝะฐั ะฟะฐะผััั ะฑะตะท ัะตะผะฐะฝัะธัะตัะบะพะณะพ ะฟะพะธัะบะฐ.
- **Letta**: ะพัะปะธัะฝะฐั ะฟะฐะผััั, ะฝะพ ะฝะตั ะฒัััะพะตะฝะฝะพะณะพ ะฟะปะฐะฝะธัะพะฒัะธะบะฐ.
- **Agent Zero**: ะฝะฐะดัะถะฝัะน ะฟะปะฐะฝะธัะพะฒัะธะบ, ะฝะพ ััะถัะปัะน ะดะปั ARM.

ะะธ ะพะดะธะฝ ััะตะนะผะฒะพัะบ ะฝะต ะพะฑัะตะดะธะฝัะตั: ะฝะฐะดัะถะฝัะน cron, ะบะฐัะตััะฒะตะฝะฝัั ัะตะผะฐะฝัะธัะตัะบัั ะฟะฐะผััั, ะฟะพะดะดะตัะถะบั ะบะธัะฐะนัะบะธั LLM ะธ ัััะตะบัะธะฒะฝัั ัะฐะฑะพัั ะฝะฐ ARM.

### ะฆะตะปะธ

1. **ะะฐะดัะถะฝัะน cron/scheduler**, ะฝะต ะทะฐะฒะธัััะธะน ะพั ัะพััะพัะฝะธั LLM-ัะตััะธะธ
2. **ะะฐัะตััะฒะตะฝะฝะฐั ะฟะฐะผััั** ั ัะตะผะฐะฝัะธัะตัะบะธะผ ะฟะพะธัะบะพะผ (sqlite-vec + ะปะพะบะฐะปัะฝัะต ัะผะฑะตะดะดะธะฝะณะธ)
3. **ะะพะดะดะตัะถะบะฐ ะบะธัะฐะนัะบะธั LLM**: GLM-5, DeepSeek, Qwen ัะตัะตะท OpenAI-compatible API
4. **ะะฐะฑะพัะฐ ะฝะฐ Raspberry Pi 5** (16GB RAM)
5. **ะัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ** ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝัั Docker-ะบะพะฝัะตะนะฝะตัะฐั (sandboxed)
6. **ะะฐััะธััะตะผะฐั ัะธััะตะผะฐ skills**
7. **ะงะตะปะพะฒะตะบะพัะธัะฐะตะผะพะต ััะฐะฝะธะปะธัะต** โ ัะฐะนะปั ะบะฐะบ source of truth

### ะะต-ัะตะปะธ

- ะะพะดะดะตัะถะบะฐ 15+ ะผะตััะตะฝะดะถะตัะพะฒ (ะฝะฐัะธะฝะฐะตะผ ั Telegram + Discord)
- ะะฝะตัะฝะธะต ะทะฐะฒะธัะธะผะพััะธ ะดะปั ะฟะฐะผััะธ (Letta, PostgreSQL, pgvector)
- ะะธะทัะฐะปัะฝัะน UI / ะฒะตะฑ-ะธะฝัะตััะตะนั (CLI-first)
- Multi-agent ะพัะบะตัััะฐัะธั (ะพะดะธะฝ ะฐะณะตะฝั, ะพะดะธะฝ ะฟะพะปัะทะพะฒะฐัะตะปั)

---

## 2. ะััะธัะตะบัััะฐ

### 2.1. ะะฒะฐ ะฟัะพัะตััะฐ: Gateway ะธ Engine

ะะปััะตะฒะพะต ะฐััะธัะตะบัััะฝะพะต ัะตัะตะฝะธะต: **ะดะฒะฐ ะฟัะพัะตััะฐ โ Gateway ะธ Engine**, ัะฒัะทะฐะฝะฝัั ัะตัะตะท Unix domain socket. ะะฐะถะดัะน ะฟัะพัะตัั ะฒะปะฐะดะตะตั ัะฒะพะธะผะธ ะดะฐะฝะฝัะผะธ, ะฝะธ ะพะดะธะฝ ะฝะต ัะฐะทะดะตะปัะตั ัะพััะพัะฝะธะต ั ะดััะณะธะผะธ. Scheduler โ ะผะพะดัะปั ะฒะฝัััะธ Engine (Quartz ะฒ ัะพะผ ะถะต JVM), ะฐ ะฝะต ะพัะดะตะปัะฝัะน ะฟัะพัะตัั.

```
โโโโโโโโโโโโโโโโโโโ
โ     Gateway      โ
โ  (Telegram,      โ
โ   Discord)       โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ persistent
         โ JSONL socket
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                Engine                     โ
โ          (ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั           โ
โ      klaw.db + sqlite-vec + scheduler.db)โ
โ                                           โ
โ  โโโโโโโโโโโโ โโโโโโโโโโ โโโโโโโโโโโโโโโ โ
โ  โ LLM API  โ โMemory โ โ Docker API  โ โ
โ  โ(GLM-5,   โ โsqlite- โ โ(code exec)  โ โ
โ  โ DeepSeek,โ โvec+ONNXโ โ             โ โ
โ  โ Qwen)    โ โ        โ โ             โ โ
โ  โโโโโโโโโโโโ โโโโโโโโโโ โโโโโโโโโโโโโโโ โ
โ                                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Scheduler (Quartz JDBC, in-process)  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โฒ
         โ persistent
         โ JSONL socket
         โผ
โโโโโโโโโโโโโโโโโโโ
โ     Gateway      โ
โ  (ะพัะฒะตัั โ       โ
โ   Engine pushes)  โ
โโโโโโโโโโโโโโโโโโโ

CLI โโengine.sockโโโ Engine
```

**ะะพัะตะผั Scheduler ะฒ Engine, ะฐ ะฝะต ะพัะดะตะปัะฝัะน ะฟัะพัะตัั ะธ ะฝะต ะฒ Gateway?**

Scheduler โ ะณะตะฝะตัะฐัะพั ัะพะพะฑัะตะฝะธะน ะดะปั Engine ะฟะพ ัะฐัะฟะธัะฐะฝะธั. ะะผั ะฝัะถะฝะพ ะทะฝะฐัั ะฟัะพ ะผะพะดะตะปะธ (`model`), ะบัะดะฐ inject'ะธัั ัะตะทัะปััะฐั (`injectInto`) โ ััะพ Engine'ะพะฒัะบะธะต ะบะพะฝัะตะฟัั. ะัะปะธ ะฟะพะผะตััะธัั Scheduler ะฒ Gateway, Gateway ะฝะฐัะฝัั ะทะฝะฐัั ะฟัะพ ะฑะธะทะฝะตั-ะปะพะณะธะบั ััะฑะฐะณะตะฝัะพะฒ, ะฝะฐัััะธััั ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ. Gateway โ ัะธัััะน ััะฐะฝัะฟะพัั. ะ Scheduler ะฑะตะท Engine ะฑะตัะฟะพะปะตะทะตะฝ (ะฝะตะบัะดะฐ ัะปะฐัั ัะพะพะฑัะตะฝะธั), ะฟะพััะพะผั fault isolation ะพัะดะตะปัะฝะพะณะพ ะฟัะพัะตััะฐ ะฝะต ะดะฐัั ะฟัะฐะบัะธัะตัะบะพะน ะฟะพะปัะทั. ะญะบะพะฝะพะผะธะผ ~50MB RAM ะธ ะพะดะธะฝ systemd service.

### 2.2. ะะพัะตะผั ะดะฒะฐ, ะฐ ะฝะต ะพะดะธะฝ

ะ OpenClaw gateway ะธ engine ะถะธะฒัั ะฒ ะพะดะฝะพะผ ะฟัะพัะตััะต Node.js โ "ัะฐะทะดะตะปะตะฝะธะต" ัะธััะพ ะปะพะณะธัะตัะบะพะต. ะะพะผะฟะฐะบัะธั ัะตััะธะธ ะฒะตัะฐะตั ะฒะตัั gateway, cron-ะทะฐะดะฐัะธ ัะตัััััั ะฟัะธ ัะพะปะปะพะฒะตัะต.

ะฃ ะฝะฐั:

- **Gateway ัะฟะฐะป** โ Engine (ะฒะบะปััะฐั Scheduler) ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั. ะัะพะดััะธะต ัะพะพะฑัะตะฝะธั ะฑััะตัะธะทััััั ะฝะฐ ััะพัะพะฝะต Telegram/Discord. Scheduled-ะทะฐะดะฐัะธ ะฑะตะท `injectInto` ะฒัะฟะพะปะฝััััั ะฝะพัะผะฐะปัะฝะพ; ะทะฐะดะฐัะธ ั `injectInto` ะปะพะณะธัััััั, ะดะพััะฐะฒะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะฟัะพะธะทะพะนะดัั ะฟัะธ ัะตะบะพะฝะฝะตะบัะต Gateway.
- **Engine ัะฟะฐะป** โ Gateway ะฑััะตัะธะทัะตั ัะพะพะฑัะตะฝะธั ะฒ ะปะพะบะฐะปัะฝัะน ัะฐะนะป (`gateway-buffer.jsonl`). ะัะธ ัะตะบะพะฝะฝะตะบัะต โ ะดะพััะปะฐะตั ะธะท ะฑััะตัะฐ. Quartz misfire recovery ะฟัะธ ัะตััะฐััะต Engine.
- **ะะพะผะฟะฐะบัะธั/ััะผะผะฐัะธะทะฐัะธั** โ ัะพะฝะพะฒะฐั ะพะฟะตัะฐัะธั engine, ะฝะต ะฑะปะพะบะธััะตั ะฟัะธัะผ ัะพะพะฑัะตะฝะธะน.

### 2.3. ะะตะถะฟัะพัะตััะฝะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต: persistent JSONL socket

Gateway ะดะตัะถะธั **persistent Unix domain socket** ัะพะตะดะธะฝะตะฝะธะต ะบ Engine. ะัะพัะพะบะพะป โ **JSONL ะฒ ะพะฑะต ััะพัะพะฝั**: ะบะฐะถะดะฐั ัััะพะบะฐ โ JSON-ะพะฑัะตะบั. Engine ะฟััะธั ะพัะฒะตัั ะฒ ัะพ ะถะต ัะพะตะดะธะฝะตะฝะธะต. Scheduler โ ะผะพะดัะปั Engine, ะพะฑัะฐะตััั ัะตัะตะท internal function calls, ะฝะต ัะตัะตะท socket.

```
Gateway โโโpersistent JSONLโโโ Engine

โ {"type":"inbound","id":"msg_001","channel":"telegram","chatId":"telegram_123456","content":"ะัะธะฒะตั","ts":"2026-02-24T14:30:00Z"}
โ {"type":"inbound","id":"msg_002","channel":"telegram","chatId":"telegram_789","content":"ะะฐะบ ะดะตะปะฐ","ts":"2026-02-24T14:30:05Z"}
โ {"type":"outbound","replyTo":"msg_001","channel":"telegram","chatId":"telegram_123456","content":"ะัะธะฒะตั! ..."}
โ {"type":"outbound","chatId":"telegram_123456","content":"ะะฑะฝะฐััะถะตะฝะพ 2 ะฒะฐะถะฝัั ะฟะธััะผะฐ ะพั ะบะปะธะตะฝัะฐ","meta":{"source":"heartbeat"}}
```

```
CLI โโengine.sockโโโ Engine (request-response, ะบะพัะพัะบะพะถะธะฒััะธะต ัะพะตะดะธะฝะตะฝะธั)

โ {"command":"status"}
โ {"uptime":"2h30m","sessions":[...],"queue":{"pending":0}}
```

**ะััะตัะธะทะฐัะธั ะฟัะธ ะฟะฐะดะตะฝะธะธ Engine:**

```
Gateway:
  1. ะะพะปััะธะป ัะพะพะฑัะตะฝะธะต ะธะท Telegram
  2. ะะฐะฟะธัะฐะป ะฒ conversations/ JSONL (ะฒัะตะณะดะฐ, ะฝะตะทะฐะฒะธัะธะผะพ ะพั Engine)
  3. ะะพะฟััะฐะปัั ะพัะฟัะฐะฒะธัั ะฒ engine socket
     โ ะฃัะฟะตั: ะฒัั ะพะบ
     โ Engine ะฝะตะดะพัััะฟะตะฝ: ะทะฐะฟะธัะฐะป ะฒ gateway-buffer.jsonl
  4. ะัะธ ัะตะบะพะฝะฝะตะบัะต: ะพัะฟัะฐะฒะธัั ะฒัะต ะธะท ะฑััะตัะฐ ะะะกะะะะะะะขะะะฌะะ (ะฒ ะฟะพััะดะบะต ะทะฐะฟะธัะธ),
     ะพัะธััะธัั ัะฐะนะป. Engine ะพะฑัะฐะฑะฐััะฒะฐะตั ะฑััะตัะฝัะต ัะพะพะฑัะตะฝะธั ะฟะพ ะพะดะฝะพะผั,
     ะฟัะธะผะตะฝัั ััะฐะฝะดะฐััะฝัะน debounce per chat_id. ะะพััะดะพะบ ะฒะฝัััะธ ะพะดะฝะพะณะพ chat_id
     ะณะฐัะฐะฝัะธัะพะฒะฐะฝ (JSONL append-only = ััะพะฝะพะปะพะณะธัะตัะบะธะน ะฟะพััะดะพะบ).
     ะะพััะดะพะบ ะะะะะฃ ัะฐะทะฝัะผะธ chat_id ะฝะต ะณะฐัะฐะฝัะธัะพะฒะฐะฝ (Engine ะผะพะถะตั ะพะฑัะฐะฑะพัะฐัั
     msg ะพั chat_B ัะฐะฝััะต msg ะพั chat_A, ะตัะปะธ chat_A ะฑัะป ะฒ debounce).
```

Gateway ััะฐะฝะธั `gateway-buffer.jsonl` ะฒ `$XDG_STATE_HOME/klaw/`. ะคะฐะนะป append-only, ัะพัะผะฐั ะธะดะตะฝัะธัะตะฝ socket-ะฟัะพัะพะบะพะปั. ะัะธ ัะตััะฐััะต Gateway ะฟัะพะฒะตััะตั ะฑััะตั ะธ ะดะพััะปะฐะตั. ะััะตั ัะพะดะตัะถะธั `ts` ะบะฐะถะดะพะณะพ ัะพะพะฑัะตะฝะธั โ Engine ะธัะฟะพะปัะทัะตั ะตะณะพ ะดะปั ะบะพััะตะบัะฝะพะณะพ ััะพะฝะพะปะพะณะธัะตัะบะพะณะพ ัะฐะทะผะตัะตะฝะธั ะฒ `klaw.db`, ะดะฐะถะต ะตัะปะธ ัะพะพะฑัะตะฝะธะต ะดะพััะฐะฒะปะตะฝะพ ั ะทะฐะดะตัะถะบะพะน.

### 2.4. ะะฟะธัะฐะฝะธะต ะบะพะผะฟะพะฝะตะฝัะพะฒ

#### Gateway (~500 ัััะพะบ)

**ะัะฒะตัััะฒะตะฝะฝะพััั**: ะฟัะธัะผ ัะพะพะฑัะตะฝะธะน ะธะท ะฒะฝะตัะฝะธั ะบะฐะฝะฐะปะพะฒ, ะฝะพัะผะฐะปะธะทะฐัะธั ะฒ ะตะดะธะฝัะน ัะพัะผะฐั, ะดะพััะฐะฒะบะฐ ะพัะฒะตัะพะฒ ะพะฑัะฐัะฝะพ ะฒ ะบะฐะฝะฐะปั.

- Telegram: ัะตัะตะท ะฑะธะฑะปะธะพัะตะบั `TelegramBotAPI` (InsanusMokrassar), long polling
- Discord: ัะตัะตะท `Kord`, WebSocket
- ะะฐะถะดัะน ะบะฐะฝะฐะป โ ัะตะฐะปะธะทะฐัะธั ะธะฝัะตััะตะนัะฐ `Channel`:

```kotlin
interface Channel {
    val name: String
    suspend fun listen(onMessage: suspend (IncomingMessage) -> Unit)
    suspend fun send(chatId: String, response: OutgoingMessage)
}
```

- Gateway **ะฝะต ะทะฝะฐะตั** ะฟัะพ LLM, ะฟะฐะผััั, skills, ััะฑะฐะณะตะฝัั. ะญัะพ ัะธัััะน ััะฐะฝัะฟะพัั.
- Gateway **ะพัะฟัะฐะฒะปัะตั** ัะพะพะฑัะตะฝะธั ะฒ Engine ัะตัะตะท persistent socket ะธ **ะฟะพะปััะฐะตั** ะพัะฒะตัั ะธะท ัะพะณะพ ะถะต ัะพะตะดะธะฝะตะฝะธั.
- JSONL โ ะฟะตัะตะฝะพัะธะผัะน ะปะพะณ, source of truth. SQLite-ะธะฝะดะตะบั (ะฒ Engine) ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท JSONL ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ (`klaw reindex`).

**JSONL ownership**: Gateway โ **ะตะดะธะฝััะฒะตะฝะฝัะน ะฟะธัะฐัะตะปั** ะฒ `conversations/{chat_id}/*.jsonl` ะดะปั interactive-ะบะฐะฝะฐะปะพะฒ (telegram, discord). ะัั ััะพ ะฟัะธัะพะดะธั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฒัั ััะพ ััะพะดะธั ะฟะพะปัะทะพะฒะฐัะตะปั (ะฒะบะปััะฐั ัะตะทัะปััะฐัั ััะฑะฐะณะตะฝัะพะฒ) โ ะฟะธัะตั Gateway. Engine ะฒ ััะธ ัะฐะนะปั ะฝะต ะฟะธัะตั. Engine ะฟะธัะตั ัะพะปัะบะพ ะฒ `conversations/scheduler_*/*.jsonl` โ ะพะฟัะธะพะฝะฐะปัะฝัะต ะปะพะณะธ ััะฑะฐะณะตะฝัะพะฒ ะดะปั ััะฐัะธััะธะบะธ (ัะผ. ัะตะบัะธั 2.4 Engine, `logging.subagentConversations`).

**ะะฐัััััะธะทะฐัะธั ะพัะฒะตัะพะฒ ะธะท Engine:**

Engine ะฟััะธั ะฒ Gateway ัะพะพะฑัะตะฝะธั ัะธะฟะฐ `type: "outbound"` โ Gateway ะฑะตะทััะปะพะฒะฝะพ ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะบะฐะฝะฐะป ะธ ะทะฐะฟะธััะฒะฐะตั ะฒ JSONL. Gateway **ะฝะต ะฟะฐััะธั ัะพะดะตัะถะธะผะพะต** ัะพะพะฑัะตะฝะธะน โ ัะตัะตะฝะธะต ยซะพัะฟัะฐะฒะปััั ะธะปะธ ะฝะตัยป ะฟัะธะฝะธะผะฐะตั Engine ะดะพ ะพัะฟัะฐะฒะบะธ (ัะผ. silent-ะปะพะณะธะบั ะฒ ัะตะบัะธะธ 2.4 Engine).

**Whitelist ะธััะพะดััะธั ัะพะพะฑัะตะฝะธะน**: Gateway ะฟัะพะฒะตััะตั ะฟะฐัั `channel + chatId` ะธััะพะดััะธั ัะพะพะฑัะตะฝะธะน ะฟะพ whitelist ะธะท `gateway.yaml` (`allowedChatIds`). chatId ะฟัะธะฒัะทะฐะฝ ะบ ะบะฐะฝะฐะปั: ะตัะปะธ `telegram_123456` ะฒ whitelist โ ัะพะพะฑัะตะฝะธะต ั ััะธะผ chatId ัะฐะทัะตัะตะฝะพ ัะพะปัะบะพ ะดะปั ะบะฐะฝะฐะปะฐ Telegram. ะัะปะธ chatId ะฝะต ะฒ whitelist ะธะปะธ ะบะฐะฝะฐะป ะฝะต ัะพะพัะฒะตัััะฒัะตั โ ัะพะพะฑัะตะฝะธะต ะพัะบะปะพะฝัะตััั, Gateway ะฒะพะทะฒัะฐัะฐะตั ะพัะธะฑะบั ะฒ Engine. ะญัะพ ะทะฐัะธัะฐ ะพั ะณะฐะปะปััะธะฝะธััััะตะณะพ ะฐะณะตะฝัะฐ, ะบะพัะพััะน ะผะพะถะตั ะฟะพะฟััะฐัััั ะพัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธั ะฒ ะฟัะพะธะทะฒะพะปัะฝัะต ัะฐัั ัะตัะตะท tool `send_message`.

```kotlin
fun handleOutbound(msg: OutboundMessage) {
    // ะัะพะฒะตัะธัั whitelist
    if (!isAllowedChatId(msg.chatId)) {
        engineSocket.sendError(msg.replyTo, "chatId ${msg.chatId} not in allowedChatIds")
        return
    }
    
    // ะะฐะฟะธัะฐัั ะฒ JSONL (Gateway โ ะตะดะธะฝััะฒะตะฝะฝัะน ะฟะธัะฐัะตะปั ะดะปั interactive-ะบะฐะฝะฐะปะพะฒ)
    jsonlWriter.append(msg)
    
    // ะัะฟัะฐะฒะธัั ะฟะพะปัะทะพะฒะฐัะตะปั
    channel.send(msg.chatId, OutgoingMessage(content = msg.content))
}
```

#### Engine (~1800 ัััะพะบ, ะฒะบะปััะฐั Scheduler)

**ะัะฒะตัััะฒะตะฝะฝะพััั**: ะพะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน, ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ั LLM, ัะฟัะฐะฒะปะตะฝะธะต ะฟะฐะผัััั, ะธัะฟะพะปะฝะตะฝะธะต skills, ััะฐะฝะตะฝะธะต ะธะฝะดะตะบัะพะฒ, ะฒัะฟะพะปะฝะตะฝะธะต ะทะฐะดะฐั ะฟะพ ัะฐัะฟะธัะฐะฝะธั.

**Engine โ ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั ะฒัะตั SQLite-ะฑะฐะท** (`klaw.db` ั sqlite-vec, `scheduler.db` ะดะปั Quartz). ะะธ ะพะดะธะฝ ะดััะณะพะน ะฟัะพัะตัั ะฝะต ะพัะบััะฒะฐะตั SQLite ะฝะฐะฟััะผัั. ะญัะพ ััััะฐะฝัะตั ะบะพะฝะบััะตะฝัะฝัะน ะดะพัััะฟ.

ะฆะธะบะป ะพะฑัะฐะฑะพัะบะธ ะพะดะฝะพะณะพ ัะพะพะฑัะตะฝะธั:

```
1. ะะพะปััะธัั ัะพะพะฑัะตะฝะธะต ัะตัะตะท socket (ะพั Gateway) ะธะปะธ ะพั Scheduler (internal)
2. Debounce: ะตัะปะธ ะพั ัะพะณะพ ะถะต chat_id ะทะฐ ะฟะพัะปะตะดะฝะธะต N ะผั ะฟัะธัะปะธ ะตัั ัะพะพะฑัะตะฝะธั โ ัะบะปะตะธัั
3. ะะฐะฟะธัะฐัั ะฒ klaw.db (ัะฐะฑะปะธัะฐ messages โ ะธะฝะดะตะบั ะดะปั ัะบะพะปัะทััะตะณะพ ะพะบะฝะฐ)
4. ะกะพะฑัะฐัั ะบะพะฝัะตะบัั (โ ัะฐะทะดะตะป 3. ะฃะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะตะบััะพะผ)
5. ะัะทะฒะฐัั LLM API ั ะบะพะฝัะตะบััะพะผ ะธ ัะฟะธัะบะพะผ tools
6. ะัะปะธ LLM ะฒะตัะฝัะป tool_call:
   a. ะะฐะนัะธ tool ะฟะพ ะธะผะตะฝะธ (ะฒัััะพะตะฝะฝัะต tools โ in-process)
   b. ะัะฟะพะปะฝะธัั tool:
      - ะัััะพะตะฝะฝัะต (memory_search, file_read, skill_load, ...) โ in-process
      - code_execute โ Docker-ะบะพะฝัะตะนะฝะตั (sandbox)
   c. ะะพะปััะธัั ัะตะทัะปััะฐั
   d. ะะพะฑะฐะฒะธัั ัะตะทัะปััะฐั ะฒ ะบะพะฝัะตะบัั โ ะฒะตัะฝััััั ะบ ัะฐะณั 5
   e. ะัะปะธ ะฟัะตะฒััะตะฝ maxToolCallRounds โ ะฟัะตัะฒะฐัั ัะธะบะป, ัะพะพะฑัะธัั ะพะฑ ะพัะธะฑะบะต
7. ะัะฟัะฐะฒะธัั ะพัะฒะตั:
   - ะกะพะพะฑัะตะฝะธะต ะพั Gateway โ ะพัะฒะตั ะฒ Gateway socket (type: "outbound")
   - ะกะพะพะฑัะตะฝะธะต ะพั Scheduler ั injectInto != null:
     โ ะัะปะธ ะพัะฒะตั ะฝะต silent โ ะพัะฟัะฐะฒะธัั ะฒ Gateway socket (type: "outbound")
     โ ะัะปะธ silent โ ัะพะปัะบะพ ะปะพะณ ะฒ scheduler-JSONL (ะพะฟัะธะพะฝะฐะปัะฝะพ)
   - ะกะพะพะฑัะตะฝะธะต ะพั Scheduler ั injectInto = null โ ัะพะปัะบะพ ะปะพะณ
```

**ะัะพ ะฟะธัะตั JSONL**: Gateway โ ะตะดะธะฝััะฒะตะฝะฝัะน ะฟะธัะฐัะตะปั ะดะปั interactive-ะบะฐะฝะฐะปะพะฒ (telegram, discord). Engine ะฟะธัะตั ัะพะปัะบะพ `conversations/scheduler_*/*.jsonl` โ ะพะฟัะธะพะฝะฐะปัะฝัะต ะปะพะณะธ ััะฑะฐะณะตะฝัะพะฒ ะดะปั ััะฐัะธััะธะบะธ ะธ ะดะตะฑะฐะณะฐ. ะคะพัะผะฐั ะทะฐะฟะธัะตะน ะธะดะตะฝัะธัะตะฝ interactive-ะบะฐะฝะฐะปะฐะผ (ัะตะบัะธั 5.2), ั `meta.source: "scheduler"` ะธ `meta.task_name` ะดะปั ะธะดะตะฝัะธัะธะบะฐัะธะธ ะทะฐะดะฐัะธ:

```json
{"id":"sched_001","ts":"2026-02-24T09:00:00Z","role":"user","content":"ะกะดะตะปะฐะน ัะฐะผะผะฐัะธ ะฒัะตัะฐัะฝะธั ัะพะฑััะธะน","meta":{"source":"scheduler","task_name":"daily-summary","channel":"scheduler","chat_id":"scheduler_daily-summary"}}
{"id":"sched_002","ts":"2026-02-24T09:00:15Z","role":"assistant","content":"{\"silent\": true, \"reason\": \"nothing to report\"}","meta":{"source":"scheduler","task_name":"daily-summary","channel":"scheduler","chat_id":"scheduler_daily-summary","model":"glm/glm-4-plus","tokens_in":3200,"tokens_out":45}}
```

ะัะบะปััะฐัััั ัะตัะตะท ะบะพะฝัะธะณ:

```yaml
# engine.yaml
logging:
  subagentConversations: true    # false โ ะฝะต ะฟะธัะฐัั scheduler JSONL ะฒะพะพะฑัะต
```

**Silent-ะปะพะณะธะบะฐ ััะฑะฐะณะตะฝัะพะฒ**: Engine ัะตัะฐะตั, ะพัะฟัะฐะฒะปััั ะปะธ ัะตะทัะปััะฐั ััะฑะฐะณะตะฝัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั. LLM ััะฑะฐะณะตะฝัะฐ ะฒะพะทะฒัะฐัะฐะตั JSON ั ะฟะพะปะตะผ `silent`:

```json
{"silent": true, "reason": "nothing to report"}
```

ะัะปะธ LLM ะฒะตัะฝัะป `silent: true` โ Engine ะฝะต ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ะฒ Gateway. ะัะปะธ LLM ะฒะตัะฝัะป ะพะฑััะฝัะน ัะตะบัั (ะฝะต JSON ะธะปะธ ะฑะตะท `silent`) โ Engine ะพัะฟัะฐะฒะปัะตั ะฒ Gateway ะบะฐะบ `type: "outbound"`. ะะฝััััะบัะธะธ ะดะปั LLM ะพะฟะธััะฒะฐัััั ะฒ AGENTS.md workspace'ะฐ:

```
ะัะปะธ ะทะฐะดะฐัะฐ heartbeat ะฝะต ััะตะฑัะตั ะฒะฝะธะผะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั โ ะพัะฒะตัั JSON:
{"silent": true, "reason": "ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ััะพ ะฟัะพะฒะตัะธะป"}
```

ะญัะพ ะฝะฐะดัะถะฝะตะต exact-match ะฟะพ ะผะฐะณะธัะตัะบะธะผ ัััะพะบะฐะผ: LLM ะฒะพะทะฒัะฐัะฐะตั ััััะบัััะฝัะน ะพัะฒะตั, Engine ะฟะฐััะธั JSON. ะัะปะธ ะฟะฐััะธะฝะณ ะฝะต ัะดะฐะปัั โ ััะธัะฐะตะผ ััะพ ะฝะต silent (safe default: ะพัะฟัะฐะฒะธัั ะฟะพะปัะทะพะฒะฐัะตะปั).

**Debounce ัะพะพะฑัะตะฝะธะน**: ะตัะปะธ ะพั ะพะดะฝะพะณะพ chat_id ะทะฐ `processing.debounceMs` (ะบะพะฝัะธะณััะธััะตะผะพ, ะฟะพ ัะผะพะปัะฐะฝะธั 1500ms) ะฟัะธัะปะพ ะฝะตัะบะพะปัะบะพ ัะพะพะฑัะตะฝะธะน โ Engine ัะบะปะตะธะฒะฐะตั ะธั ะฒ ะพะดะฝะพ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน ะฒ LLM. ะขะธะฟะธัะฝัะน ะบะตะนั: ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะธัะตั ััะตะผั ัะพะพะฑัะตะฝะธัะผะธ ะฟะพะดััะด "ะฟะพัะผะพััะธ" "ะฒะพั ััะพั ัะฐะนะป" "ะธ ัะบะฐะถะธ ััะพ ะดัะผะฐะตัั". Engine ะถะดัั ะฟะฐัะทั, ัะบะปะตะธะฒะฐะตั, ะพะฑัะฐะฑะฐััะฒะฐะตั ะบะฐะบ ะพะดะฝะพ ัะพะพะฑัะตะฝะธะต.

```yaml
# engine.yaml
processing:
  debounceMs: 1500               # ัะบะปะตะธัั ัะพะพะฑัะตะฝะธั ะพั ะพะดะฝะพะณะพ chat_id ะทะฐ ััะพ ะฒัะตะผั
  maxConcurrentLlm: 2            # ะผะฐะบั ะฟะฐัะฐะปะปะตะปัะฝัั LLM-ะทะฐะฟัะพัะพะฒ (interactive + subagent)
  maxToolCallRounds: 10          # ะผะฐะบั ะธัะตัะฐัะธะน tool call loop (ะทะฐัะธัะฐ ะพั ะทะฐัะธะบะปะธะฒะฐะฝะธั)
```

**Rate limiting**: Engine ะพะณัะฐะฝะธัะธะฒะฐะตั ะบะพะปะธัะตััะฒะพ ะฟะฐัะฐะปะปะตะปัะฝัั LLM-ะทะฐะฟัะพัะพะฒ ัะตัะตะท ัะตะผะฐัะพั (`maxConcurrentLlm`). Interactive-ัะพะพะฑัะตะฝะธั ะธะผะตัั ะฟัะธะพัะธัะตั ะฒััะต ััะฑะฐะณะตะฝัะพะฒ: Engine ะธัะฟะพะปัะทัะตั ะฟัะธะพัะธัะตัะฝัั ะพัะตัะตะดั, ะณะดะต interactive-ะทะฐะฟัะพัั ะฒััะตัะฝััั ััะฑะฐะณะตะฝัะพะฒ. ะัะปะธ ะพะฑะฐ ัะปะพัะฐ ะทะฐะฝััั ััะฑะฐะณะตะฝัะฐะผะธ ะธ ะฟัะธัะพะดะธั interactive-ัะพะพะฑัะตะฝะธะต, interactive ะถะดัั ะฑะปะธะถะฐะนัะตะณะพ ะพัะฒะพะฑะพะดะธะฒัะตะณะพัั ัะปะพัะฐ (ััะฑะฐะณะตะฝั ะฝะต ะฟัะตััะฒะฐะตััั mid-request, ะฝะพ ัะปะตะดัััะธะน ัะปะพั ะพัะดะฐัััั interactive).

**ะะพััะดะพะบ: debounce โ ะพัะตัะตะดั ะฝะฐ LLM-ัะปะพั.** Debounce ะธ rate limiting โ ัะฐะทะฝัะต ััะฐะดะธะธ ะบะพะฝะฒะตะนะตัะฐ, ะฝะต ะบะพะฝะบััะธัััั. Debounce ัะฐะฑะพัะฐะตั ะฝะฐ ััะพะฒะฝะต ะฟัะธัะผะฐ ัะพะพะฑัะตะฝะธะน (ะดะพ ะพะฑัะฐะฑะพัะบะธ), ัะตะผะฐัะพั โ ะฝะฐ ััะพะฒะฝะต ะฒัะทะพะฒะฐ LLM:

```
1. ะกะพะพะฑัะตะฝะธะต ะฟัะธัะพะดะธั ะธะท socket โ ะทะฐะฟะธััะฒะฐะตััั ะฒ klaw.db
2. Debounce timer ััะฐัััะตั/ัะตััะฐััะธััั ะดะปั chat_id
3. ะะพะบะฐ ะธะดัั debounce โ ะฝะพะฒัะต ัะพะพะฑัะตะฝะธั ะพั ัะพะณะพ ะถะต chat_id
   ะะ ะฒััะฐัั ะฒ ะพัะตัะตะดั ะฝะฐ LLM-ัะปะพั, ะฐ ะฝะฐะบะฐะฟะปะธะฒะฐัััั ะฒ debounce-ะฑััะตัะต
4. Debounce timer ะธัััะบ (1500ms ะฑะตะท ะฝะพะฒัั ัะพะพะฑัะตะฝะธะน ะพั chat_id)
   โ ะัะต ะฝะฐะบะพะฟะปะตะฝะฝัะต ัะพะพะฑัะตะฝะธั ัะบะปะตะธะฒะฐัััั ะฒ ะพะดะฝะพ
5. ะกะบะปะตะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต ะฒััะฐัั ะฒ ะฟัะธะพัะธัะตัะฝัั ะพัะตัะตะดั ะฝะฐ LLM-ัะปะพั
   (interactive > subagent)
6. ะะพะณะดะฐ ัะปะพั ะพัะฒะพะฑะพะถะดะฐะตััั โ ะบะพะฝัะตะบัั โ LLM
```

ะัะธะผะตั: ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะธัะตั 3 ัะพะพะฑัะตะฝะธั ั ะฟะฐัะทะพะน 1ั ะบะฐะถะดะพะต, ะพะฑะฐ LLM-ัะปะพัะฐ ะทะฐะฝััั.
Debounce ัะพะฑะธัะฐะตั ะฒัะต ััะธ (1ั < 1.5ั ะฟะพัะพะณะฐ ะผะตะถะดั ะบะฐะถะดัะผ), ัะตัะตะท 1.5ั ะฟะพัะปะต ะฟะพัะปะตะดะฝะตะณะพ
ัะพะพะฑัะตะฝะธั ะพะดะฝะพ ัะบะปะตะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต ะฒััะฐัั ะฒ ะพัะตัะตะดั ะธ ะถะดัั ัะปะพั. ะัะปะธ ะฑั ะฟะฐัะทะฐ ะผะตะถะดั
ัะพะพะฑัะตะฝะธัะผะธ ะฑัะปะฐ >1.5ั โ ะฟะตัะฒะพะต ััะปะพ ะฑั ะฒ ะพัะตัะตะดั ััะฐะทั, ะพััะฐะปัะฝัะต โ ะพัะดะตะปัะฝัะผะธ ะทะฐะฟัะพัะฐะผะธ.

**Tool call loop protection**: ะัะปะธ LLM ะฒะพะทะฒัะฐัะฐะตั tool_call ะฑะพะปะตะต `maxToolCallRounds` ัะฐะท ะฟะพะดััะด โ ัะธะบะป ะฟัะตััะฒะฐะตััั, Engine ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ัะพะพะฑัะตะฝะธะต ะพะฑ ะพัะธะฑะบะต: ยซะะพััะธะณะฝัั ะปะธะผะธั ะฒัะทะพะฒะพะฒ ะธะฝััััะผะตะฝัะพะฒ. ะะพะฟัะพะฑัะนัะต ะฟะตัะตัะพัะผัะปะธัะพะฒะฐัั ะทะฐะฟัะพั.ยป ะญัะพ ะทะฐัะธัะฐ ะพั ะทะฐัะธะบะปะธะฒะฐะฝะธั, ะบะพัะพัะพะต ะฑัะฒะฐะตั ั ะบะธัะฐะนัะบะธั ะผะพะดะตะปะตะน ั ะฝะตััะฐะฑะธะปัะฝัะผ function calling.

ะกะพััะฐะฝะตะฝะธะต ัะฐะบัะพะฒ ะฒ archival memory (embed โ sqlite-vec) ะฟัะพะธััะพะดะธั **ะฝะต ะฐะฒัะพะผะฐัะธัะตัะบะธ**, ะฐ ัะตัะตะท tool call `memory_save` ะฝะฐ ัะฐะณะต 6 โ LLM ัะฐะผ ัะตัะฐะตั, ััะพ ััะพะธั ะทะฐะฟะพะผะฝะธัั. ะญัะพ ะฟะพะฒะตะดะตะฝะธะต ะพะฟะธััะฒะฐะตััั ะฒ SOUL.md / AGENTS.md.

ะะทะฐะธะผะพะดะตะนััะฒะธั engine ั ะฒะฝะตัะฝะธะผะธ ัะธััะตะผะฐะผะธ:

| ะกะธััะตะผะฐ | ะัะพัะพะบะพะป | ะะฐะทะฝะฐัะตะฝะธะต |
|---------|----------|------------|
| LLM API | HTTP (OpenAI-compatible) | ะะตะฝะตัะฐัะธั ะพัะฒะตัะพะฒ, tool calling |
| sqlite-vec + ONNX | Embedded (in-process) | ะััะธะฒะฝะฐั ะฟะฐะผััั, ัะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ |
| Docker | Unix socket `/var/run/docker.sock` | ะัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ (`code_execute`) ะฒ sandbox |
| SQLite (`klaw.db`) | Embedded (in-process) | ะะฝะดะตะบั ัะพะพะฑัะตะฝะธะน, ัะตััะธะธ, vec, FTS |
| SQLite (`scheduler.db`) | Embedded (in-process) | Quartz JDBC JobStore |
| ะคะฐะนะปะพะฒะฐั ัะธััะตะผะฐ | Direct I/O | JSONL ะปะพะณะธ (scheduler), ัะฐะผะผะฐัะธ, ะบะพะฝัะธะณะธ |
| Gateway | Unix domain socket | ะัะธัะผ ัะพะพะฑัะตะฝะธะน, ะพัะฟัะฐะฒะบะฐ ะพัะฒะตัะพะฒ |

**Engine socket server**:

Engine ะฟัะธ ััะฐััะต ัะปััะฐะตั `$XDG_STATE_HOME/klaw/engine.sock`. ะัะธะฝะธะผะฐะตั ะดะฒะฐ ัะธะฟะฐ ะบะปะธะตะฝัะพะฒ:

1. **Gateway** โ persistent connection, ัะตะณะธัััะธััะตััั ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ: `{"type":"register","client":"gateway"}`. Engine ะฟััะธั ะพัะฒะตัั ะฒ ััะพ ัะพะตะดะธะฝะตะฝะธะต.
2. **CLI** โ ะบะพัะพัะบะพะถะธะฒััะธะต ัะพะตะดะธะฝะตะฝะธั, request-response.

```kotlin
// Engine ะฟัะธ ััะฐััะต
val socketPath = KlawPaths.state / "engine.sock"
val server = UnixServerSocketChannel.open()
server.bind(UnixDomainSocketAddress.of(socketPath))

// ะะฑัะฐะฑะพัะบะฐ ะฟะพะดะบะปััะตะฝะธะน
when (registration.client) {
    "gateway" -> gatewayConnection = connection  // ัะพััะฐะฝะธัั ะดะปั push'ะฐ ะพัะฒะตัะพะฒ
    else      -> handleCliRequest(connection)    // request-response, ะทะฐะบัััั
}
```

ะกะพะบะตั ะทะฐัะธััะฝ ะฟัะฐะฒะฐะผะธ ัะฐะนะปะพะฒะพะน ัะธััะตะผั (`chmod 600`) โ ะดะพัััะฟะตะฝ ัะพะปัะบะพ ะฒะปะฐะดะตะปััั ะฟัะพัะตััะฐ. Gateway ะธ Engine ะดะพะปะถะฝั ัะฐะฑะพัะฐัั ะฟะพะด ะพะดะฝะธะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ (ะธะปะธ ะธัะฟะพะปัะทะพะฒะฐัั ะพะฑััั ะณััะฟะฟั).

**Graceful shutdown**:

ะัะธ `systemctl stop klaw-engine`:
1. Quartz `scheduler.shutdown(waitForJobsToComplete = true)` โ ะถะดัั ะทะฐะฒะตััะตะฝะธั ัะตะบััะธั scheduled jobs
2. Engine ะฟะตัะตััะฐัั ะฟัะธะฝะธะผะฐัั ะฝะพะฒัะต ัะพะพะฑัะตะฝะธั ะธะท socket (ะพัะฟัะฐะฒะปัะตั `{"type":"shutdown"}` ะฒ Gateway)
3. ะะถะธะดะฐะฝะธะต ะทะฐะฒะตััะตะฝะธั ัะตะบััะธั LLM-ะฒัะทะพะฒะพะฒ (ัะฐะนะผะฐัั: 60 ัะตะบัะฝะด)
4. ะัะปะธ mid-flight tool call loop ะฝะต ะทะฐะฒะตััะธะปัั ะทะฐ ัะฐะนะผะฐัั โ ะปะพะณะธััะตะผ ัะพััะพัะฝะธะต, ะบะพัััะธะฝะฐ ะพัะผะตะฝัะตััั
5. ะะฐะบัััะธะต SQLite-ัะพะตะดะธะฝะตะฝะธะน (`klaw.db`, `scheduler.db`)
6. ะฃะดะฐะปะตะฝะธะต `engine.sock`

ะัะธ ะฟะพัะตัะต ะฟะธัะฐะฝะธั (ัะธะฟะธัะฝัะน ััะตะฝะฐัะธะน ะดะปั Pi 5 ะฝะฐ SD-ะบะฐััะต): SQLite WAL ะพะฑะตัะฟะตัะธะฒะฐะตั ัะตะปะพััะฝะพััั ะฑะฐะท, JSONL append-only ะฝะต ะฟะพะฒัะตะถะดะฐะตััั (ะฟะพัะปะตะดะฝัั ะฝะตะฟะพะปะฝะฐั ัััะพะบะฐ ะธะณะฝะพัะธััะตััั ะฟัะธ ััะตะฝะธะธ), Quartz misfire recovery ะฟัะธ ัะปะตะดัััะตะผ ััะฐััะต.

#### Scheduler (ะผะพะดัะปั Engine, ~300 ัััะพะบ)

**ะัะฒะตัััะฒะตะฝะฝะพััั**: ะฒัะฟะพะปะฝะตะฝะธะต ะทะฐะดะฐั ะฟะพ ัะฐัะฟะธัะฐะฝะธั โ ะณะตะฝะตัะธััะตั ัะพะพะฑัะตะฝะธั ะดะปั Engine ะฟะพ cron-ะฒััะฐะถะตะฝะธัะผ.

Scheduler โ **ะผะพะดัะปั ะฒะฝัััะธ Engine** (ะฝะต ะพัะดะตะปัะฝัะน ะฟัะพัะตัั). ะะพัััะพะตะฝ ะฝะฐ [Quartz Scheduler](http://www.quartz-scheduler.org/) ั JDBC JobStore (SQLite). ะะปั ัะฐะฑะพัั ั SQLite ะธัะฟะพะปัะทัะตััั ะบะฐััะพะผะฝัะน `SQLiteDelegate`, ะฟะตัะตะพะฟัะตะดะตะปัััะธะน Quartz `StdJDBCDelegate` ะดะปั ัะพะฒะผะตััะธะผะพััะธ (SQLite ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั `SELECT ... FOR UPDATE` โ ะธัะฟะพะปัะทัะตััั `BEGIN IMMEDIATE` ะฒะผะตััะพ row-level locking). ะะตะถะธะผ: single-node (`org.quartz.jobStore.isClustered = false`), ะฑะตะท `QRTZ_LOCKS`.

Quartz ะฑะตััั ะฝะฐ ัะตะฑั cron-ะฟะฐััะธะฝะณ, misfire handling, ะฟะตััะธััะตะฝัะฝะพััั ะทะฐะดะฐั โ ะฝะต ะฝัะถะฝะพ ะฟะธัะฐัั ัะฒะพะน cron loop.

ะะฐะดะฐัะธ ััะฐะฝัััั ะฒ ััะฐะฝะดะฐััะฝัั ัะฐะฑะปะธัะฐั Quartz ะฒ `$XDG_DATA_HOME/klaw/scheduler.db` โ **Engine ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั ััะพะน ะฑะฐะทั** (ะบะฐะบ ะธ `klaw.db`). ะฃะฟัะฐะฒะปััััั ัะตัะตะท tools (`schedule_add`, `schedule_remove`), CLI (`klaw schedule add`) ะธะปะธ ะธะผะฟะพัั HEARTBEAT.md.

```kotlin
// ะะดะธะฝััะฒะตะฝะฝัะน Job โ ะฒัะทัะฒะฐะตั Engine ะฝะฐะฟััะผัั (in-process)
class ScheduledMessageJob : Job {
    override fun execute(context: JobExecutionContext) {
        val data = context.mergedJobDataMap
        val message = ScheduledMessage(
            name = data.getString("name"),
            message = data.getString("message"),
            model = data.getString("model"),         // ะผะพะดะตะปั ะดะปั ััะฑะฐะณะตะฝัะฐ
            injectInto = data.getString("injectInto"),
        )
        // ะััะผะพะน ะฒัะทะพะฒ Engine โ ะฝะต ัะตัะตะท socket, ะฐ ัะตัะตะท internal API
        engine.handleScheduledMessage(message)
    }
}

// ะะพะฑะฐะฒะปะตะฝะธะต ะทะฐะดะฐัะธ โ ััะฐะฝะดะฐััะฝัะน Quartz API
fun addSchedule(name: String, cron: String, message: String, model: String?, injectInto: String?) {
    val job = JobBuilder.newJob(ScheduledMessageJob::class.java)
        .withIdentity(name)
        .usingJobData("name", name)
        .usingJobData("message", message)
        .usingJobData("model", model)
        .usingJobData("injectInto", injectInto)
        .storeDurably()
        .build()
    val trigger = TriggerBuilder.newTrigger()
        .withIdentity(name)
        .withSchedule(CronScheduleBuilder.cronSchedule(cron)
            .withMisfireHandlingInstructionFireAndProceed())
        .build()
    scheduler.scheduleJob(job, trigger)
}
```

**ะัะต ะทะฐะดะฐัะธ persistent** โ ััะฐะฝัััั ะฒ Quartz JDBC JobStore (SQLite), ะฟะตัะตะถะธะฒะฐัั ัะตััะฐัั. ะะตั ัะฐะทะดะตะปะตะฝะธั ะฝะฐ "runtime" ะธ "persistent": `schedule_add` โ ะทะฐะฟะธัั ะฒ Quartz, `schedule_remove` โ ัะดะฐะปะตะฝะธะต ะธะท Quartz.

Scheduler **ะฝะต ะทะฝะฐะตั** ะฟัะพ LLM, ะบะพะฝัะตะบััั, ััะฑะฐะณะตะฝัั. ะะฝ ะฟัะพััะพ ะณะตะฝะตัะธััะตั `ScheduledMessage` ะธ ะฟะตัะตะดะฐัั Engine. Engine ัะตัะฐะตั, ะบะฐะบ ะพะฑัะฐะฑะพัะฐัั.

**ะกัะฑะฐะณะตะฝัะฝะฐั ะผะพะดะตะปั (Engine)**: cron/heartbeat ะทะฐะดะฐัะธ ะฒัะฟะพะปะฝััััั ะฒ Engine **ะฟะฐัะฐะปะปะตะปัะฝะพ** ั ะพัะฝะพะฒะฝะพะน ัะตััะธะตะน. ะ 90% ัะปััะฐะตะฒ ะธะผ ะฝะต ะฝัะถะตะฝ ัะตะบััะธะน ะบะพะฝัะตะบัั ัะฐะทะณะพะฒะพัะฐ โ ัะพะปัะบะพ ะฑะฐะทะพะฒัะน ะบะพะฝัะตะบัั. LLM-ะฟัะพะฒะฐะนะดะตัั ะฒัั ัะฐะฒะฝะพ, ัะบะพะปัะบะพ ะฟะฐัะฐะปะปะตะปัะฝัั ะทะฐะฟัะพัะพะฒ ะฟัะธะปะตัะธั.

**ะะพะดะตะปั ััะฑะฐะณะตะฝัะฐ**: ะบะฐะถะดะฐั scheduled-ะทะฐะดะฐัะฐ ะธะผะตะตั ะฟัะธะฒัะทะฐะฝะฝัั ะผะพะดะตะปั (`model` ะฒ Quartz JobData). ะะฐะดะฐัััั ะฟัะธ ัะพะทะดะฐะฝะธะธ ัะตัะตะท `schedule_add` tool, CLI, ะธะปะธ ะบะพะฝัะธะณ. ะัะปะธ ะฝะต ะทะฐะดะฐะฝะฐ โ ะธัะฟะพะปัะทัะตััั `routing.tasks.subagent` ะธะท `engine.yaml`.

```
ะัะฝะพะฒะฝะฐั ัะตััะธั (interactive):           ะกัะฑะฐะณะตะฝั (heartbeat):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ System prompt (SOUL/AGENTS)โ โ ะพะฑัะธะน โ โ System prompt (SOUL/AGENTS)โ
โ Core memory                โ โ ะพะฑัะธะน โ โ Core memory                โ
โ memory_search (on-demand)  โ โ ะพะฑัะธะน โ โ memory_search (on-demand)  โ
โ ะะพัะปะตะดะฝะธะต 20 ัะพะพะฑัะตะฝะธะน     โ โ ะกะะะ    โ ะะพัะปะตะดะฝะธะต 5 heartbeat'ะพะฒ   โ โ ะกะะะ
โ ะะพะดะตะปั ะธะท session          โ โ ะกะะะ    โ ะะพะดะตะปั ะธะท ะทะฐะดะฐัะธ/ะบะพะฝัะธะณะฐ   โ โ ะกะะะ
โ Tools/Skills               โ โ ะพะฑัะธะน โ โ Tools/Skills               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ ะฟะฐัะฐะปะปะตะปัะฝะพ โ
```

Engine ะพะฑัะฐะฑะฐััะฒะฐะตั ะธะฝัะตัะฐะบัะธะฒะฝัะต ะธ cron-ะทะฐะดะฐัะธ ะฒ **ะฟะฐัะฐะปะปะตะปัะฝัั ะบะพัััะธะฝะฐั**, ะบะฐะถะดะฐั ัะพ ัะฒะพะธะผ ัะพะฑัะฐะฝะฝัะผ ะบะพะฝัะตะบััะพะผ.

**ะะตะทัะปััะฐั ััะฑะฐะณะตะฝัะฐ โ ะฟะพะปัะทะพะฒะฐัะตะปั**: Engine ะฟัะพะฒะตััะตั ะพัะฒะตั ััะฑะฐะณะตะฝัะฐ ะฝะฐ ะฝะฐะปะธัะธะต `silent` ัะปะฐะณะฐ. ะัะปะธ LLM ะฒะตัะฝัะป JSON ั `{"silent": true}` โ Engine ะปะพะณะธััะตั ัะตะทัะปััะฐั ะฒ scheduler-JSONL (ะตัะปะธ ะฒะบะปััะตะฝ), ะฝะพ ะฝะต ะพัะฟัะฐะฒะปัะตั ะฒ Gateway. ะัะปะธ ะพัะฒะตั ะฝะต ัะพะดะตัะถะธั `silent: true` (ะพะฑััะฝัะน ัะตะบัั ะธะปะธ JSON ะฑะตะท ััะพะณะพ ัะปะฐะณะฐ) ะธ `injectInto != null` โ Engine ะพัะฟัะฐะฒะปัะตั ะฒ Gateway ะบะฐะบ `type: "outbound"` ะดะปั ะดะพััะฐะฒะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

ะัะปะธ `inject_into` = null โ ัะตะทัะปััะฐั ะปะพะณะธััะตััั ะฒ JSONL scheduler-ะบะฐะฝะฐะปะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ), ะฒ Gateway ะฝะต ะพัะฟัะฐะฒะปัะตััั.

**ะัะธะผะตั ะทะฐะดะฐั** (ััะฐะฝัััั ะฒ Quartz JDBC JobStore `scheduler.db`):

```
name                cron                    message                              model              inject_into
daily-summary       0 0 9 * * ?             ะกะดะตะปะฐะน ัะฐะผะผะฐัะธ ะฒัะตัะฐัะฝะธั ัะพะฑััะธะน     glm/glm-4-plus     telegram_123456
health-check        0 */30 * * * ?          ะัะพะฒะตัั ััะฐััั ัะตัะฒะธัะพะฒ              glm/glm-4-plus     null
memory-compaction   0 0 3 * * ?             summarize_old_messages               ollama/qwen3:8b    null
```

ะัะธะผะตัะฐะฝะธะต: cron ะฒ ัะพัะผะฐัะต Quartz (7 ะฟะพะปะตะน: ัะตะบัะฝะดั ะผะธะฝััั ัะฐัั ะดะตะฝั ะผะตััั ะดะตะฝั_ะฝะตะดะตะปะธ [ะณะพะด]).

ะะฐะดะฐัะธ ะดะพะฑะฐะฒะปััััั ัะตัะตะท: tool `schedule_add` (LLM), CLI `klaw schedule add`, ะธะผะฟะพัั HEARTBEAT.md.

**ะะพะฝะบััะตะฝัะฝัะน ะดะพัััะฟ ะบ ะฟะฐะผััะธ**:

| ะะฟะตัะฐัะธั | ะัะฝะพะฒะฝะฐั ัะตััะธั | ะกัะฑะฐะณะตะฝั | ะะพะฝัะปะธะบั? |
|----------|----------------|----------|-----------|
| ะงัะตะฝะธะต core memory | โ | โ | ะะตั โ ะพะฑะฐ ัะธัะฐัั |
| ะะฐะฟะธัั core memory | โ (tool call) | โ (read-only) | ะะตั |
| ะงัะตะฝะธะต archival (sqlite-vec) | โ | โ | ะะตั โ Engine ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั |
| ะะฐะฟะธัั archival | โ | โ | ะะตั โ Engine ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั, ะฒะฝัััะตะฝะฝัั ัะตัะธะฐะปะธะทะฐัะธั |
| ะงัะตะฝะธะต conversation log | ะกะฒะพั ัะตััะธั | ะกะฒะพั ัะตััะธั | ะะตั โ ัะฐะทะฝัะต chat_id |

Engine โ ะตะดะธะฝััะฒะตะฝะฝัะน ะฟัะพัะตัั ัะฐะฑะพัะฐััะธะน ั `klaw.db`. ะะพะฝะบััะตะฝัะฝะพััั ะผะตะถะดั ะบะพัััะธะฝะฐะผะธ ัะฟัะฐะฒะปัะตััั ะฒะฝัััะธ Engine (Kotlin coroutines + dispatcher).

**ะะธะทะฝะตะฝะฝัะน ัะธะบะป ััะฑะฐะณะตะฝัะฐ** โ ััะพ ะฟะพะปะฝะพัะตะฝะฝัะน ะฐะณะตะฝัะฝัะน ัะธะบะป, ะธะดะตะฝัะธัะฝัะน ะพะฑัะฐะฑะพัะบะต ะธะฝัะตัะฐะบัะธะฒะฝะพะณะพ ัะพะพะฑัะตะฝะธั, ะฝะพ ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะผ ะบะพะฝัะตะบััะต ะฝะฐ ะพัะดะตะปัะฝะพะน ะบะพัััะธะฝะต:

```
Quartz fires "daily-summary"
  โ Scheduler (in-process) ะฒัะทัะฒะฐะตั engine.handleScheduledMessage():
    ScheduledMessage(name="daily-summary", message="ะกะดะตะปะฐะน ัะฐะผะผะฐัะธ...", model="glm/glm-4-plus", injectInto="telegram_123456")
  โ Engine ัะฟะฐะฒะฝะธั ะบะพัััะธะฝั:
  
    ะกัะฑะฐะณะตะฝั "daily-summary" (ะพัะดะตะปัะฝะฐั ะบะพัััะธะฝะฐ):
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 1. ะกะพะฑัะฐัั ะกะะะ ะบะพะฝัะตะบัั:                                   โ
    โ    - System prompt (SOUL.md, AGENTS.md โ ะพะฑัะธะน)              โ
    โ    - Core memory (ะพะฑัะฐั, read-only)                         โ
    โ    - ะะพัะปะตะดะฝะธะต 5 ัะพะพะฑัะตะฝะธะน ะะ ะกะะะะะ ะปะพะณะฐ                    โ
    โ      (conversations/scheduler_daily-summary/*.jsonl)         โ
    โ    - Tools/Skills (ะพะฑัะธะต, ะฒะบะปััะฐั memory_search)             โ
    โ                                                              โ
    โ 2. ะัะทะฒะฐัั LLM (ะผะพะดะตะปั ะธะท ะทะฐะดะฐัะธ: glm/glm-4-plus)          โ
    โ                                                              โ
    โ 3. ะัะปะธ LLM ะฒะตัะฝัะป tool_call โ ะฒัะฟะพะปะฝะธัั โ ะดะพะฑะฐะฒะธัั ะฒ       โ
    โ    ะบะพะฝัะตะบัั โ ะฒะตัะฝััััั ะบ ัะฐะณั 2 (ะฟะพะปะฝัะน tool call loop)     โ
    โ                                                              โ
    โ 4. ะะพะปััะธัั ัะธะฝะฐะปัะฝัะน ะพัะฒะตั ะพั LLM                           โ
    โ                                                              โ
    โ 5. ะะฐะฟะธัะฐัั ะฒัั (ะทะฐะฟัะพั + ะพัะฒะตั + tool calls) ะฒ ะกะะะ JSONL   โ
    โ    (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะตัะปะธ logging.subagentConversations: true)   โ
    โ                                                              โ
    โ 6. ะัะปะธ injectInto != null:                                  โ
    โ    โ ะัะพะฒะตัะธัั ะพัะฒะตั ะฝะฐ silent: JSON {"silent": true} โ ะฟัะพะฟัััะธััโ
    โ    โ ะัะปะธ ะฝะต silent โ ะพัะฟัะฐะฒะธัั ะฒ Gateway socket ะบะฐะบ outbound โ
    โ    โ Gateway: ะทะฐะฟะธัะฐัั ะฒ JSONL ัะตะปะตะฒะพะณะพ chat_id               โ
    โ    โ ะัะธ ัะปะตะดัััะตะผ ะฒัะทะพะฒะต ะพัะฝะพะฒะฝะพะน ัะตััะธะธ telegram_123456     โ
    โ      ัะตะทัะปััะฐั ะฟะพัะฒะธััั ะฒ sliding window ะบะฐะบ ะพะฑััะฝะพะต ัะพะพะฑัะตะฝะธะตโ
    โ                                                              โ
    โ 7. ะะพัััะธะฝะฐ ะทะฐะฒะตััะฐะตััั. ะะพะฝัะตะบัั ะพัะฒะพะฑะพะถะดะฐะตััั.             โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    ะะฐัะฐะปะปะตะปัะฝะพ ะพัะฝะพะฒะฝะฐั ัะตััะธั ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั ะบะฐะบ ะพะฑััะฝะพ.
    ะกัะฑะฐะณะตะฝั ะะะะะ ะฝะต ะฑะปะพะบะธััะตั ะธะฝัะตัะฐะบัะธะฒะฝัะน ัะฐั.
```

---

## 3. ะฃะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะตะบััะพะผ ะธ ะฟะฐะผัััั

### 3.1. ะัะธะฝัะธะฟ: ัะตััะธั โ ะธััะพัะธั ัะพะพะฑัะตะฝะธะน

ะ OpenClaw ัะตััะธั โ ััะพ ะธ ะบะพะฝัะตะบััะฝะพะต ะพะบะฝะพ, ะธ ะธััะพัะธั, ะธ ัะพััะพัะฝะธะต cron. ะััะฐัะธั ะพะดะฝะพะณะพ ะปะพะผะฐะตั ะพััะฐะปัะฝะพะต.

ะฃ ะฝะฐั ััะธ ะพัะดะตะปัะฝัั ัะปะพั:

| ะกะปะพะน | ะฅัะฐะฝะตะฝะธะต | ะััะฐะฑะตะปัะฝะพััั | ะะฐะทะฝะฐัะตะฝะธะต |
|------|----------|---------------|------------|
| **Conversation Log** | JSONL ัะฐะนะปั (source of truth) + `klaw.db` messages (ะธะฝะดะตะบั) | Append-only, ะธะผะผััะฐะฑะตะปัะฝัะน | ะะพะปะฝะฐั ะธััะพัะธั ะฒัะตั ัะพะพะฑัะตะฝะธะน |
| **LLM Context Window** | ะกะพะฑะธัะฐะตััั ะฝะฐ ะปะตัั | ะญัะตะผะตัะฝัะน, ะฟะตัะตัะพะฑะธัะฐะตััั ะบะฐะถะดัะน ะฒัะทะพะฒ | ะขะพ, ััะพ ัะตะฐะปัะฝะพ ััะพะดะธั ะฒ LLM |
| **Long-term Memory** | sqlite-vec + core_memory.json + JSONL | Append-only + self-edit | ะกะตะผะฐะฝัะธัะตัะบะฐั ะฟะฐะผััั ะฐะณะตะฝัะฐ |

### 3.2. ะะพะดะตะปั ะดะฐะฝะฝัั: chat โ segment โ session

```
channel (telegram, discord, scheduler)
  โโโ chat_id (123456)              โ conversation log (JSONL ัะฐะนะป ะฟะพ ะดะฝัะผ)
        โ                              ะพะดะธะฝ ัะฐั = ะพะดะธะฝ ะฝะตะฟัะตััะฒะฝัะน ะปะพะณ
        โโโ segment_0               โ ัะพะพะฑัะตะฝะธั ะพั ะฝะฐัะฐะปะฐ
        โโโ [session_break]         โ ะผะฐัะบะตั /new
        โโโ segment_1               โ ัะพะพะฑัะตะฝะธั ะฟะพัะปะต ะฟะตัะฒะพะณะพ /new
        โโโ [session_break]
        โโโ segment_2 (ัะตะบััะธะน)     โ sliding window ัะธัะฐะตั ัะพะปัะบะพ ะพัััะดะฐ
```

| ะะพะฝััะธะต | ะัะธะฒัะทะบะฐ | ะะธะทะฝะตะฝะฝัะน ัะธะบะป | ะฅัะฐะฝะตะฝะธะต |
|---------|----------|----------------|----------|
| **Chat** | `chat_id` (ะพะดะธะฝ Telegram-ัะฐั) | ะะตัััะพัะฝัะน | JSONL: `conversations/{chat_id}/YYYY-MM-DD.jsonl` + `klaw.db` messages |
| **Segment** | ะงะฐััั chat ะผะตะถะดั ะผะฐัะบะตัะฐะผะธ `[session_break]` | ะั `/new` ะดะพ `/new` | ะะฐัะบะตัั ะฒ JSONL ะธ `klaw.db` |
| **Session** | chat_id + ัะตะบััะธะน segment + runtime state | ะะพะบะฐ engine ัะฐะฑะพัะฐะตั | ะขะฐะฑะปะธัะฐ `sessions` ะฒ `klaw.db` |

Session โ ััะพ runtime-ัะพััะพัะฝะธะต, ะฟัะธะฒัะทะฐะฝะฝะพะต ะบ chat_id. ะฅัะฐะฝะธััั ะฒ `klaw.db` (ัะฐะฑะปะธัะฐ `sessions`), ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท JSONL ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ (ะผะพะดะตะปั ะฑะตััััั ะธะท `routing.default`, `segmentStart` ะฒััะธัะปัะตััั ะฟะพ ะฟะพัะปะตะดะฝะตะผั `session_break`).

```sql
-- ะ klaw.db (Engine โ ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั)
CREATE TABLE sessions (
    chat_id TEXT PRIMARY KEY,
    model TEXT NOT NULL,              -- "glm/glm-5"
    segment_start TEXT NOT NULL,      -- id ะฟะตัะฒะพะณะพ ัะพะพะฑัะตะฝะธั ัะตะบััะตะณะพ ัะตะณะผะตะฝัะฐ
    created_at TIMESTAMP NOT NULL
);
```

**ะงัะพ ะฟัะธะฒัะทะฐะฝะพ ะบ chat_id (ะฟะตัะตะถะธะฒะฐะตั `/new`):**
- Conversation log (JSONL ัะฐะนะปั โ append-only, ะฒัั ััะฐะฝะธััั)
- ะขะตะบััะฐั ะผะพะดะตะปั (`session.model`)
- Core memory (ะพะฑัะฐั ะดะปั ะฒัะตั ัะฐัะพะฒ โ ััะพ ะฟะฐะผััั ะฐะณะตะฝัะฐ, ะฝะต ัะตััะธะธ)
- Archival memory (ะพะฑัะฐั โ sqlite-vec)

**ะงัะพ ะฟัะธะฒัะทะฐะฝะพ ะบ segment (ัะฑัะฐััะฒะฐะตััั ะฟัะธ `/new`):**
- Sliding window (ะฟะพัะปะตะดะฝะธะต N ัะพะพะฑัะตะฝะธะน โ ัะพะปัะบะพ ะธะท ัะตะบััะตะณะพ ัะตะณะผะตะฝัะฐ)
- Last summary (ัะฐะผะผะฐัะธ ะฟัะตะดัะดััะธั ัะพะพะฑัะตะฝะธะน ัะตะบััะตะณะพ ัะตะณะผะตะฝัะฐ)

**`/new` ะทะฐะฟะธััะฒะฐะตั ะผะฐัะบะตั ะธ ัะดะฒะธะณะฐะตั offset:**

```json
{"id":"msg_041","ts":"...","role":"system","type":"session_break","meta":{"reason":"user_reset"}}
```

Engine ะฟัะธ ัะฑะพัะบะต sliding window ัะธัะฐะตั ะธะท `klaw.db` (ัะฐะฑะปะธัะฐ `messages`) ะพั ะบะพะฝัะฐ ะธ ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั ะฝะฐ ะฟะตัะฒะพะผ `session_break`. ะกะฐะผะผะฐัะธ ัะตะบััะตะณะพ ัะตะณะผะตะฝัะฐ โ ัะพะปัะบะพ ะธะท ัะพะพะฑัะตะฝะธะน ะฟะพัะปะต ะผะฐัะบะตัะฐ.

**ะะพะปะฝะฐั ัะตะฟะพัะบะฐ: ะพั ะฒัะพะดััะตะณะพ ัะพะพะฑัะตะฝะธั ะดะพ LLM-ะฒัะทะพะฒะฐ**

```
Telegram ัะพะพะฑัะตะฝะธะต ะพั ะฟะพะปัะทะพะฒะฐัะตะปั
  โ
  โผ
Gateway ะฝะพัะผะฐะปะธะทัะตั, ะทะฐะฟะธััะฒะฐะตั ะฒ JSONL, ะพัะฟัะฐะฒะปัะตั ะฒ Engine socket
  โ
  โผ
Engine ะฟะพะปััะฐะตั ัะพะพะฑัะตะฝะธะต ัะตัะตะท socket
  โ  ะะฐะฟะธััะฒะฐะตั ะฒ klaw.db (ัะฐะฑะปะธัะฐ messages)
  โผ
chat_id = "{channel}_{platform_id}"        # "telegram_123456"
  โ
  โผ
Session = sessions.get(chat_id)
  โ  ะะตั ัะตััะธะธ? โ ัะพะทะดะฐัั ั model=routing.default, segment_start=ัะตะบััะธะน msg
  โ  ะััั? โ ะฒะทััั model ะธ segment_start ะธะท ัะฐะฑะปะธัั sessions
  โผ
model = session.model                      # "glm/glm-5"
  โ
  โผ
contextBudget = models[model].contextBudget  # 12000 ัะพะบะตะฝะพะฒ
  โ  ะะฟัะตะดะตะปัะตั ัะบะพะปัะบะพ ัะพะบะตะฝะพะฒ ะพัะดะฐัั ะฟะพะด ะบะพะฝัะตะบัั
  โผ
ะกะฑะพัะบะฐ ะบะพะฝัะตะบััะฐ (ัะผ. 3.3):
  system prompt + core memory + summary     โ 1500 ัะพะบะตะฝะพะฒ (ัะธะบัะธัะพะฒะฐะฝะพ)
  tools/skills descriptions                 โ 500 ัะพะบะตะฝะพะฒ (ัะธะบัะธัะพะฒะฐะฝะพ)
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  ะพััะฐัะพะบ = contextBudget - ัะธะบัะธัะพะฒะฐะฝะฝัะต   โ 10000 ัะพะบะตะฝะพะฒ
  โ
  โผ
slidingWindow = min(context.slidingWindow, ะฟะพะดะพะณะฝะฐะฝะพ ะฟะพะด ะพััะฐัะพะบ)
  โ  ะงะธัะฐะตั ะฟะพัะปะตะดะฝะธะต N ัะพะพะฑัะตะฝะธะน ะธะท klaw.db (ัะฐะฑะปะธัะฐ messages)
  โ  ะณะดะต chat_id = ัะตะบััะธะน ะธ created_at >= segment_start
  โผ
LLM ะฒัะทะพะฒ: router.chat(request, model)
  โ  Router: model โ provider โ client โ fallback chain
  โผ
ะัะฒะตั โ ะพัะฟัะฐะฒะธัั ัะตัะตะท Gateway socket
```

### 3.3. ะกะฑะพัะบะฐ ะบะพะฝัะตะบััะฝะพะณะพ ะพะบะฝะฐ

ะะตัะตะด ะบะฐะถะดัะผ ะฒัะทะพะฒะพะผ LLM engine ัะพะฑะธัะฐะตั ะบะพะฝัะตะบัั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. System prompt                    (~500 tokens)โ
โ    - ะะตััะพะฝะฐ ะฐะณะตะฝัะฐ (ะธะท SOUL.md, IDENTITY.md)    โ
โ    - ะะฝััััะบัะธะธ (ะธะท AGENTS.md)                   โ
โ    - ะขะตะบััะฐั ะดะฐัะฐ/ะฒัะตะผั                          โ
โ    - ะะฝััััะบัะธั: "ะัะฟะพะปัะทัะน memory_search ะดะปั    โ
โ      ะดะพัััะฟะฐ ะบ ะดะพะปะณะพััะพัะฝะพะน ะฟะฐะผััะธ"              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 2. Core Memory (core_memory.json)   (~500 tokens)โ
โ    - ะคะฐะบัั ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต (ะธะท USER.md)           โ
โ    - ะะฐััะตะฝะฝัะต ะฟัะฐะฒะธะปะฐ                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 3. ะะพัะปะตะดะฝะตะต ัะฐะผะผะฐัะธ                (~500 tokens)โ
โ    - "ะะฐะฝะตะต ะฒ ััะพะผ ัะฐะทะณะพะฒะพัะต: ..."               โ
โ    - ะะตะฝะตัะธััะตััั ัะพะฝะพะฒะพะน ะทะฐะดะฐัะตะน                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 4. ะะพัะปะตะดะฝะธะต N ัะพะพะฑัะตะฝะธะน           (~3000 tokens)โ
โ    - ะะท klaw.db (ัะฐะฑะปะธัะฐ messages)               โ
โ    - N โ min(slidingWindow, ะพััะฐะฒัะธะนัั ะฑัะดะถะตั)   โ
โ    - ะขะพะปัะบะพ ะธะท ัะตะบััะตะณะพ ัะตะณะผะตะฝัะฐ (ะฟะพัะปะต /new)    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 5. ะะพัััะฟะฝัะต tools/skills           (~500 tokens)โ
โ    - ะะฟะธัะฐะฝะธั ะฒ ัะพัะผะฐัะต function calling          โ
โ    - ะะบะปััะฐะตั memory_search ะดะปั on-demand ะฟะพะธัะบะฐ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    ะัะพะณะพ: ~5000 tokens
```

**ะััะธะฒะฝะฐั ะฟะฐะผััั โ on-demand ัะตัะตะท tool call.** ะ ะพัะปะธัะธะต ะพั ะฟะพััะพัะฝะฝะพะน ะทะฐะณััะทะบะธ ัะตะทัะปััะฐัะพะฒ ะฐััะธะฒะฝะพะณะพ ะฟะพะธัะบะฐ ะฒ ะบะพะฝัะตะบัั (~1000 ัะพะบะตะฝะพะฒ ะฟัะธ ะบะฐะถะดะพะผ ะฒัะทะพะฒะต), LLM ัะฐะผ ัะตัะฐะตั, ะบะพะณะดะฐ ะตะผั ะฝัะถะฝะฐ ะดะพะปะณะพััะพัะฝะฐั ะฟะฐะผััั, ะธ ะฒัะทัะฒะฐะตั tool `memory_search`. ะะตะทัะปััะฐั ะฟัะธัะพะดะธั ะบะฐะบ tool result ะธ ะดะพะฑะฐะฒะปัะตััั ะฒ ะบะพะฝัะตะบัั ัะตะบััะตะณะพ ะฒัะทะพะฒะฐ.

ะัะธะณััั ะดะฒะพะนะฝะพะน:
- **ะะตะฝััะต ััะผะฐ ะฒ ะบะพะฝัะตะบััะต**: "ะฟัะธะฒะตั, ะบะฐะบ ะดะตะปะฐ?" ะฝะต ััะฐัะธั 1000 ัะพะบะตะฝะพะฒ ะฝะฐ ะฝะตัะตะปะตะฒะฐะฝัะฝัะต ะฐััะธะฒะฝัะต ัะตะทัะปััะฐัั
- **ะะพะปััะต ะผะตััะฐ ะดะปั sliding window**: +1000 ัะพะบะตะฝะพะฒ โ ะฑะพะปััะต ะฝะตะดะฐะฒะฝะธั ัะพะพะฑัะตะฝะธะน ะฒ ะบะพะฝัะตะบััะต

ะะฝััััะบัะธั ะดะปั LLM ะพะฟะธััะฒะฐะตััั ะฒ AGENTS.md workspace'ะฐ: *"ะขั ะธะผะตะตัั ะดะพัััะฟ ะบ ะดะพะปะณะพััะพัะฝะพะน ะฟะฐะผััะธ ัะตัะตะท memory_search. ะัะฟะพะปัะทัะน ะบะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ัััะปะฐะตััั ะฝะฐ ะฟัะพัะปัะต ัะฐะทะณะพะฒะพัั, ะฟัะพัะธั ะฒัะฟะพะผะฝะธัั ััะพ-ัะพ, ะธะปะธ ะบะพะณะดะฐ ะบะพะฝัะตะบัั ะฒ ัะบะพะปัะทััะตะผ ะพะบะฝะต ะฝะตะดะพััะฐัะพัะตะฝ."*

**ะะธะบะฐะบะพะน ะบะพะผะฟะฐะบัะธะธ.** ะะพะฝัะตะบัั ะฝะต ะผััะธััะตััั โ ะพะฝ ะฟะตัะตัะพะฑะธัะฐะตััั ะบะฐะถะดัะน ัะฐะท. Conversation log ัะฐัััั ะฑะตัะบะพะฝะตัะฝะพ (append-only JSONL). ะกัะฐััะต ัะพะพะฑัะตะฝะธั ะฝะต ัะดะฐะปััััั, ะฐ ยซะฟะพะบะธะดะฐััยป ัะบะพะปัะทััะตะต ะพะบะฝะพ.

**ะะพะดัััั ัะพะบะตะฝะพะฒ**: ัะพัะฝัะน ะฟะพะดัััั ะทะฐะฒะธัะธั ะพั ัะพะบะตะฝะธะทะฐัะพัะฐ ะผะพะดะตะปะธ (tiktoken ะดะปั OpenAI-compatible, sentencepiece ะดะปั ะดััะณะธั). ะะปั MVP โ ะฟัะธะฑะปะธะถัะฝะฝัะน ะฟะพะดัััั: `ะดะปะธะฝะฐ_ัะตะบััะฐ / 3.5` ะดะปั ะฐะฝะณะปะธะนัะบะพะณะพ, `ะดะปะธะฝะฐ_ัะตะบััะฐ / 2` ะดะปั ััััะบะพะณะพ/ะบะธัะฐะนัะบะพะณะพ. ะญัะพ ะดะฐัั ยฑ15% ัะพัะฝะพััะธ. **โ๏ธ Tech debt**: ยฑ15% ะพะทะฝะฐัะฐะตั, ััะพ ~15% ะฒัะทะพะฒะพะฒ ะผะพะณัั ะพะฑัะตะทะฐัั ะฝัะถะฝัะน ะบะพะฝัะตะบัั (ะฝะตะดะพะพัะตะฝะบะฐ) ะธะปะธ ะฟัะธะฑะปะธะทะธัััั ะบ ะปะธะผะธัั ะผะพะดะตะปะธ (ะฟะตัะตะพัะตะฝะบะฐ). ะะธัะธะณะฐัะธั ะดะปั MVP: ะทะฐะบะปะฐะดัะฒะฐัั 10% safety margin ะฒ contextBudget (ั.ะต. ัะตะฐะปัะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั 90% ะพั ะทะฐัะฒะปะตะฝะฝะพะณะพ ะฑัะดะถะตัะฐ). ะขะพัะฝัะน ะฟะพะดัััั ัะตัะตะท HuggingFace Tokenizer (ัะถะต ะฒ ะทะฐะฒะธัะธะผะพัััั engine ะดะปั ONNX) โ Post-MVP ะพะฟัะธะผะธะทะฐัะธั.

### 3.4. ะคะพะฝะพะฒะฐั ััะผะผะฐัะธะทะฐัะธั

ะะผะตััะพ ะบะพะผะฟะฐะบัะธะธ OpenClaw (ะณะดะต LLM ัะถะธะผะฐะตั ะธััะพัะธั ะธ ัะตััะตั ะดะตัะฐะปะธ):

1. Scheduler ะบะฐะถะดัะต 50 ัะพะพะฑัะตะฝะธะน (ะธะปะธ ะฟะพ cron) ะณะตะฝะตัะธััะตั ะทะฐะดะฐัั `summarize_old_messages`
2. Engine ะฑะตััั ะฑะปะพะบ ััะฐััั ัะพะพะฑัะตะฝะธะน, ะตัั ะฝะต ะฟะพะบััััั ัะฐะผะผะฐัะธ
3. ะัะทัะฒะฐะตั LLM (ะผะพะถะฝะพ ะดะตััะฒัั ะผะพะดะตะปั) ะดะปั ัะพะทะดะฐะฝะธั ะบัะฐัะบะพะณะพ ัะฐะผะผะฐัะธ
4. ะกะฐะผะผะฐัะธ ัะพััะฐะฝัะตััั ะบะฐะบ Markdown-ัะฐะนะป ะธ ะธะฝะดะตะบัะธััะตััั ะฒ sqlite-vec
5. ะัะธะณะธะฝะฐะปัะฝัะต ัะพะพะฑัะตะฝะธั **ะพััะฐัััั ะฒ ะปะพะณะต ะฝะฐะฒัะตะณะดะฐ**

```
data/summaries/telegram_123456/
  2026-02-24_msg_001_050.md
  2026-02-24_msg_051_100.md
```

### 3.5. ะะฐะผััั: sqlite-vec + ะปะพะบะฐะปัะฝะฐั embedding-ะผะพะดะตะปั

ะะผะตััะพ ะฒะฝะตัะฝะตะณะพ ัะตัะฒะธัะฐ (Letta) โ ะฟะพะปะฝะพัััั ะฐะฒัะพะฝะพะผะฝะฐั ัะธััะตะผะฐ ะฟะฐะผััะธ ะฒะฝัััะธ engine.

**Embedding-ะผะพะดะตะปั**: `all-MiniLM-L6-v2` ัะตัะตะท ONNX Runtime ะฝะฐ JVM. ะะพะดะตะปั ะฒะตัะธั ~80MB, ะณะตะฝะตัะธััะตั 384-ะผะตัะฝัะต ะฒะตะบัะพัะฐ, ัะฐะฑะพัะฐะตั ะฝะฐ ARM64 ะฑะตะท GPU. ะะฝัะตัะตะฝั ะพะดะฝะพะณะพ ะฟัะตะดะปะพะถะตะฝะธั ~5โ15ms ะฝะฐ Pi 5.

```kotlin
// Engine (JVM-only) โ ONNX Runtime + DJL HuggingFace Tokenizer
val env = OrtEnvironment.getEnvironment()
val session = env.createSession("models/all-MiniLM-L6-v2/model.onnx")
val tokenizer = HuggingFaceTokenizer.newInstance("models/all-MiniLM-L6-v2/tokenizer.json")

fun embed(text: String): FloatArray {
    val encoding = tokenizer.encode(text)
    // ... tokenize โ run ONNX โ mean pooling โ L2 normalize
    return normalized384dVector
}
```

**ะะปััะตัะฝะฐัะธะฒะฐ (ะฟัะพัะต)**: Ollama ะบะฐะบ embedding-ัะตัะฒะตั โ `ollama pull all-minilm:l6-v2`, ะฒัะทะพะฒ ัะตัะตะท HTTP `POST /api/embed`. ะะปัั: ะฝัะปะตะฒะพะน ะบะพะด ะดะปั ะธะฝัะตัะตะฝัะฐ. ะะธะฝัั: ะตัั ะพะดะฝะฐ ะทะฐะฒะธัะธะผะพััั.

**ะะตะบัะพัะฝัะน ะฟะพะธัะบ**: `sqlite-vec` โ ัะฐััะธัะตะฝะธะต SQLite ะฝะฐ ัะธััะพะผ C, ะฑะตะท ะทะฐะฒะธัะธะผะพััะตะน, ัะฐะฑะพัะฐะตั ะฝะฐ Pi/ARM/WASM. ะะฐัะปะตะดะฝะธะบ sqlite-vss (ะบะพัะพััะน ะทะฐะฑัะพัะตะฝ). Brute-force KNN, ะฝะพ ะดะปั ะผะฐัััะฐะฑะพะฒ ะฟะตััะพะฝะฐะปัะฝะพะณะพ ะฐะณะตะฝัะฐ (ะดะตัััะบะธ ััััั ัะฐะฝะบะพะฒ) โ ะดะพััะฐัะพัะฝะพ ะฑััััะพ (~60ms ะฝะฐ 100k ะทะฐะฟะธัะตะน 384d).

```sql
-- ะ klaw.db โ ะฒะตะบัะพัะฝัะน ะธะฝะดะตะบั ะดะปั ะฐััะธะฒะฝะพะน ะฟะฐะผััะธ
CREATE VIRTUAL TABLE vec_memory USING vec0(
    embedding float[384]
);

-- ะะตัะฐะดะฐะฝะฝัะต ัะฐะฝะบะพะฒ
CREATE TABLE memory_chunks (
    id INTEGER PRIMARY KEY,
    source TEXT NOT NULL,       -- 'MEMORY.md', 'memory/2026-02-24.md', 'conversation'
    chat_id TEXT,               -- NULL ะดะปั workspace-ัะฐะนะปะพะฒ
    content TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

-- ะััะฐะฒะบะฐ
INSERT INTO memory_chunks(content, source, created_at) VALUES (?, ?, ?);
INSERT INTO vec_memory(rowid, embedding) VALUES (last_insert_rowid(), ?);

-- ะกะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ: top-K ะฑะปะธะถะฐะนัะธั
SELECT mc.content, mc.source, mc.created_at, vm.distance
FROM vec_memory vm
JOIN memory_chunks mc ON mc.id = vm.rowid
WHERE vm.embedding MATCH ?     -- query embedding
ORDER BY vm.distance
LIMIT 10;
```

**ะะธะฑัะธะดะฝัะน ะฟะพะธัะบ (vector + FTS5)**: ะดะปั ะปัััะตะณะพ recall โ ะบะพะผะฑะธะฝะธััะตะผ ัะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ ั ะฟะพะปะฝะพัะตะบััะพะฒัะผ, ัะฐะฝะถะธััะตะผ ัะตัะตะท Reciprocal Rank Fusion (k=60):

```kotlin
fun hybridSearch(query: String, topK: Int = 10): List<MemoryChunk> {
    val queryEmbedding = embed(query)
    
    // 1. ะกะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ (sqlite-vec)
    val vectorResults = vectorSearch(queryEmbedding, topK = 20)
    
    // 2. ะะพะปะฝะพัะตะบััะพะฒัะน ะฟะพะธัะบ (FTS5)
    val ftsResults = ftsSearch(query, topK = 20)
    
    // 3. RRF: score = ฮฃ 1/(k + rank_i), k=60
    return reciprocalRankFusion(vectorResults, ftsResults, k = 60)
        .take(topK)
}
```

**ะขัััััะพะฒะฝะตะฒะฐั ะฟะฐะผััั (ะฐะฝะฐะปะพะณ Letta, ะฝะพ ัะฒะพั):**

| ะฃัะพะฒะตะฝั | ะฅัะฐะฝะตะฝะธะต | ะะฐะณััะทะบะฐ | ะะฑะฝะพะฒะปะตะฝะธะต |
|---------|----------|----------|------------|
| **Core Memory** | `core_memory.json` | ะะฐะถะดัะน ะฒัะทะพะฒ LLM โ ะฒ system prompt | LLM ะฒัะทัะฒะฐะตั tool `memory_core_update` |
| **Archival Memory** | `sqlite-vec` + `memory_chunks` ัะฐะฑะปะธัะฐ ะฒ `klaw.db` | ะะพ ะทะฐะฟัะพัั โ LLM ะฒัะทัะฒะฐะตั tool `memory_search` | LLM ะฒัะทัะฒะฐะตั tool `memory_save`, ัะพะฝะพะฒะฐั ะธะฝะดะตะบัะฐัะธั |
| **Recall Memory** | JSONL conversation log + ัะฐะฑะปะธัะฐ `messages` ะฒ `klaw.db` | ะกะบะพะปัะทััะตะต ะพะบะฝะพ ะฟะพัะปะตะดะฝะธั N ัะพะพะฑัะตะฝะธะน | Append-only, ะฐะฒัะพะผะฐัะธัะตัะบะธ |

**Core Memory** โ JSON-ัะฐะนะป ั ััััะบัััะธัะพะฒะฐะฝะฝัะผะธ ัะฐะบัะฐะผะธ ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต ะธ ะฐะณะตะฝัะต. ะัะตะณะดะฐ ะฒ ะบะพะฝัะตะบััะต LLM. ะะณะตะฝั ะผะพะถะตั ะพะฑะฝะพะฒะปััั ัะตัะตะท tool call:

```json
{
  "user": {
    "name": "Roman",
    "location": "Prague, CZ",
    "occupation": "KMP developer, sports trainer",
    "preferences": "ะัะฒะตัะฐะน ะฝะฐ ััััะบะพะผ. ะะตะท ะปะธัะฝะตะน ะฒะพะดั.",
    "current_projects": ["trainer app MVP", "Docker on RPi5"]
  },
  "agent": {
    "personality_notes": "User prefers structured, technical answers",
    "learned_rules": ["Don't suggest Spring Boot", "RPi5 has 16GB RAM"]
  }
}
```

**ะััะธะฒะฝะฐั ะฟะฐะผััั** โ ัะฐะฝะบะธ ะฟะพ ~400 ัะพะบะตะฝะพะฒ ะธะท MEMORY.md, daily logs, ัะฐะทะณะพะฒะพัะพะฒ. ะะฝะดะตะบัะธัััััั ะฒ sqlite-vec ะฟัะธ ะทะฐะฟะธัะธ. LLM ะทะฐะฟัะฐัะธะฒะฐะตั ะธั on-demand ัะตัะตะท tool `memory_search`.

**ะงะฐะฝะบะธะฝะณ**: ~400 ัะพะบะตะฝะพะฒ ั 80-ัะพะบะตะฝะฝัะผ ะฟะตัะตะบัััะธะตะผ (ะบะฐะบ ั OpenClaw). Markdown-aware: ะฝะต ะปะพะผะฐะตะผ ะทะฐะณะพะปะพะฒะบะธ, ัะฟะธัะบะธ, ะฑะปะพะบะธ ะบะพะดะฐ.

**ะะฐะฒะธัะธะผะพััะธ (engine, JVM-only):**

```kotlin
// engine/build.gradle.kts
implementation("com.microsoft.onnxruntime:onnxruntime:1.17.0")  // ONNX Runtime (ARM64 ะฟะพะดะดะตัะถะบะฐ)
implementation("ai.djl.huggingface:tokenizers:0.30.0")           // HF Tokenizer ะดะปั JVM
// sqlite-vec ะทะฐะณััะถะฐะตััั ะบะฐะบ native ัะฐััะธัะตะฝะธะต ะฟัะธ ะพัะบัััะธะธ SQLite
```

**ะะพััะตะฑะปะตะฝะธะต ัะตััััะพะฒ ะฝะฐ Pi 5:**

| ะะพะผะฟะพะฝะตะฝั | RAM | ะะธัะบ |
|-----------|-----|------|
| ONNX Runtime + ะผะพะดะตะปั | ~150MB | ~80MB |
| sqlite-vec ะธะฝะดะตะบั (10k ัะฐะฝะบะพะฒ) | ~15MB | ~6MB |
| FTS5 ะธะฝะดะตะบั | ~5MB | ~3MB |
| **ะัะพะณะพ** | **~170MB** | **~89MB** |

---

## 4. ะกะพะฒะผะตััะธะผะพััั ั OpenClaw workspace

### 4.1. ะัะธะฝัะธะฟ

Klaw ัะธัะฐะตั ะธ ะธัะฟะพะปัะทัะตั ััะฐะฝะดะฐััะฝัะต workspace-ัะฐะนะปั OpenClaw ะฑะตะท ะผะพะดะธัะธะบะฐัะธะธ. ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะฒะทััั ัััะตััะฒัััะธะน `~/.openclaw/workspace/` ะธ ัะบะฐะทะฐัั ะตะณะพ ะบะฐะบ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั โ ะฐะณะตะฝั ะฟะพะดัะฒะฐัะธั ะฟะตััะพะฝั, ะฟะฐะผััั ะธ ะฝะฐัััะพะนะบะธ. ะญัะพ ะพะฑะตัะฟะตัะธะฒะฐะตั ะฑะตะทะฑะพะปะตะทะฝะตะฝะฝัั ะผะธะณัะฐัะธั ะธ ะพะฑัะฐัะฝัั ัะพะฒะผะตััะธะผะพััั ั ัะบะพัะธััะตะผะพะน OpenClaw (ัะฐะฑะปะพะฝั SOUL.md, community skills ะธ ั.ะด.).

### 4.2. ะะฐะฟะฟะธะฝะณ ัะฐะนะปะพะฒ OpenClaw โ Klaw

```
OpenClaw workspace:                    ะะฐะบ ะธัะฟะพะปัะทัะตััั ะฒ Klaw:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
AGENTS.md          (ะธะฝััััะบัะธะธ)     โ System prompt: ะพัะฝะพะฒะฝะพะน ะฑะปะพะบ ะธะฝััััะบัะธะน
SOUL.md            (ะปะธัะฝะพััั)       โ System prompt: ะฑะปะพะบ ยซะบัะพ ััยป
IDENTITY.md        (ะฟัะตะทะตะฝัะฐัะธั)    โ System prompt: ะธะผั, ะฒะธะทัะฐะป, ัะพะฝ
USER.md            (ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต) โ Core memory: ะทะฐะณััะถะฐะตััั ะฒ core_memory.json
TOOLS.md           (ะทะฐะผะตัะบะธ ะพ ััะปะฐั)โ System prompt: ะบะพะฝัะตะบัั ะพะบััะถะตะฝะธั
MEMORY.md          (ะดะพะปะณะพััะพัะฝะฐั)   โ Archival memory: ัะฐะฝะบัะตััั ะธ ะธะฝะดะตะบัะธััะตััั ะฒ sqlite-vec
HEARTBEAT.md       (ัะตะบะปะธัั)        โ Scheduler: ะฟะฐััะธััั ะฒ ะทะฐะดะฐัะธ cron
BOOT.md            (ัะธััะฐะป ััะฐััะฐ)  โ Engine: ะฒัะฟะพะปะฝัะตััั ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต ัะตััะธะธ
BOOTSTRAP.md       (ะพะฝะฑะพัะดะธะฝะณ)      โ CLI: ะธะฝัะตัะฐะบัะธะฒะฝะพะต ัะพะทะดะฐะฝะธะต workspace
memory/YYYY-MM-DD.md (ะดะฝะตะฒะฝัะต ะปะพะณะธ) โ Archival memory: ัะฐะฝะบััััั ะธ ะธะฝะดะตะบัะธัััััั ะฒ sqlite-vec
skills/            (ะฝะฐะฒัะบะธ)         โ Skills: ัะธัะฐัััั SKILL.md, progressive disclosure
```

### 4.3. ะกะฑะพัะบะฐ system prompt ะธะท workspace-ัะฐะนะปะพะฒ

Engine ะฟัะธ ััะฐััะต ะธ ะฟะตัะตะด ะบะฐะถะดัะผ ะฒัะทะพะฒะพะผ LLM ัะพะฑะธัะฐะตั system prompt ะธะท ัะฐะนะปะพะฒ ะฒ ะพะฟัะตะดะตะปัะฝะฝะพะผ ะฟะพััะดะบะต. ะะพััะดะพะบ ัะพะพัะฒะตัััะฒัะตั ะฟัะธะพัะธัะตัะฐะผ OpenClaw (cascade resolution):

```kotlin
fun buildSystemPrompt(workspace: Path): String = buildString {
    // 1. SOUL.md โ ัะธะปะพัะพัะธั, ัะตะฝะฝะพััะธ, ัะฐัะฐะบัะตั
    appendFileIfExists(workspace / "SOUL.md", header = "## Soul")

    // 2. IDENTITY.md โ ะธะผั, ะฒะธะทัะฐะป, ัะพะฝ ะพะฑัะตะฝะธั
    appendFileIfExists(workspace / "IDENTITY.md", header = "## Identity")

    // 3. AGENTS.md โ ะพะฟะตัะฐัะธะพะฝะฝัะต ะธะฝััััะบัะธะธ, ะฟัะธะพัะธัะตัั, ะณัะฐะฝะธัั
    appendFileIfExists(workspace / "AGENTS.md", header = "## Instructions")

    // 4. TOOLS.md โ ะทะฐะผะตัะบะธ ะพะฑ ะพะบััะถะตะฝะธะธ, SSH-ัะพััั, API-ะบะฒะธัะบะธ
    appendFileIfExists(workspace / "TOOLS.md", header = "## Environment Notes")

    // 5. USER.md โ ะธะฝัะพัะผะฐัะธั ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต
    //    ะะบะปััะฐะตััั ะฒ system prompt ะดะปั OpenClaw-ัะพะฒะผะตััะธะผะพััะธ.
    //    core_memory.json โ superset USER.md (ัะพะดะตัะถะธั ัะต ะถะต ะดะฐะฝะฝัะต + ะดะพะฟะพะปะฝะตะฝะธั ะฐะณะตะฝัะฐ).
    //    ะัะฑะปะธัะพะฒะฐะฝะธะต ะฝะฐะผะตัะตะฝะฝะพะต: USER.md ะพััะฐัััั ะธััะพัะฝะธะบะพะผ ะดะปั OpenClaw-ัะบะพัะธััะตะผั,
    //    core_memory.json โ ัะฐะฑะพัะธะน ัะพัะผะฐั Klaw.
    //
    //    Source of truth: core_memory.json. ะัะธ ะบะพะฝัะปะธะบัะต core_memory.json ะฟัะธะพัะธัะตัะฝะตะต.
    //    ะะฑัะฐัะฝะฐั ะทะฐะฟะธัั ะฒ USER.md (ัะตะบัะธั 4.6) ะณะตะฝะตัะธััะตั Markdown ะธะท ัะตะบัะธะธ
    //    core_memory.json["user"], ัะพััะฐะฝัั ัะตะปะพะฒะตะบะพัะธัะฐะตะผัะน ัะพัะผะฐั OpenClaw.
    //    USER.md ะะ ัะธัะฐะตััั ะพะฑัะฐัะฝะพ ะฟะพัะปะต ะฟะตัะฒะพะณะพ ะธะผะฟะพััะฐ โ ัะพะปัะบะพ core_memory.json.
    appendFileIfExists(workspace / "USER.md", header = "## About the User")

    // 6. ะะธะฝะฐะผะธัะตัะบะธะน ะบะพะฝัะตะบัั (ะดะฐัะฐ, ะฒัะตะผั, ะฐะบัะธะฒะฝัะน ะบะฐะฝะฐะป)
    append("\n## Current Context\n")
    append("Date: ${LocalDate.now()}\n")
    append("Time: ${LocalTime.now()}\n")
}
```

### 4.4. ะะฐะฟะฟะธะฝะณ HEARTBEAT.md โ Scheduler

OpenClaw ะธัะฟะพะปัะทัะตั `HEARTBEAT.md` ะบะฐะบ ัะตะบะปะธัั, ะบะพัะพััะน ะฐะณะตะฝั ะฒัะฟะพะปะฝัะตั ะฟะตัะธะพะดะธัะตัะบะธ. ะ Klaw heartbeat โ ััะพ **ััะฑะฐะณะตะฝั** ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผ ะบะพะฝัะตะบััะพะผ:

```yaml
# ะะฒัะพะณะตะฝะตัะธััะตััั ะธะท HEARTBEAT.md ะฟัะธ ััะฐััะต
tasks:
  - name: heartbeat
    cron: "0 0 */1 * * ?"     # Quartz ัะพัะผะฐั (6-7 ะฟะพะปะตะน)
    message: |
      ะัะฟะพะปะฝะธ ัะตะบะปะธัั ะธะท HEARTBEAT.md:
      {{ ัะพะดะตัะถะธะผะพะต HEARTBEAT.md }}
      
      ะัะปะธ ะฝะธัะตะณะพ ะฝะต ััะตะฑัะตั ะฒะฝะธะผะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั โ ะพัะฒะตัั JSON:
      {"silent": true, "reason": "ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ััะพ ะฟัะพะฒะตัะธะป"}
    model: glm/glm-4-plus
    inject_into: "telegram_123456"
```

ะะปััะตะฒัะต ะพัะปะธัะธั ะพั OpenClaw:
- Heartbeat **ะฝะต ะทะฐะณััะถะฐะตั ะบะพะฝัะตะบัั ะพัะฝะพะฒะฝะพะน ัะตััะธะธ** โ ั ะฝะตะณะพ ัะฒะพะน ะธะทะพะปะธัะพะฒะฐะฝะฝัะน ะบะพะฝัะตะบัั ั ะฑะฐะทะพะฒัะผ system prompt ะธ ัะฒะพะตะน ะบะพัะพัะบะพะน ะธััะพัะธะตะน
- Heartbeat **ะฝะต ะฟะพััะตะฑะปัะตั 170k+ ัะพะบะตะฝะพะฒ** โ ัะพะปัะบะพ ~2โ3k ะฝะฐ ะฑะฐะทะพะฒัะน ะบะพะฝัะตะบัั + ัะตะบะปะธัั
- Heartbeat **ะฝะต ะฑะปะพะบะธััะตั** ะธะฝัะตัะฐะบัะธะฒะฝัะน ัะฐะทะณะพะฒะพั โ ัะฐะฑะพัะฐะตั ะฟะฐัะฐะปะปะตะปัะฝะพ
- ะะตะทัะปััะฐั heartbeat'ะฐ **ะพัะฟัะฐะฒะปัะตััั ะฟะพะปัะทะพะฒะฐัะตะปั** (ะตัะปะธ ะฝะต ัะพะดะตัะถะธั `"silent": true`)

### 4.5. ะะฐะฟะฟะธะฝะณ MEMORY.md ะธ daily logs โ sqlite-vec

ะัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต (ะธะปะธ ะฟะพ ะบะพะผะฐะฝะดะต `klaw import`) engine ะธะฝะดะตะบัะธััะตั ัััะตััะฒัััะธะต ัะฐะนะปั ะฟะฐะผััะธ OpenClaw ะฒ sqlite-vec:

```
MEMORY.md                    โ Archival memory (ัะฐะฝะบะฐะผะธ ะฟะพ ~400 ัะพะบะตะฝะพะฒ โ embed โ sqlite-vec)
memory/YYYY-MM-DD.md         โ Archival memory (ั ะฟัะธะฒัะทะบะพะน ะบ ะดะฐัะต, ัะฐะฝะบะธ โ embed โ sqlite-vec)
USER.md                      โ Core memory (ะฟะฐััะธััั ะฒ core_memory.json)
```

ะะพัะปะต ะธะผะฟะพััะฐ Klaw ะฟัะพะดะพะปะถะฐะตั ะฟะธัะฐัั ัะพะฑััะฒะตะฝะฝัะต JSONL-ะปะพะณะธ ะธ Markdown-ัะฐะผะผะฐัะธ ะฟะฐัะฐะปะปะตะปัะฝะพ, ัะพััะฐะฝัั ัะพะฒะผะตััะธะผะพััั ั ะธะฝััััะผะตะฝัะฐะผะธ ัะบะพัะธััะตะผั OpenClaw (memory-viewer ะธ ั.ะด.).

### 4.6. ะะฑัะฐัะฝะฐั ะทะฐะฟะธัั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

ะะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะบะพัะพััะต ัะพััั ัะพััะฐะฝะธัั ะฒะพะทะผะพะถะฝะพััั ะฒะตัะฝััััั ะบ OpenClaw ะธะปะธ ะธัะฟะพะปัะทะพะฒะฐัั ะพะฑะฐ ะฟะฐัะฐะปะปะตะปัะฝะพ, engine ะผะพะถะตั ะพะฟัะธะพะฝะฐะปัะฝะพ ะทะฐะฟะธััะฒะฐัั ะพะฑะฝะพะฒะปะตะฝะธั ะพะฑัะฐัะฝะพ ะฒ ัะพัะผะฐั OpenClaw:

```yaml
# engine.yaml
compatibility:
  openclaw:
    enabled: true
    sync:
      memory_md: true      # ะพะฑะฝะพะฒะปััั MEMORY.md
      daily_logs: true      # ะฟะธัะฐัั memory/YYYY-MM-DD.md
      user_md: true         # ะพะฑะฝะพะฒะปััั USER.md ะธะท core_memory.json["user"]
                             # ะคะพัะผะฐั: Markdown ั ะบะปััะฐะผะธ ะบะฐะบ ะทะฐะณะพะปะพะฒะบะฐะผะธ, ะทะฝะฐัะตะฝะธัะผะธ ะบะฐะบ ัะตะบััะพะผ.
                             # ะัะธะผะตั: "## Name\nRoman\n\n## Location\nPrague, CZ\n"
                             # USER.md ะฟะพัะปะต ะฟะตัะฒะพะณะพ ะธะผะฟะพััะฐ โ write-only ะดะปั Klaw.
                             # ะะทะผะตะฝะตะฝะธั ะฒ USER.md ะฒัััะฝัั ะะ ะฟะพะดัะฒะฐััะฒะฐัััั โ ัะตะดะฐะบัะธััะนัะต
                             # core_memory.json ะธะปะธ ะธัะฟะพะปัะทัะนัะต tool memory_core_update.
```

ะัะธ `KLAW_WORKSPACE=~/.openclaw/workspace` Klaw ัะฐะฑะพัะฐะตั ะฝะฐะฟััะผัั ั OpenClaw workspace โ sync ะทะฐะฟะธััะฒะฐะตั ะพะฑัะฐัะฝะพ ะฒ ัะต ะถะต ัะฐะนะปั.

### 4.7. ะกัััะบัััะฐ workspace

Workspace โ ััะพ ัะพะปัะบะพ ัะฐะนะปั ะฐะณะตะฝัะฐ (ะฟะตััะพะฝะฐ, ะฟะฐะผััั, ะฝะฐะฒัะบะธ). ะะพะฝัะธะณััะฐัะธั ะธ ัะฐะฝัะฐะนะผ-ะดะฐะฝะฝัะต ะถะธะฒัั ะพัะดะตะปัะฝะพ ะฟะพ XDG-ะฟัััะผ (ัะผ. ัะตะบัะธั 9).

```
workspace/                              # $KLAW_WORKSPACE ะธะปะธ --workspace
โโโ AGENTS.md                           # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ SOUL.md                             # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ IDENTITY.md                         # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ USER.md                             # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ TOOLS.md                            # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ MEMORY.md                           # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ HEARTBEAT.md                        # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ BOOT.md                             # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โโโ memory/                             # โ OpenClaw-ัะพะฒะผะตััะธะผัะน
โ   โโโ 2026-02-24.md
โ   โโโ 2026-02-25.md
โโโ skills/                             # โ OpenClaw-ัะพะฒะผะตััะธะผัะน (ัะธัะฐะตั SKILL.md)
    โโโ web-search/
        โโโ SKILL.md                    #    ะะฝััััะบัะธะธ + ะผะตัะฐะดะฐะฝะฝัะต
        โโโ scripts/                    #    ะะฟัะธะพะฝะฐะปัะฝัะต ัะบัะธะฟัั
            โโโ search.sh
```

Workspace ัะธัััะน โ ะฝะธะบะฐะบะธั `.klaw/`, `config/`, `index.db`. ะะพะถะฝะพ ะดะตัะถะฐัั ะฟะพะด git, ัะฐัะธัั ะผะตะถะดั ะฐะณะตะฝัะฐะผะธ, ะธัะฟะพะปัะทะพะฒะฐัั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ั OpenClaw.

---

## 5. ะฅัะฐะฝะธะปะธัะต ะดะฐะฝะฝัั

### 5.1. ะัะธะฝัะธะฟ: ัะฐะนะปั ะบะฐะบ source of truth, SQLite ะบะฐะบ ะธะฝะดะตะบั

ะะฐะฝัะฐะนะผ-ะดะฐะฝะฝัะต (conversations, summaries, memory snapshots, ะธะฝะดะตะบัั) ะถะธะฒัั ะฒ `$XDG_DATA_HOME/klaw/` ะพัะดะตะปัะฝะพ ะพั workspace ะธ ะบะพะฝัะธะณััะฐัะธะธ.

**ะะดะธะฝะฐั ะฑะฐะทะฐ `klaw.db`** โ Engine ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั. ะกะพะดะตัะถะธั: ะธะฝะดะตะบั ัะพะพะฑัะตะฝะธะน (ะดะปั ัะบะพะปัะทััะตะณะพ ะพะบะฝะฐ), ัะตััะธะธ, FTS5, sqlite-vec. ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท JSONL-ัะฐะนะปะพะฒ ะฟัะธ ะฟะพะฒัะตะถะดะตะฝะธะธ (`klaw reindex`).

**ะัะดะตะปัะฝะฐั ะฑะฐะทะฐ `scheduler.db`** โ Engine ะตะดะธะฝััะฒะตะฝะฝัะน ะฒะปะฐะดะตะปะตั (Scheduler โ ะผะพะดัะปั Engine). ะกะพะดะตัะถะธั ัะฐะฑะปะธัั Quartz (QRTZ_*) ะดะปั ะฟะตััะธััะตะฝัะฝะพััะธ ะทะฐะดะฐั.

```
$XDG_DATA_HOME/klaw/                    # ~/.local/share/klaw/
โโโ conversations/                       # JSONL โ ะธะผะผััะฐะฑะตะปัะฝัะน ะปะพะณ (source of truth)
โ   โโโ telegram_123456/
โ   โ   โโโ 2026-02-24.jsonl
โ   โ   โโโ 2026-02-25.jsonl
โ   โโโ discord_789012/
โ   โ   โโโ 2026-02-24.jsonl
โ   โโโ scheduler_daily-summary/
โ       โโโ 2026-02-24.jsonl
โ
โโโ summaries/                           # Markdown โ ัะตะปะพะฒะตะบะพัะธัะฐะตะผัะต ัะฐะผะผะฐัะธ
โ   โโโ telegram_123456/
โ   โ   โโโ 2026-02-24_msg_001_050.md
โ   โโโ discord_789012/
โ       โโโ 2026-02-24_msg_001_030.md
โ
โโโ memory/
โ   โโโ core_memory.json               # ะกะฝะฐะฟัะพั core memory (ัะตะดะฐะบัะธััะตะผัะน)
โ
โโโ skills/                              # ะะธัะตะบัะพัะธะธ skills
โ   โโโ web-search/
โ   โ   โโโ manifest.json
โ   โ   โโโ run.sh
โ   โโโ code-execute/
โ       โโโ manifest.json
โ       โโโ run.py
โ
โโโ klaw.db                              # SQLite โ Engine ะฒะปะฐะดะตะตั (messages, sessions, vec, FTS)
โโโ scheduler.db                         # SQLite โ Engine ะฒะปะฐะดะตะตั (Quartz QRTZ_* ัะฐะฑะปะธัั)
```

### 5.2. ะคะพัะผะฐั JSONL

ะะดะฝะฐ ัััะพะบะฐ = ะพะดะฝะพ ัะพะพะฑัะตะฝะธะต. Append-only.

```json
{"id":"msg_001","ts":"2026-02-24T14:30:00Z","role":"user","content":"ะัะธะฒะตั, ะฝะฐะฟะพะผะฝะธ ััะพ ั ะผะตะฝั ัะตะณะพะดะฝั","meta":{"channel":"telegram","chat_id":"123456"}}
{"id":"msg_002","ts":"2026-02-24T14:30:02Z","role":"assistant","content":"ะกะตะณะพะดะฝั ั ัะตะฑั ะฒัััะตัะฐ ะฒ 16:00...","meta":{"channel":"telegram","chat_id":"123456","model":"glm-5","tokens_in":4500,"tokens_out":120}}
{"id":"msg_003","ts":"2026-02-24T14:30:03Z","role":"tool","content":"{\"result\":\"OK\"}","meta":{"channel":"telegram","chat_id":"123456","tool":"calendar-check"}}
{"id":"msg_004","ts":"2026-02-24T15:00:00Z","role":"assistant","content":"ะะฑะฝะฐััะถะตะฝะพ 2 ะฒะฐะถะฝัั ะฟะธััะผะฐ ะพั ะบะปะธะตะฝัะฐ","meta":{"source":"heartbeat","channel":"telegram","chat_id":"123456"}}
```

### 5.3. klaw.db โ ะตะดะธะฝะฐั SQLite ะฑะฐะทะฐ (Engine ะฒะปะฐะดะตะตั)

```sql
-- ะะฝะดะตะบั ัะพะพะฑัะตะฝะธะน (ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท JSONL)
-- ะญัะพ ะทะตัะบะฐะปะพ JSONL ะดะปั ะฑััััะพะณะพ ัะบะพะปัะทััะตะณะพ ะพะบะฝะฐ
-- โ๏ธ ะะะะะ: ะะ ะดะพะฑะฐะฒะปััั WITHOUT ROWID โ FTS5 content sync ะทะฐะฒะธัะธั ะพั implicit rowid.
-- ะกะผ. messages_fts ะฝะธะถะต.
CREATE TABLE messages (
    id TEXT PRIMARY KEY,
    channel TEXT NOT NULL,
    chat_id TEXT NOT NULL,
    role TEXT NOT NULL,          -- user, assistant, system, tool
    type TEXT,                   -- null, session_break, subagent_result, internal
    content TEXT NOT NULL,
    metadata JSON,
    created_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_messages_chat ON messages(chat_id, created_at DESC);

-- ะกะตััะธะธ (ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท JSONL + routing.default)
CREATE TABLE sessions (
    chat_id TEXT PRIMARY KEY,
    model TEXT NOT NULL,
    segment_start TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL
);

-- FTS5 ะดะปั ะฟะพะปะฝะพัะตะบััะพะฒะพะณะพ ะฟะพะธัะบะฐ
-- ะัะธะผะตัะฐะฝะธะต: messages ะธัะฟะพะปัะทัะตั TEXT PRIMARY KEY, ะฝะพ SQLite ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัั
-- implicit rowid. FTS5 content sync ะฟัะธะฒัะทะฐะฝ ะบ ััะพะผั rowid.
-- ะัะธ klaw reindex FTS5 ะฟะตัะตัะพะทะดะฐัััั ัะธะฝััะพะฝะฝะพ ั ัะฐะฑะปะธัะตะน messages.
CREATE VIRTUAL TABLE messages_fts USING fts5(content, content=messages, content_rowid=rowid);

-- ะกะฐะผะผะฐัะธ (ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ะธะท ัะฐะนะปะพะฒ)
CREATE TABLE summaries (
    id INTEGER PRIMARY KEY,
    chat_id TEXT NOT NULL,
    from_message_id TEXT,
    to_message_id TEXT,
    file_path TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL
);

-- sqlite-vec: ะฒะตะบัะพัะฝัะน ะธะฝะดะตะบั ะดะปั ะฐััะธะฒะฝะพะน ะฟะฐะผััะธ
CREATE VIRTUAL TABLE vec_memory USING vec0(
    embedding float[384]
);

CREATE TABLE memory_chunks (
    id INTEGER PRIMARY KEY,
    source TEXT NOT NULL,
    chat_id TEXT,
    content TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

-- sqlite-vec: ะดะพะบัะผะตะฝัะฐัะธั ะฐะณะตะฝัะฐ
CREATE VIRTUAL TABLE vec_docs USING vec0(embedding float[384]);

CREATE TABLE doc_chunks (
    id INTEGER PRIMARY KEY,
    file TEXT NOT NULL,
    section TEXT,
    content TEXT NOT NULL,
    version TEXT NOT NULL
);
```

**ะัะธะฝัะธะฟ**: `klaw.db` โ ััะพ ะบัั/ะธะฝะดะตะบั. JSONL โ source of truth. ะัะธ ะฟะพะฒัะตะถะดะตะฝะธะธ `klaw.db` โ `klaw reindex` ะฟะตัะตัะพะฑะธัะฐะตั ะธะท JSONL-ัะฐะนะปะพะฒ.

### 5.4. ะะฟะตัะฐัะธะธ ั ะดะฐะฝะฝัะผะธ

| ะะฟะตัะฐัะธั | ะะตะฐะปะธะทะฐัะธั |
|----------|------------|
| **ะัะบะฐะฟ** | `rsync -a ~/.local/share/klaw/ backup/` ะธะปะธ `git commit` |
| **ะะธะณัะฐัะธั** | ะกะบะพะฟะธัะพะฒะฐัั `$XDG_DATA_HOME/klaw/`, ะฟะตัะตัะพะฑัะฐัั `klaw.db` |
| **ะะตะฑะฐะณ** | `tail -f ~/.local/share/klaw/conversations/telegram_123456/2026-02-25.jsonl` |
| **ะะพะธัะบ** | `grep "ะบะปััะตะฒะพะต ัะปะพะฒะพ" ~/.local/share/klaw/conversations/**/*.jsonl` |
| **ะััะฝะฐั ะฟัะฐะฒะบะฐ ะฟะฐะผััะธ** | ะะตะดะฐะบัะธัะพะฒะฐัั `~/.local/share/klaw/memory/core_memory.json` |
| **ะญะบัะฟะพัั** | JSONL โ ะปัะฑะพะน ัะพัะผะฐั ััะธะฒะธะฐะปัะฝัะผ ัะบัะธะฟัะพะผ |
| **ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะฝะดะตะบัะฐ** | `klaw reindex` โ ะฟะตัะตัะพะฑะธัะฐะตั `klaw.db` ะธะท JSONL + ัะฐะนะปะพะฒ |

---

## 6. ะกะธััะตะผะฐ Skills

### 6.1. ะงัะพ ัะฐะบะพะต skill

Skill โ ะฟะฐะฟะบะฐ ั `SKILL.md` ัะฐะนะปะพะผ, ัะพะดะตัะถะฐัะธะผ ะบะพะฝัะตะฝััะธัะพะฒะฐะฝะฝัะต ะทะฝะฐะฝะธั ะธ ะธะฝััััะบัะธะธ ะดะปั ะฐะณะตะฝัะฐ. ะคะพัะผะฐั ัะพะฒะผะตััะธะผ ัะพ ััะฐะฝะดะฐััะพะผ [Agent Skills](https://agentskills.io/) (Anthropic, OpenAI Codex, GitHub Copilot, Cursor).

Skill โ ััะพ **ะฝะต ะธัะฟะพะปะฝัะตะผัะน ะบะพะด**. ะญัะพ ะฟะตัะตัะฟะฐะบะพะฒะฐะฝะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั: best practices, workflows, decision trees, ะฟัะธะผะตัั ะบะพะดะฐ. ะะณะตะฝั ัะธัะฐะตั skill ะบะพะณะดะฐ ะทะฐะดะฐัะฐ ัะพะฒะฟะฐะดะฐะตั ั ะพะฟะธัะฐะฝะธะตะผ, ะธ ัะปะตะดัะตั ะธะฝััััะบัะธัะผ โ ัะฐะบ ะถะต, ะบะฐะบ ะพะฟััะฝัะน ัะฐะทัะฐะฑะพััะธะบ ัะธัะฐะป ะฑั README ะฟะตัะตะด ัะฐะฑะพัะพะน ั ะฝะตะทะฝะฐะบะพะผะพะน ะฑะธะฑะปะธะพัะตะบะพะน.

```
skills/
โโโ web-search/
โ   โโโ SKILL.md                    # ะะฝััััะบัะธะธ: ะบะฐะบ ะธัะบะฐัั, ะบะฐะบะธะต API, ัะพัะผะฐั ะพัะฒะตัะฐ
โ   โโโ examples/
โ       โโโ search-patterns.md      # ะัะธะผะตัั ัะพัะพัะธั ะฟะพะธัะบะพะฒัั ะทะฐะฟัะพัะพะฒ
โโโ code-review/
โ   โโโ SKILL.md                    # ะงะตะบะปะธัั code review, ะฟะฐััะตัะฝั, ะฐะฝัะธะฟะฐััะตัะฝั
โโโ docker-deploy/
โ   โโโ SKILL.md                    # ะะฐะบ ะดะตะฟะปะพะธัั ะฝะฐ RPi5, Docker Compose ัะฐะฑะปะพะฝั
โ   โโโ templates/
โ   โ   โโโ docker-compose.yml      # ะจะฐะฑะปะพะฝ ะดะปั ะฝะพะฒัั ัะตัะฒะธัะพะฒ
โ   โโโ scripts/
โ       โโโ health-check.sh         # ะกะบัะธะฟั ะฟัะพะฒะตัะบะธ ะทะดะพัะพะฒัั (ะฐะณะตะฝั ะผะพะถะตั ะทะฐะฟัััะธัั)
โโโ kotlin-kmp/
    โโโ SKILL.md                    # KMP best practices, Compose Multiplatform ะฟะฐััะตัะฝั
```

### 6.2. ะคะพัะผะฐั SKILL.md

```markdown
---
name: web-search
description: ะัะฟะพะปัะทัะน ะบะพะณะดะฐ ะฝัะถะฝะพ ะฝะฐะนัะธ ะฐะบััะฐะปัะฝัั ะธะฝัะพัะผะฐัะธั ะฒ ะธะฝัะตัะฝะตัะต. 
  ะะต ะธัะฟะพะปัะทัะน ะดะปั ะฒะพะฟัะพัะพะฒ, ะพัะฒะตัั ะฝะฐ ะบะพัะพััะต ัะถะต ะตััั ะฒ ะฟะฐะผััะธ.
---

# Web Search

## ะะพะณะดะฐ ะธัะฟะพะปัะทะพะฒะฐัั
- ะะพะปัะทะพะฒะฐัะตะปั ัะฟัะฐัะธะฒะฐะตั ะพ ัะตะบััะธั ัะพะฑััะธัั, ัะตะฝะฐั, ะฟะพะณะพะดะต
- ะัะถะฝะฐ ะฒะตัะธัะธะบะฐัะธั ัะฐะบัะฐ, ะบะพัะพััะน ะผะพะถะตั ะฑััั ัััะฐัะตะฒัะธะผ
- ะะฐะฟัะพั ัะพะดะตัะถะธั "ะฝะฐะนะดะธ", "ะทะฐะณัะณะปะธ", "ััะพ ะฝะพะฒะพะณะพ"

## ะะฐะบ ะธัะบะฐัั
1. ะกัะพัะผัะปะธััะน ะทะฐะฟัะพั ะฝะฐ ัะทัะบะต ะพะถะธะดะฐะตะผะพะณะพ ัะตะทัะปััะฐัะฐ
2. ะัะฟะพะปัะทัะน tool `code_execute` ั curl ะบ SearXNG: ...
3. ะะฐััะธ JSON-ะพัะฒะตั, ะฒัะฑะตัะธ top-3 ัะตะทัะปััะฐัะฐ
4. ะัะปะธ ะฝัะถะฝะฐ ะฟะพะปะฝะฐั ัััะฐะฝะธัะฐ โ ะธัะฟะพะปัะทัะน `code_execute` ั readability-cli

## ะคะพัะผะฐั ะพัะฒะตัะฐ
- ะัะตะณะดะฐ ัะบะฐะทัะฒะฐะน ะธััะพัะฝะธะบ (URL)
- ะะฐัะฐ ะฟัะฑะปะธะบะฐัะธะธ ะตัะปะธ ะตััั
- ะัะฐัะบะพ, ะฟะพ ะดะตะปั, ะฑะตะท ะฟะตัะตัะบะฐะทะฐ ะฒัะตะน ัััะฐะฝะธัั
```

### 6.3. Progressive disclosure

ะะต ะฒัะต skills ะทะฐะณััะถะฐัััั ะฒ ะบะพะฝัะตะบัั. ะญัะพ ัะพััะฐะฝัะตั ะฑัะดะถะตั ัะพะบะตะฝะพะฒ.

**ะะฒะฐ ะธััะพัะฝะธะบะฐ skills:**

| ะะธัะตะบัะพัะธั | ะะฐะทะฝะฐัะตะฝะธะต | ะัะธะผะตั |
|------------|-----------|--------|
| `$KLAW_WORKSPACE/skills/` | Skills ะฐะณะตะฝัะฐ โ ัะฟะตัะธัะธัะฝัะต ะดะปั ะฟะตััะพะฝั, ะผะพะถะฝะพ ะดะตัะถะฐัั ะฟะพะด git ะฒะผะตััะต ั workspace | `web-search/`, `code-review/` |
| `$XDG_DATA_HOME/klaw/skills/` | ะกะธััะตะผะฝัะต / ัััะฐะฝะพะฒะปะตะฝะฝัะต skills โ ะพะฑัะธะต ะดะปั ะปัะฑะพะณะพ workspace, ััะฐะฒัััั ัะตัะตะท `klaw skill install` (Post-MVP) | `code-execute/` |

**ะัะธะพัะธัะตั ะฟัะธ ะบะพะฝัะปะธะบัะต ะธะผัะฝ**: workspace skill ะฟะพะฑะตะถะดะฐะตั ัะธััะตะผะฝัะน (ะฐะฝะฐะปะพะณ PATH โ ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะต ะฟะตัะตะบััะฒะฐะตั ัะธััะตะผะฝะพะต). Engine ะปะพะณะธััะตั warning: `Skill 'web-search' found in both workspace and data, using workspace version`.

```
ะกัะฐัั engine:
  โ ะกะบะฐะฝะธัะพะฒะฐะฝะธะต $XDG_DATA_HOME/klaw/skills/ (ัะธััะตะผะฝัะต, ะฝะธะทะบะธะน ะฟัะธะพัะธัะตั)
  โ ะกะบะฐะฝะธัะพะฒะฐะฝะธะต $KLAW_WORKSPACE/skills/ (workspace, ะฒััะพะบะธะน ะฟัะธะพัะธัะตั โ ะฟะตัะตะบััะฒะฐะตั ะฟะพ ะธะผะตะฝะธ)
  โ ะะปั ะบะฐะถะดะพะณะพ skill: ะฟัะพัะธัะฐัั ัะพะปัะบะพ YAML frontmatter (name + description)
  โ ะะบะปััะธัั ะฒ system prompt ะบะฐะบ ัะฟะธัะพะบ ะดะพัััะฟะฝัั skills (~5 ัะพะบะตะฝะพะฒ ะฝะฐ skill):
    "ะะพัััะฟะฝัะต skills: web-search (ะฟะพะธัะบ ะฒ ะธะฝัะตัะฝะตัะต), code-review (ัะตะบะปะธัั ัะตะฒัั), ..."

ะะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั:
  โ LLM ะฒะธะดะธั ัะฟะธัะพะบ skills ะฒ system prompt
  โ LLM ัะตัะฐะตั ััะพ ะฝัะถะตะฝ web-search
  โ LLM ะฒัะทัะฒะฐะตั tool: skill_load(name="web-search")
  โ Engine ัะธัะฐะตั ะฟะพะปะฝัะน SKILL.md (~500-2000 ัะพะบะตะฝะพะฒ) ะธ ะฒะพะทะฒัะฐัะฐะตั ะบะฐะบ tool result
  โ LLM ัะปะตะดัะตั ะธะฝััััะบัะธัะผ ะธะท skill
  โ ะัะปะธ skill ัััะปะฐะตััั ะฝะฐ ัะฐะนะปั (templates/, scripts/) โ LLM ะฒัะทัะฒะฐะตั file_read
```

**Discovery** โ **Activation** โ **Execution**. ะะณะตะฝั ะฟะพะดะณััะถะฐะตั ะทะฝะฐะฝะธั on-demand.

### 6.4. ะัััะพะตะฝะฝัะต tools (in-process)

Tools โ ะฒัััะพะตะฝะฝัะต ะธะฝััััะผะตะฝัั engine, ะธัะฟะพะปะฝัะตะผัะต in-process. LLM ะฒัะทัะฒะฐะตั ะธั ัะตัะตะท function calling, engine ะพะฑัะฐะฑะฐััะฒะฐะตั ะฝะฐะฟััะผัั. ะะผะตัั ะฟััะผะพะน ะดะพัััะฟ ะบ ะฒะฝัััะตะฝะฝะธะผ ะฟะพะดัะธััะตะผะฐะผ.

#### ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะฐะผัััั

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `memory_search` | ะกะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ ะฟะพ ะฐััะธะฒะฝะพะน ะฟะฐะผััะธ (sqlite-vec + FTS5 hybrid) | `query: string`, `topK?: int` |
| `memory_save` | ะกะพััะฐะฝะธัั ัะฐะบั/ะทะฐะผะตัะบั ะฒ ะฐััะธะฒะฝัั ะฟะฐะผััั | `content: string`, `source?: string` |
| `memory_core_get` | ะัะพัะธัะฐัั ัะตะบััะตะต ัะพะดะตัะถะธะผะพะต core memory | โ |
| `memory_core_update` | ะะฑะฝะพะฒะธัั ัะตะบัะธั core memory | `section: "user"\|"agent"`, `key: string`, `value: string` |
| `memory_core_delete` | ะฃะดะฐะปะธัั ะบะปัั ะธะท core memory | `section: "user"\|"agent"`, `key: string` |

#### ะะฐะฑะพัะฐ ั ัะฐะนะปะฐะผะธ

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `file_read` | ะงัะตะฝะธะต ัะฐะนะปะฐ ะธะท workspace | `path: string`, `startLine?: int`, `maxLines?: int` |
| `file_write` | ะะฐะฟะธัั/ะดะพะทะฐะฟะธัั ัะฐะนะปะฐ ะฒ workspace | `path: string`, `content: string`, `mode: "overwrite"\|"append"` |
| `file_list` | ะะธััะธะฝะณ ะดะธัะตะบัะพัะธะธ | `path: string`, `recursive?: bool` |

ะััะธ ะพะณัะฐะฝะธัะตะฝั workspace-ะดะธัะตะบัะพัะธะตะน โ ะฐะณะตะฝั ะฝะต ะผะพะถะตั ัะธัะฐัั ะฟัะพะธะทะฒะพะปัะฝัะต ัะฐะนะปั ัะพััะฐ. ะะฐะทะผะตั ะทะฐะฟะธัะธ ะพะณัะฐะฝะธัะตะฝ `maxFileSizeBytes` (ะฟะพ ัะผะพะปัะฐะฝะธั 1MB):

```yaml
# engine.yaml
files:
  maxFileSizeBytes: 1048576     # 1MB, ะทะฐัะธัะฐ ะพั ะทะฐะฟะธัะธ ะณะธะณะฐะฝััะบะธั ัะฐะนะปะพะฒ
```

#### ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐัะฟะธัะฐะฝะธะตะผ

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `schedule_list` | ะะพะบะฐะทะฐัั ัะตะบััะธะต ะทะฐะดะฐัะธ | โ |
| `schedule_add` | ะะพะฑะฐะฒะธัั cron-ะทะฐะดะฐัั (persistent, ะฒ Quartz) | `name: string`, `cron: string`, `message: string`, `model?: string`, `injectInto?: string` |
| `schedule_remove` | ะฃะดะฐะปะธัั ะทะฐะดะฐัั ะธะท Quartz | `name: string` |

ะะฐะดะฐัะธ ะฟะตััะธััะตะฝัะฝัะต โ ะฟะตัะตะถะธะฒะฐัั ัะตััะฐัั. Engine ะฒัะทัะฒะฐะตั Scheduler (in-process) ะฝะฐะฟััะผัั.

#### ะกัะฑะฐะณะตะฝัั

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `subagent_spawn` | ะะฐะฟัััะธัั ะพะดะฝะพัะฐะทะพะฒัะน ััะฑะฐะณะตะฝั ะฟััะผะพ ัะตะนัะฐั | `name: string`, `message: string`, `model?: string`, `injectInto?: string` |

`subagent_spawn` ัะพะทะดะฐัั ััะตะผะตัะฝัะน ััะฑะฐะณะตะฝั โ ะพัะดะตะปัะฝะฐั ะบะพัััะธะฝะฐ ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผ ะบะพะฝัะตะบััะพะผ. ะ ะพัะปะธัะธะต ะพั `schedule_add`, ะฒัะฟะพะปะฝัะตััั ะฝะตะผะตะดะปะตะฝะฝะพ ะธ ะพะดะฝะพะบัะฐัะฝะพ. ะะพะปะตะทะฝะพ ะบะพะณะดะฐ LLM ัะพัะตั ะดะตะปะตะณะธัะพะฒะฐัั ััะถัะปัั ะทะฐะดะฐัั (ะธััะปะตะดะพะฒะฐะฝะธะต, ะดะปะธะฝะฝัะน ะฐะฝะฐะปะธะท) ะฝะต ะฑะปะพะบะธััั ะพัะฝะพะฒะฝะพะน ะดะธะฐะปะพะณ.

```kotlin
// ะะพะปัะทะพะฒะฐัะตะปั: "ะัะพะฐะฝะฐะปะธะทะธััะน ััั ััะฐััั ะฟะพะดัะพะฑะฝะพ"
// โ LLM ะฒัะทัะฒะฐะตั: subagent_spawn(name="article-analysis", message="ะัะพัะธัะฐะน ะธ ะฟะพะดัะพะฑะฝะพ ะฟัะพะฐะฝะฐะปะธะทะธััะน...", injectInto="telegram_123456")
// โ Engine ัะฟะฐะฒะฝะธั ะบะพัััะธะฝั ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผ ะบะพะฝัะตะบััะพะผ
// โ ะัะฝะพะฒะฝะฐั ัะตััะธั ััะฐะทั ะพัะฒะตัะฐะตั: "ะะฐัะฐะป ะฐะฝะฐะปะธะท, ัะตะทัะปััะฐั ะฟัะธัะปั ะบะพะณะดะฐ ะฑัะดะตั ะณะพัะพะฒ"
// โ ะกัะฑะฐะณะตะฝั ะทะฐะฒะตััะฐะตััั โ ัะตะทัะปััะฐั ะฟัะธัะพะดะธั ะฟะพะปัะทะพะฒะฐัะตะปั
```

#### Skills

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `skill_load` | ะะฐะณััะทะธัั ะฟะพะปะฝัะน SKILL.md ะฒ ะบะพะฝัะตะบัั | `name: string` |
| `skill_list` | ะะพะบะฐะทะฐัั ะฒัะต ะดะพัััะฟะฝัะต skills ั ะพะฟะธัะฐะฝะธัะผะธ | โ |

#### ะกะฐะผะพะดะพะบัะผะตะฝัะฐัะธั

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `docs_search` | ะกะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ ะฟะพ ะดะพะบัะผะตะฝัะฐัะธะธ Klaw | `query: string`, `topK?: int` |
| `docs_read` | ะัะพัะธัะฐัั ะบะพะฝะบัะตัะฝัะน ัะฐะทะดะตะป ะดะพะบัะผะตะฝัะฐัะธะธ | `path: string` |
| `docs_list` | ะะพะบะฐะทะฐัั ััััะบัััั ะดะพะบัะผะตะฝัะฐัะธะธ | โ |

ะะพะบัะผะตะฝัะฐัะธั ะฟะพััะฐะฒะปัะตััั ะฒ ะดะธัััะธะฑััะธะฒะต ะบะฐะบ Markdown-ัะฐะนะปั ะธ ะธะฝะดะตะบัะธััะตััั ะฒ `klaw.db` (ัะฐะฑะปะธัะฐ `vec_docs`) ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต (ะธะปะธ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ะฒะตััะธะธ).

#### ะฃัะธะปะธัั

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `current_time` | ะขะตะบััะฐั ะดะฐัะฐ/ะฒัะตะผั/timezone | โ |
| `send_message` | ะัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต ะฒ ะดััะณะพะน ะบะฐะฝะฐะป (cross-channel) | `channel: string`, `chatId: string`, `text: string` |

`send_message` ะฟัะพัะพะดะธั ัะตัะตะท Gateway, ะบะพัะพััะน ะฟัะพะฒะตััะตั ะฟะฐัั `channel + chatId` ะฟะพ whitelist (`allowedChatIds` ะฒ `gateway.yaml`). chatId ะฟัะธะฒัะทะฐะฝ ะบ ะบะฐะฝะฐะปั โ `telegram_123456` ะฒะฐะปะธะดะตะฝ ัะพะปัะบะพ ะดะปั Telegram. ะะพะฟััะบะฐ ะพัะฟัะฐะฒะธัั ะฒ ะฝะตัะฐะทัะตััะฝะฝัะน chatId ะธะปะธ ะฝะตัะพะพัะฒะตัััะฒัััะธะน ะบะฐะฝะฐะป ะฒะพะทะฒัะฐัะฐะตั ะพัะธะฑะบั ะบะฐะบ tool result.

### 6.5. ะัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ (Docker sandbox)

ะัะดะตะปัะฝะฐั capability, ะฝะต ัะฒัะทะฐะฝะฝะฐั ัะพ skills. ะะพะณะดะฐ ะฐะณะตะฝัั ะฝัะถะฝะพ ะฒัะฟะพะปะฝะธัั ะบะพะด (ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะน ะทะฐะฟัะพั, curl-ะทะฐะฟัะพั ะบ API, ัะบัะธะฟั ะพะฑัะฐะฑะพัะบะธ ะดะฐะฝะฝัั), ะพะฝ ะธัะฟะพะปัะทัะตั tool `code_execute`:

| Tool | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|------|----------|-----------|
| `code_execute` | ะัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะผ Docker-ะบะพะฝัะตะนะฝะตัะต | `language: "python"\|"bash"`, `code: string`, `timeout?: int` |

**Sandboxing**: ะบะฐะถะดัะน ะฒัะทะพะฒ `code_execute` ะทะฐะฟััะบะฐะตั ะบะพะฝัะตะนะฝะตั ั ะถัััะบะธะผะธ ะพะณัะฐะฝะธัะตะฝะธัะผะธ:

**โ๏ธ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะฝะฐ Pi 5**: `docker run --rm` ะฝะฐ ARM ั SD-ะบะฐััะพะน โ 2โ5 ัะตะบัะฝะด ะฝะฐ ััะฐัั ะบะพะฝัะตะนะฝะตัะฐ. ะะปั ัะตะฟะพัะบะธ ะธะท ะฝะตัะบะพะปัะบะธั tool call'ะพะฒ (ัะธะฟะธัะฝัะน ััะตะฝะฐัะธะน: ัะบัะธะฟั โ ะพัะธะฑะบะฐ โ ะธัะฟัะฐะฒะปะตะฝะธะต โ ะฟะพะฒัะพั) ััะพ 10โ20 ัะตะบัะฝะด overhead. **ะะธัะธะณะฐัะธั ะดะปั MVP**: keep-alive ะบะพะฝัะตะนะฝะตั โ Engine ะฟัะธ ััะฐััะต ะทะฐะฟััะบะฐะตั ะพะดะธะฝ long-running ะบะพะฝัะตะนะฝะตั (`docker run -d --name klaw-sandbox ...`), code_execute ะธัะฟะพะปัะทัะตั `docker exec` ะฒะผะตััะพ `docker run`. ะะพะฝัะตะนะฝะตั ะฟะตัะตะทะฐะฟััะบะฐะตััั ะบะฐะถะดัะต N ะฒัะทะพะฒะพะฒ ะธะปะธ ะฟะพ ัะฐะนะผะฐััั ะฑะตะทะดะตะนััะฒะธั (10 ะผะธะฝัั). ะญัะพ ัะพะบัะฐัะฐะตั overhead ะดะพ ~100ms ะทะฐ ะฒัะทะพะฒ ัะตะฝะพะน ะฟะพััะพัะฝะฝัั ~40MB RAM.

```yaml
# engine.yaml
codeExecution:
  dockerImage: "klaw-sandbox:latest"    # prebuilt ะพะฑัะฐะท ั Python, bash, curl
  timeout: 30                            # ัะตะบัะฝะด, ะถัััะบะธะน ะปะธะผะธั
  allowNetwork: true                     # false โ --network none
  maxMemory: "256m"                      # --memory
  maxCpus: "1.0"                         # --cpus
  readOnlyRootfs: true                   # --read-only
  noPrivileged: true                     # ะทะฐะฟัะตั --privileged (hardcoded, ะฝะต ะบะพะฝัะธะณััะธััะตะผัะน)
  keepAlive: true                        # true: docker exec (ะฑััััะพ), false: docker run --rm (ะธะทะพะปััะธั)
  keepAliveIdleTimeoutMin: 10            # ัะฑะธัั keep-alive ะบะพะฝัะตะนะฝะตั ะฟะพัะปะต N ะผะธะฝัั ะฑะตะทะดะตะนััะฒะธั
  keepAliveMaxExecutions: 50             # ะฟะตัะตัะพะทะดะฐัั ะบะพะฝัะตะนะฝะตั ะฟะพัะปะต N ะฒัะทะพะฒะพะฒ (ะทะฐัะธัะฐ ะพั ััะตัะตะบ)
  volumeMounts:                          # ัะฐะทัะตััะฝะฝัะต mount'ั
    - "${KLAW_WORKSPACE}/skills:ro"      # read-only ะดะพัััะฟ ะบ ัะฐะนะปะฐะผ skills (ัะบัะธะฟัั, ัะฐะฑะปะพะฝั)
    - "/tmp/klaw-sandbox:rw"             # ะฒัะตะผะตะฝะฝะฐั ะดะธัะตะบัะพัะธั ะดะปั output'ะฐ
```

Engine ัะพัะผะธััะตั `docker run` ั ััะธะผะธ ะพะณัะฐะฝะธัะตะฝะธัะผะธ:
```bash
docker run --rm \
  --memory 256m --cpus 1.0 \
  --read-only \
  --network ${allowNetwork ? "bridge" : "none"} \
  --tmpfs /tmp:rw,size=64m \
  -v "${workspace}/skills:/skills:ro" \
  -v "/tmp/klaw-sandbox:/output:rw" \
  klaw-sandbox:latest \
  timeout 30 python3 -c "${code}"
```

ะะฐะฟัะตัะตะฝั: `--privileged`, ะฟัะพะธะทะฒะพะปัะฝัะต volume mounts, ะดะพัััะฟ ะบ Docker socket ะธะทะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ, ะดะพัััะฟ ะบ host filesystem ะบัะพะผะต ัะฒะฝะพ ัะฐะทัะตััะฝะฝัั ะฟััะตะน.

### 6.6. ะะพะผะฐะฝะดั

Slash-ะบะพะผะฐะฝะดั ัะตะณะธัััะธัััััั ะฒ Telegram ัะตัะตะท `setMyCommands` (ะผะตะฝั ะฑะพัะฐ). Gateway ะทะฝะฐะตั ะพ ะฝะธั ะฝะฐ ััะพะฒะฝะต ะฟัะพัะพะบะพะปะฐ (Telegram `bot_command` entity) โ ะฝะพ ะฝะต ะทะฝะฐะตั ััะพ ะพะฝะธ ะดะตะปะฐัั. Gateway ะฝะพัะผะฐะปะธะทัะตั ะบะพะผะฐะฝะดั ะฒ unified message format ะธ ะพัะฟัะฐะฒะปัะตั ะฒ Engine. Engine ะพะฑัะฐะฑะฐััะฒะฐะตั ะฑะตะท ะฒัะทะพะฒะฐ LLM.

```kotlin
// Gateway: Telegram message ั entity type=bot_command
// โ ะฝะพัะผะฐะปะธะทะฐัะธั ะฒ unified format, ะพัะฟัะฐะฒะบะฐ ะฒ Engine socket
{"type":"command","channel":"telegram","chatId":"telegram_123456","command":"model","args":"deepseek/deepseek-chat"}

// Engine: ะฒะธะดะธั type=command โ CommandHandler โ ะพัะฒะตั ะฑะตะท LLM
// Engine: ะฒะธะดะธั type=inbound โ ะบะพะฝัะตะบัั โ LLM
```

ะกะฟะธัะพะบ ะบะพะผะฐะฝะด ะทะฐะดะฐัััั ะฒ `engine.yaml` (Engine โ ะฒะปะฐะดะตะปะตั ะปะพะณะธะบะธ), Gateway ัะธัะฐะตั ัะพะปัะบะพ ะธะผะตะฝะฐ ะดะปั ัะตะณะธัััะฐัะธะธ ะฒ Telegram:

```yaml
# engine.yaml
commands:
  - name: new
    description: "ะะพะฒะฐั ัะตััะธั (ัะฑัะพั ะบะพะฝัะตะบััะฐ)"
  - name: model
    description: "ะะพะบะฐะทะฐัั/ัะผะตะฝะธัั ะผะพะดะตะปั LLM"
  - name: models
    description: "ะกะฟะธัะพะบ ะดะพัััะฟะฝัั ะผะพะดะตะปะตะน"
  - name: memory
    description: "ะะพะบะฐะทะฐัั core memory"
  - name: status
    description: "ะกัะฐััั ะฐะณะตะฝัะฐ"
  - name: help
    description: "ะกะฟะธัะพะบ ะบะพะผะฐะฝะด"
```

| ะะพะผะฐะฝะดะฐ | ะะฟะธัะฐะฝะธะต |
|---------|----------|
| `/new` | ะะพะฒะฐั ัะตััะธั โ ัะฑัะพั ะบะพะฝัะตะบััะฝะพะณะพ ะพะบะฝะฐ |
| `/model` | ะะพะบะฐะทะฐัั ัะตะบัััั ะผะพะดะตะปั ัะตััะธะธ |
| `/model provider/model-id` | ะะตัะตะบะปััะธัั ะผะพะดะตะปั (ะฝะฐะฟัะธะผะตั `/model deepseek/deepseek-chat`) |
| `/models` | ะกะฟะธัะพะบ ะดะพัััะฟะฝัั ะผะพะดะตะปะตะน |
| `/memory` | ะะพะบะฐะทะฐัั core memory |
| `/status` | ะกัะฐััั engine, ัะตะบััะฐั ัะตััะธั, ะผะพะดะตะปั, uptime |
| `/help` | ะกะฟะธัะพะบ ะบะพะผะฐะฝะด |

#### ะกะตะผะฐะฝัะธะบะฐ `/new`

`/new` ัะฑัะฐััะฒะฐะตั ะบะพะฝัะตะบััะฝะพะต ะพะบะฝะพ, ะฝะพ ะฝะต ััะธัะฐะตั ะธััะพัะธั. Conversation log โ append-only, ัะพะพะฑัะตะฝะธั ะฝะธะบะพะณะดะฐ ะฝะต ัะดะฐะปััััั.

ะงัะพ ัะฑัะฐััะฒะฐะตััั, ััะพ ะฝะตั:

| | ะกะฑัะฐััะฒะฐะตััั | ะกะพััะฐะฝัะตััั |
|---|---|---|
| Sliding window (ะฟะพัะปะตะดะฝะธะต N ัะพะพะฑัะตะฝะธะน) | โ | |
| Last summary | โ | |
| Core memory (ัะฐะบัั ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต) | | โ |
| Archival memory (sqlite-vec) | | โ |
| ะขะตะบััะฐั ะผะพะดะตะปั | | โ |
| Conversation log (JSONL) | | โ (append-only) |

ะะพ ัััะธ `/new` โ ััะพ ะฝะต ัะดะฐะปะตะฝะธะต, ะฐ ัะฐะทััะฒ. ะกัะฐััะต ัะพะพะฑัะตะฝะธั ะพััะฐัััั ะฒ ะปะพะณะต ะธ ะดะพัััะฟะฝั ัะตัะตะท archival search, ะฝะพ ะฝะต ะฟะพะฟะฐะดะฐัั ะฒ sliding window ะฝะพะฒะพะณะพ ัะตะณะผะตะฝัะฐ.

---

## 7. CLI

### 7.1. ะะฐะทะฝะฐัะตะฝะธะต

CLI (`klaw`) โ ะพัะฝะพะฒะฝะพะน ะธะฝัะตััะตะนั ะฐะดะผะธะฝะธัััะธัะพะฒะฐะฝะธั. Gateway ะธ Engine ัะฐะฑะพัะฐัั ะบะฐะบ ะดะตะผะพะฝั (systemd services), CLI โ ัะพัะบะฐ ะฒัะพะดะฐ ะดะปั ัะฟัะฐะฒะปะตะฝะธั, ะดะธะฐะณะฝะพััะธะบะธ ะธ ะพะฑัะปัะถะธะฒะฐะฝะธั. CLI ะดะพะปะถะตะฝ ะฑััั **ะผะณะฝะพะฒะตะฝะฝัะผ** (< 50ms ะดะปั ะปะพะบะฐะปัะฝัั ะบะพะผะฐะฝะด) โ JVM-ััะฐััะฐะฟ ะฒ 1โ3 ัะตะบัะฝะดั ะฝะตะฟัะธะตะผะปะตะผ.

### 7.2. ะััะธัะตะบัััะฐ: ะดะฒะฐ ัะตะถะธะผะฐ ัะฐะฑะพัั

CLI ะบะพะผะฐะฝะดั ะดะตะปัััั ะฝะฐ **ะปะพะบะฐะปัะฝัะต** (ัะฐะฑะพัะฐัั ั ัะฐะนะปะฐะผะธ ะฝะฐะฟััะผัั, ะฝะต ััะตะฑััั ะทะฐะฟััะตะฝะฝะพะณะพ Engine) ะธ **ะดะตะปะตะณะธัะพะฒะฐะฝะฝัะต** (ััะตะฑััั Engine ะดะปั ััะถัะปัั ะพะฟะตัะฐัะธะน ะฒัะพะดะต embedding, ัะฟัะฐะฒะปะตะฝะธั ัะฐัะฟะธัะฐะฝะธะตะผ, ะธะปะธ ััะฐัััะฐ ัะฐะฝัะฐะนะผะฐ).

| ะะพะผะฐะฝะดะฐ | ะะตะถะธะผ | ะงัะพ ะดะตะปะฐะตั |
|---------|-------|------------|
| `klaw status` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะขะตะบััะธะต ัะตััะธะธ, ะผะพะดะตะปะธ, uptime |
| `klaw logs [--follow] [--chat ID]` | ะะพะบะฐะปัะฝัะน | `tail` JSONL ัะฐะนะปะพะฒ |
| `klaw schedule list` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะงะธัะฐะตั ะทะฐะดะฐัะธ ะธะท Quartz (in-process) |
| `klaw schedule add NAME CRON MSG` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะะพะฑะฐะฒะปัะตั ะฒ Quartz (in-process) |
| `klaw schedule remove NAME` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะฃะดะฐะปัะตั ะธะท Quartz (in-process) |
| `klaw memory show` | ะะพะบะฐะปัะฝัะน | ะงะธัะฐะตั `core_memory.json` |
| `klaw memory edit` | ะะพะบะฐะปัะฝัะน | ะัะบััะฒะฐะตั `core_memory.json` ะฒ `$EDITOR` |
| `klaw memory search QUERY` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะัะถะตะฝ ONNX ะดะปั embedding + sqlite-vec |
| `klaw sessions` | ะะตะปะตะณะธัะพะฒะฐะฝะฝัะน โ Engine | ะงะธัะฐะตั ะธะท `klaw.db` ัะตัะตะท Engine |
| `klaw reindex` | ะะพะบะฐะปัะฝัะน (ััะถัะปัะน) | ะะตัะตัะฑะพัะบะฐ `klaw.db` ะธะท JSONL. **ะขัะตะฑัะตั ะพััะฐะฝะพะฒะบะธ Engine** (`systemctl stop klaw-engine`) โ ะธะฝะฐัะต WAL-lock ะฝะต ะฟะพะทะฒะพะปะธั ะฟะตัะตัะพะทะดะฐัั ะฑะฐะทั |
| `klaw doctor` | ะะพะบะฐะปัะฝัะน | ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณะพะฒ, ัะฐะนะปะพะฒ, ะทะฐะฒะธัะธะผะพััะตะน |
| `klaw import [--workspace PATH]` | ะะพะบะฐะปัะฝัะน | ะะผะฟะพัั OpenClaw workspace |
| `klaw init [--from-openclaw PATH]` | ะะพะบะฐะปัะฝัะน | ะกะพะทะดะฐัั workspace (BOOTSTRAP.md) |
| `klaw export [--format json\|md] CHAT` | ะะพะบะฐะปัะฝัะน | ะญะบัะฟะพัั ัะฐะทะณะพะฒะพัะฐ |

**ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐัะฟะธัะฐะฝะธะตะผ** (`klaw schedule *`): CLI ะพัะฟัะฐะฒะปัะตั ะบะพะผะฐะฝะดั ะฒ Engine ัะตัะตะท socket, Engine ะฒัะทัะฒะฐะตั Scheduler (in-process) ะฝะฐะฟััะผัั.

### 7.3. ะะตะฐะปะธะทะฐัะธั

**ะะธะฝะฐัะฝะธะบ**: Kotlin/Native. CLI ะผะพะดัะปั ะบะพะผะฟะธะปะธััะตััั ะฒ ะฝะฐัะธะฒะฝัะน ะฑะธะฝะฐัะฝะธะบ ะฟะพะด `linuxArm64` (Pi 5) ะธ `linuxX64` (dev) โ ััะฐัั ~5โ20ms, ะฝัะปะตะฒะพะน JVM overhead. CLI ะทะฐะฒะธัะธั ะพั `common` ะผะพะดัะปั (Native target) โ ะผะพะดะตะปะธ ะดะฐะฝะฝัั, SQL-ััะตะผั, YAML-ะฟะฐััะธะฝะณ ัะฐััััั ั JVM-ะผะพะดัะปัะผะธ ะฑะตะท ะดัะฑะปะธัะพะฒะฐะฝะธั.

**ะะตะปะตะณะธัะพะฒะฐะฝะฝัะต ะบะพะผะฐะฝะดั**: CLI ะฟะพะดะบะปััะฐะตััั ะบ `$XDG_STATE_HOME/klaw/engine.sock`, ะพัะฟัะฐะฒะปัะตั JSON-ะทะฐะฟัะพั, ะฟะพะปััะฐะตั JSON-ะพัะฒะตั. ะะพัะพัะบะพะถะธะฒััะธะต ัะพะตะดะธะฝะตะฝะธั (request-response):

```
โ {"command":"status"}
โ {"uptime":"2h30m","sessions":[{"chat_id":"telegram_123456","model":"glm/glm-5"}]}

โ {"command":"memory_search","query":"ะฒัััะตัะฐ ั ะบะปะธะตะฝัะพะผ"}
โ {"results":[{"content":"...","source":"conversation","score":0.87}]}

โ {"command":"schedule_add","name":"test","cron":"0 0 12 * * ?","message":"Test","model":"glm/glm-4-plus"}
โ {"status":"ok","name":"test"}
```

ะัะปะธ Engine ะฝะต ะทะฐะฟััะตะฝ โ ะดะตะปะตะณะธัะพะฒะฐะฝะฝัะต ะบะพะผะฐะฝะดั ะฒัะดะฐัั ะฟะพะฝััะฝัั ะพัะธะฑะบั: `Engine ะฝะต ะทะฐะฟััะตะฝ. ะะฐะฟัััะธัะต: systemctl start klaw-engine`.

**ะะพะบะฐะปัะฝัะต ะบะพะผะฐะฝะดั** ัะฐะฑะพัะฐัั **ะฑะตะท ะทะฐะฟััะตะฝะฝะพะณะพ Engine** โ ะฝะฐะฟััะผัั ั ัะฐะนะปะฐะผะธ. ะญัะพ ะบัะธัะธัะฝะพ ะดะปั ะพะฑัะปัะถะธะฒะฐะฝะธั: `klaw reindex`, `klaw doctor`, `klaw logs` ะดะพะปะถะฝั ัะฐะฑะพัะฐัั ะดะฐะถะต ะตัะปะธ Engine ัะฟะฐะป.

---

## 8. ะขะตัะฝะธัะตัะบะธะน ััะตะบ

### 8.1. ะคัะตะนะผะฒะพัะบ: Micronaut

| ะัะธัะตัะธะน | Micronaut | Spring Boot | ะะพะปัะน Kotlin |
|----------|-----------|-------------|--------------|
| DI | Compile-time, ะฑะตะท ัะตัะปะตะบัะธะธ | Runtime, ััะถัะปัะน | ะัะบะฐะผะธ |
| ะกัะฐัั | <1 ัะตะบ | 3โ5 ัะตะบ | ะะณะฝะพะฒะตะฝะฝัะน |
| RAM | ~50โ80MB | ~200โ400MB | ~30MB |
| HTTP client | ะะตะบะปะฐัะฐัะธะฒะฝัะน, SSE, retry | RestTemplate/WebClient | Ktor Client |
| ะะฝะฐะบะพะผััะฒะพ | โ ะัะธะฒััะตะฝ | Overkill | ะะตั DI |

**ะะตัะตะฝะธะต**: Micronaut ะดะปั Gateway ะธ Engine. Compile-time DI, Micronaut HTTP Client (ะดะตะบะปะฐัะฐัะธะฒะฝัะน, SSE ะดะปั ัััะธะผะธะฝะณะฐ LLM), lifecycle management. ะะพะฝะพัะตะฟะพ ั KMP-ะผะพะดัะปะตะผ `common`.

```
klaw/
โโโ build.gradle.kts              # root, ะพะฑัะธะต ะทะฐะฒะธัะธะผะพััะธ
โโโ common/                       # KMP (JVM + Native): ะผะพะดะตะปะธ, ััะธะปะธัั, SQLite-ััะตะผั
โ   โโโ build.gradle.kts          #   kotlinx-serialization, kotlinx-datetime, SQLiter
โโโ gateway/                      # JVM, Micronaut app
โ   โโโ build.gradle.kts
โโโ engine/                       # JVM, Micronaut app (ะฒะบะปััะฐะตั Scheduler)
โ   โโโ build.gradle.kts
โโโ cli/                          # Kotlin/Native (linuxArm64, linuxX64)
    โโโ build.gradle.kts          #   ะทะฐะฒะธัะธั ะพั common (Native target)
```

**`common` ะบะฐะบ KMP-ะผะพะดัะปั**: common ัะพะฑะธัะฐะตััั ะฟะพะด ะดะฒะฐ ัะฐัะณะตัะฐ โ JVM (ะดะปั gateway, engine) ะธ Native (ะดะปั cli). ะญัะพ ะฟะพะทะฒะพะปัะตั ัะฐัะธัั ะผะพะดะตะปะธ ะดะฐะฝะฝัั, ัะพัะผะฐัั JSONL/YAML, SQL-ััะตะผั ะผะตะถะดั JVM-ะฟัะพัะตััะฐะผะธ ะธ ะฝะฐัะธะฒะฝัะผ CLI ะฑะตะท ะดัะฑะปะธัะพะฒะฐะฝะธั. ะัะต ะทะฐะฒะธัะธะผะพััะธ common โ ะผัะปััะธะฟะปะฐััะพัะผะตะฝะฝัะต (ัะผ. ัะตะบัะธั 8.3).

### 8.2. LLM-ะฐะฑัััะฐะบัะธั: Client / Provider / Router

LLM-ััะตะนะผะฒะพัะบะธ (LangChain4j, Spring AI) ะฝะต ะฝัะถะฝั โ OpenAI-compatible API ััะพ ะพะดะธะฝ POST-ัะฝะดะฟะพะธะฝั. ะะพ ะฝัะถะฝะฐ ะฟัะฐะฒะธะปัะฝะฐั ะฐะฑัััะฐะบัะธั ะดะปั ัะฐััะธัะตะฝะธั ะฝะฐ Anthropic ะธ Gemini.

**Client โ Provider**. Client โ ััะพ ะฟัะพัะพะบะพะป (ะบะฐะบ ัะฐะทะณะพะฒะฐัะธะฒะฐัั ั API). Provider โ ััะพ ะบะพะฝัะธะณััะฐัะธั (ะบัะดะฐ ัะพะดะธัั, ั ะบะฐะบะธะผ ะบะปััะพะผ). ะะดะธะฝ client ะพะฑัะปัะถะธะฒะฐะตั ะผะฝะพะณะพ providers.

```
LlmClient (ะฟัะพัะพะบะพะป)              Provider (ะบะพะฝัะธะณััะฐัะธั)
โโโโโโโโโโโโโโโโโ                  โโโโโโโโโโโโโโโโโโโโโ
OpenAiCompatibleClient โโโโโโโโโโโ GLM-5, DeepSeek, Qwen, Ollama, OpenRouter
AnthropicClient โโโโโโโโโโโโโโโโโโ Claude Sonnet, Claude Opus
GeminiClient โโโโโโโโโโโโโโโโโโโโโ Gemini Flash, Gemini Pro
```

```kotlin
// === common ะผะพะดัะปั (KMP: commonMain) ===

// ะะดะธะฝัะน ะฒะฝัััะตะฝะฝะธะน ัะพัะผะฐั โ ะฝะฐั, ะฝะต ัะตะน-ัะพ
data class LlmRequest(
    val messages: List<LlmMessage>,
    val tools: List<ToolDef>? = null,
    val maxTokens: Int? = null,
    val temperature: Double? = null,
)

data class LlmResponse(
    val content: String?,
    val toolCalls: List<ToolCall>?,
    val usage: TokenUsage?,
    val finishReason: FinishReason,
)

data class ToolCall(val id: String, val name: String, val arguments: String)
data class ToolResult(val callId: String, val content: String)

// ะัะพัะพะบะพะป โ ะบะฐะบ ัะฐะทะณะพะฒะฐัะธะฒะฐัั ั API
interface LlmClient {
    suspend fun chat(request: LlmRequest, provider: ProviderConfig, model: ModelRef): LlmResponse
    suspend fun chatStream(request: LlmRequest, provider: ProviderConfig, model: ModelRef): Flow<LlmChunk>
}

// ะะพะฝัะธะณััะฐัะธั ะฟัะพะฒะฐะนะดะตัะฐ โ endpoint + credentials (ะฑะตะท ะบะพะฝะบัะตัะฝะพะน ะผะพะดะตะปะธ)
data class ProviderConfig(
    val name: String,              // "glm", "deepseek", "anthropic"
    val clientType: ClientType,    // OPENAI_COMPATIBLE, ANTHROPIC, GEMINI
    val endpoint: String,
    val apiKey: String?,
)

// ะะฐะทัะตััะฝะฝะฐั ะผะพะดะตะปั โ provider + model-id + per-model ะฟะฐัะฐะผะตััั
data class ModelRef(
    val provider: String,          // "glm"
    val modelId: String,           // "glm-5"
    val maxTokens: Int? = null,
    val contextBudget: Int? = null,
    val temperature: Double? = null,
) {
    val fullId: String get() = "$provider/$modelId"   // "glm/glm-5"
    companion object {
        fun parse(id: String): ModelRef {             // "glm/glm-5" โ ModelRef("glm", "glm-5")
            val (provider, modelId) = id.split("/", limit = 2)
            return ModelRef(provider, modelId)
        }
    }
}

enum class ClientType { OPENAI_COMPATIBLE, ANTHROPIC, GEMINI }
```

**ะะพััะตั ั fallback ะธ session-aware model resolution**:

```kotlin
@Singleton
class LlmRouter(
    private val clients: Map<ClientType, LlmClient>,
    private val providers: Map<String, ProviderConfig>,
    private val models: Map<String, ModelRef>,
    private val routingConfig: RoutingConfig,
) {
    suspend fun chat(request: LlmRequest, model: String): LlmResponse {
        val chain = buildChain(model)
        for (ref in chain) {
            try {
                val provider = providers[ref.provider] ?: continue
                val client = clients[provider.clientType] ?: continue
                return client.chat(request, provider, ref)
            } catch (e: ProviderException) {
                log.warn("${ref.fullId} failed: ${e.message}, trying next")
                continue
            }
        }
        throw AllProvidersFailedException()
    }

    private fun buildChain(model: String): List<ModelRef> {
        val primary = models[model] ?: ModelRef.parse(model)
        val fallbacks = routingConfig.fallback.map { models[it] ?: ModelRef.parse(it) }
        return listOf(primary) + fallbacks.filter { it.fullId != model }
    }
}
```

### 8.3. Retry ะธ backoff ัััะฐัะตะณะธั

ะะฐะถะดัะน `LlmClient` ัะตะฐะปะธะทัะตั retry internally ะฟะตัะตะด ัะตะผ ะบะฐะบ ะฑัะพัะธัั `ProviderException` ะธ ะฟะตัะตะดะฐัั ัะฟัะฐะฒะปะตะฝะธะต fallback-ัะตะฟะพัะบะต Router'ะฐ:

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------|----------|----------|
| `maxRetries` | 2 | Retry ะฝะฐ ะพะดะธะฝ provider ะฟะตัะตะด fallback |
| `initialBackoffMs` | 1000 | ะะฐัะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ |
| `backoffMultiplier` | 2.0 | ะญะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะน ะผะฝะพะถะธัะตะปั (1s โ 2s โ 4s) |
| `requestTimeoutMs` | 60000 | ะขะฐะนะผะฐัั ะฝะฐ ะพะดะธะฝ LLM-ะทะฐะฟัะพั (ะบะธัะฐะนัะบะธะต API ะฑัะฒะฐัั ะผะตะดะปะตะฝะฝัะผะธ) |
| `retryOn` | 429, 500, 502, 503, 504 | HTTP-ะบะพะดั ะดะปั retry |

ะัะปะธ ะฒัะต retry ะธััะตัะฟะฐะฝั โ `ProviderException`, Router ะฟะตัะตัะพะดะธั ะบ ัะปะตะดัััะตะผั provider ะฒ fallback-ัะตะฟะพัะบะต. ะัะปะธ ะฒัะต providers ัะฟะฐะปะธ โ `AllProvidersFailedException`, Engine ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ัะพะพะฑัะตะฝะธะต ะพะฑ ะพัะธะฑะบะต.

```yaml
# engine.yaml
llm:
  maxRetries: 2
  requestTimeoutMs: 60000
  initialBackoffMs: 1000
  backoffMultiplier: 2.0
```

### 8.4. ะะฐะฒะธัะธะผะพััะธ

```kotlin
// build.gradle.kts (ะพัะธะตะฝัะธัะพะฒะพัะฝะพ)

// === common (KMP: JVM + linuxArm64 + linuxX64) ===
kotlin {
    jvm()
    linuxArm64()
    linuxX64()

    sourceSets {
        commonMain.dependencies {
            implementation("org.jetbrains.kotlinx:kotlinx-serialization-json")
            implementation("org.jetbrains.kotlinx:kotlinx-datetime")
            implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core")
            implementation("org.jetbrains.kotlinx:kotlinx-io-core")
            implementation("app.cash.sqldelight:runtime")
            implementation("net.mamoe.yamlkt:yamlkt")
        }
        jvmMain.dependencies {
            implementation("app.cash.sqldelight:sqlite-driver")
        }
        nativeMain.dependencies {
            implementation("app.cash.sqldelight:native-driver")
        }
    }
}

// === gateway (JVM) ===
dependencies {
    implementation(project(":common"))
    implementation("io.micronaut:micronaut-runtime")
    implementation("io.micronaut:micronaut-inject")
    implementation("dev.inmo:tgbotapi")       // Telegram
    implementation("dev.kord:kord-core")       // Discord
}

// === engine (JVM) ===
dependencies {
    implementation(project(":common"))
    implementation("io.micronaut:micronaut-runtime")
    implementation("io.micronaut:micronaut-inject")
    implementation("io.micronaut:micronaut-http-client")
    implementation("com.microsoft.onnxruntime:onnxruntime:1.17.0")
    implementation("ai.djl.huggingface:tokenizers:0.30.0")
    // Scheduler (Quartz, in-process)
    implementation("org.quartz-scheduler:quartz:2.5.0")
    implementation("org.xerial:sqlite-jdbc:3.45.0.0")  // ะดะปั Quartz JDBC JobStore
    // sqlite-vec ะทะฐะณััะถะฐะตััั ะบะฐะบ native ัะฐััะธัะตะฝะธะต
}

// === cli (Kotlin/Native) ===
kotlin {
    linuxArm64 { binaries { executable() } }
    linuxX64 { binaries { executable() } }

    sourceSets {
        nativeMain.dependencies {
            implementation(project(":common"))
            implementation("com.github.ajalt.clikt:clikt")
        }
    }
}
```

### 8.5. ะะฝััะฐััััะบัััะฐ ะฝะฐ Pi 5

```
Raspberry Pi 5 (16GB RAM)
โโโ systemd services:
โ   โโโ klaw-gateway.service         (Micronaut, ~80MB RAM)
โ   โโโ klaw-engine.service          (Micronaut + ONNX Runtime + Quartz, ~400MB RAM)
โ   โโโ docker.service               (ะดะปั code execution sandbox)
โ
โโโ ะะฟัะธะพะฝะฐะปัะฝะพ:
โ   โโโ ollama.service               (ะดะปั ะปะพะบะฐะปัะฝัั LLM + ัะผะฑะตะดะดะธะฝะณะพะฒ)
โ   โโโ searxng.service              (ะดะปั web-search skill)
โ
โโโ ะัะพะณะพ: ~480MB (ะฑะตะท Ollama)
    ะก Ollama + Qwen 3 8B Q4: ~5โ6GB
    ะะฐะฟะฐั: ~10GB ัะฒะพะฑะพะดะฝัั
```

---

## 9. ะะพะฝัะธะณััะฐัะธั

### 9.1. XDG-ัะพะฒะผะตััะธะผัะต ะฟััะธ

Klaw ัะปะตะดัะตั [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/latest/). ะขัะธ ัะฐะทะดะตะปัะฝัั concern'ะฐ: ะบะพะฝัะธะณััะฐัะธั, ะดะฐะฝะฝัะต, workspace.

```
$XDG_CONFIG_HOME/klaw/                   # ~/.config/klaw/
โโโ gateway.yaml                         # ะะฐะฝะฐะปั
โโโ engine.yaml                          # LLM, ะฟะฐะผััั, ัะฐัะฟะธัะฐะฝะธะต, skills

$XDG_DATA_HOME/klaw/                     # ~/.local/share/klaw/
โโโ conversations/                       # JSONL ะปะพะณะธ
โโโ summaries/                           # Markdown ัะฐะผะผะฐัะธ
โโโ memory/core_memory.json            # Core memory
โโโ skills/                              # ะฃััะฐะฝะพะฒะปะตะฝะฝัะต skills
โโโ klaw.db                              # SQLite โ Engine ะฒะปะฐะดะตะตั
โโโ scheduler.db                         # SQLite โ Engine ะฒะปะฐะดะตะตั (Quartz)

$XDG_STATE_HOME/klaw/                    # ~/.local/state/klaw/
โโโ engine.sock                          # Unix domain socket (Engine)
โโโ gateway-buffer.jsonl                 # ะััะตั Gateway ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ Engine
โโโ logs/                                # ะะพะณะธ ะฟัะพัะตััะพะฒ

$KLAW_WORKSPACE                          # ะัะดะตะปัะฝัะน ะฟััั, ะฟะพ ัะผะพะปัะฐะฝะธั ~/klaw-workspace/
โโโ SOUL.md, IDENTITY.md, ...            # Workspace ัะฐะนะปั ะฐะณะตะฝัะฐ
โโโ memory/                              # ะะฝะตะฒะฝัะต ะปะพะณะธ
โโโ skills/                              # Workspace skills
```

| ะะตัะตะผะตะฝะฝะฐั | Fallback | ะะฟะธัะฐะฝะธะต |
|------------|----------|----------|
| `$XDG_CONFIG_HOME/klaw` | `~/.config/klaw` | ะะพะฝัะธะณััะฐัะธั (gateway.yaml, engine.yaml) |
| `$XDG_DATA_HOME/klaw` | `~/.local/share/klaw` | ะะฐะฝัะฐะนะผ-ะดะฐะฝะฝัะต (conversations, klaw.db, scheduler.db) |
| `$XDG_STATE_HOME/klaw` | `~/.local/state/klaw` | ะกะพะบะตัั, ะฑััะตัั, ะปะพะณะธ ะฟัะพัะตััะพะฒ |
| `$XDG_CACHE_HOME/klaw` | `~/.cache/klaw` | ะัั ะผะพะดะตะปะตะน ONNX, ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั |
| `$KLAW_WORKSPACE` | `~/klaw-workspace` | Workspace ะฐะณะตะฝัะฐ (ะฟะตััะพะฝะฐ, ะฟะฐะผััั, skills) |

### 9.2. ะะฒะฐ ัะฐะนะปะฐ: gateway ะธ engine

ะะทะพะปะธัะพะฒะฐะฝะฝะพ, ะฑะตะท ะฟะตัะตัะตัะตะฝะธะน. Gateway ะฝะต ะทะฝะฐะตั ะฟัะพ LLM, engine ะฝะต ะทะฝะฐะตั ะฟัะพ Telegram-ัะพะบะตะฝั.

```yaml
# $XDG_CONFIG_HOME/klaw/gateway.yaml โ ะฒัั ััะพ ะบะฐัะฐะตััั ะฟัะธัะผะฐ/ะพัะฟัะฐะฒะบะธ ัะพะพะฑัะตะฝะธะน

channels:
  telegram:
    token: "${TELEGRAM_BOT_TOKEN}"
    allowedChatIds: ["123456"]       # whitelist ะดะปั ะฒัะพะดััะธั ะ ะธััะพะดััะธั ัะพะพะฑัะตะฝะธะน
                                     #
                                     # Inbound:  ะฟัััะพะน ัะฟะธัะพะบ = ะฟัะธะฝะธะผะฐัั ะพั ะฒัะตั
                                     # Outbound: ะฟัััะพะน ัะฟะธัะพะบ = ะะกะ outbound ะะขะะะะะฏะฎะขะกะฏ
                                     #   (ะทะฐัะธัะฐ ะพั ะณะฐะปะปััะธะฝะธััััะตะณะพ ะฐะณะตะฝัะฐ ะฟะพ ัะผะพะปัะฐะฝะธั).
                                     #   ะะปั send_message ะธ scheduler inject_into โ
                                     #   chatId ะะะฏะะะ ะฑััั ะฒ whitelist.
                                     #   ะัะฒะตัั ะฝะฐ inbound: chatId ะฒัะพะดััะตะณะพ ัะพะพะฑัะตะฝะธั
                                     #   ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฐะทัะตััะฝ ะฝะฐ ะฒัะตะผั ัะตััะธะธ (implicit allow),
                                     #   ะดะฐะถะต ะตัะปะธ ะฝะต ะฒ whitelist. ะญัะพ ะฟะพะทะฒะพะปัะตั ะฟัะธะฝะธะผะฐัั
                                     #   ะพั ะฒัะตั (ะฟัััะพะน whitelist) ะธ ะพัะฒะตัะฐัั ะธะผ.
  discord:
    enabled: false
    token: "${DISCORD_BOT_TOKEN}"
```

```yaml
# $XDG_CONFIG_HOME/klaw/engine.yaml โ ะฒัั ะพััะฐะปัะฝะพะต: LLM, ะฟะฐะผััั, skills, ัะฐัะฟะธัะฐะฝะธะต

# --- ะัะพะฒะฐะนะดะตัั ---
providers:
  glm:
    type: openai-compatible
    endpoint: "https://open.bigmodel.cn/api/paas/v4"
    apiKey: "${GLM_API_KEY}"
  deepseek:
    type: openai-compatible
    endpoint: "https://api.deepseek.com/v1"
    apiKey: "${DEEPSEEK_API_KEY}"
  ollama:
    type: openai-compatible
    endpoint: "http://localhost:11434/v1"
  anthropic:
    type: anthropic
    endpoint: "https://api.anthropic.com/v1"
    apiKey: "${ANTHROPIC_API_KEY}"

# --- ะะพะดะตะปะธ ---
# contextBudget โ ัะฐะฑะพัะธะน ะฑัะดะถะตั ะบะพะฝัะตะบััะฐ, ะทะฝะฐัะธัะตะปัะฝะพ ะผะตะฝััะต ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ะพะบะฝะฐ ะผะพะดะตะปะธ.
# ะัะธัะธะฝั: (1) ะบะฐัะตััะฒะพ ะพัะฒะตัะพะฒ ะดะตะณัะฐะดะธััะตั ะฝะฐ ะดะปะธะฝะฝัั ะบะพะฝัะตะบััะฐั ั ะฑะพะปััะธะฝััะฒะฐ ะผะพะดะตะปะตะน,
# (2) ัะบะพะฝะพะผะธั ัะพะบะตะฝะพะฒ (ะบะฐะถะดัะน ะฒัะทะพะฒ = ะดะตะฝัะณะธ), (3) ะฟัะตะดัะบะฐะทัะตะผะฐั ะปะฐัะตะฝัะฝะพััั ะฝะฐ Pi 5.
# ะะฐะฟัะธะผะตั, GLM-5 ะฟะพะดะดะตัะถะธะฒะฐะตั 128k, ะฝะพ 12k โ ะพะฟัะธะผะฐะปัะฝัะน ะฑะฐะปะฐะฝั ะบะฐัะตััะฒะฐ ะธ ััะพะธะผะพััะธ.
models:
  glm/glm-4-plus:
    maxTokens: 4096
    contextBudget: 8000
  glm/glm-5:
    maxTokens: 8192
    contextBudget: 12000
  deepseek/deepseek-chat:
    contextBudget: 12000
  deepseek/deepseek-reasoner:
    maxTokens: 16384
    contextBudget: 16000
  ollama/qwen3:8b:
    contextBudget: 6000
  anthropic/claude-sonnet-4-20250514:         # Post-MVP (ััะตะฑัะตั AnthropicClient, P1)
    maxTokens: 8192
    contextBudget: 16000

# --- Routing ---
routing:
  default: glm/glm-5
  fallback: [deepseek/deepseek-chat, ollama/qwen3:8b]
  tasks:
    summarization: ollama/qwen3:8b
    subagent: glm/glm-4-plus           # default ะดะปั ััะฑะฐะณะตะฝัะพะฒ ะฑะตะท ัะฒะฝะพะน ะผะพะดะตะปะธ

# --- ะะฐะผััั ---
memory:
  embedding:
    type: onnx                    # onnx | ollama
    model: "all-MiniLM-L6-v2"
  chunking:
    size: 400
    overlap: 80
  search:
    topK: 10

# --- ะะพะฝัะตะบัั ---
context:
  defaultBudgetTokens: 8000       # ะตัะปะธ ั ะผะพะดะตะปะธ ะฝะต ะทะฐะดะฐะฝ contextBudget
  slidingWindow: 20               # max cap, ัะผะตะฝััะฐะตััั ะตัะปะธ ะฝะต ะฒะปะตะทะฐะตั ะฒ ะฑัะดะถะตั
  subagentWindow: 5               # max cap ะดะปั ััะฑะฐะณะตะฝัะพะฒ, ะฟะพะดัะธะฝัะตััั ัะพะผั ะถะต ะฑัะดะถะตัั

# --- ะะฑัะฐะฑะพัะบะฐ ---
processing:
  debounceMs: 1500               # ัะบะปะตะธัั ัะพะพะฑัะตะฝะธั ะพั ะพะดะฝะพะณะพ chat_id ะทะฐ ััะพ ะฒัะตะผั
  maxConcurrentLlm: 2            # ะผะฐะบั ะฟะฐัะฐะปะปะตะปัะฝัั LLM-ะทะฐะฟัะพัะพะฒ (interactive + subagent)
  maxToolCallRounds: 10          # ะผะฐะบั ะธัะตัะฐัะธะน tool call loop (ะทะฐัะธัะฐ ะพั ะทะฐัะธะบะปะธะฒะฐะฝะธั)

# --- LLM retry ---
llm:
  maxRetries: 2
  requestTimeoutMs: 60000
  initialBackoffMs: 1000
  backoffMultiplier: 2.0

# --- ะะพะณะธัะพะฒะฐะฝะธะต ---
logging:
  subagentConversations: true    # ะฟะธัะฐัั JSONL ะดะปั scheduler-ะบะฐะฝะฐะปะพะฒ (ะดะปั ััะฐัะธััะธะบะธ/ะดะตะฑะฐะณะฐ)

# --- ะัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ ---
codeExecution:
  dockerImage: "klaw-sandbox:latest"
  timeout: 30
  allowNetwork: true
  maxMemory: "256m"
  maxCpus: "1.0"
  keepAlive: true
  keepAliveIdleTimeoutMin: 10
  keepAliveMaxExecutions: 50

# --- ะคะฐะนะปั ---
files:
  maxFileSizeBytes: 1048576       # 1MB, ะทะฐัะธัะฐ ะพั ะทะฐะฟะธัะธ ะณะธะณะฐะฝััะบะธั ัะฐะนะปะพะฒ
```

**ะะทะฐะธะผะพะดะตะนััะฒะธะต contextBudget ะธ subagentWindow**: ััะฑะฐะณะตะฝัั ะธัะฟะพะปัะทััั ัั ะถะต ัะพัะผัะปั ัะฑะพัะบะธ ะบะพะฝัะตะบััะฐ (ัะตะบัะธั 3.3), ะฝะพ ั `subagentWindow` ะฒะผะตััะพ `slidingWindow`. ะัะดะถะตั ะฑะตััััั ะธะท `contextBudget` ะผะพะดะตะปะธ ััะฑะฐะณะตะฝัะฐ. ะัะปะธ 5 ัะพะพะฑัะตะฝะธะน ััะฑะฐะณะตะฝัะฐ (ั ะดะปะธะฝะฝัะผะธ tool results) ะฝะต ะฒะปะตะทะฐัั ะฒ ะพััะฐะฒัะธะนัั ะฑัะดะถะตั โ ะพะบะฝะพ ัะผะตะฝััะฐะตััั ะดะพ N ัะพะพะฑัะตะฝะธะน, ะบะพัะพััะต ะฟะพะผะตัะฐัััั. ะะตะธัะฟะพะปัะทะพะฒะฐะฝะฝัะน ะฑัะดะถะตั ะฝะต ยซะฟัะพะฟะฐะดะฐะตัยป โ ะพะฝ ะฟัะพััะพ ะฝะต ะฝัะถะตะฝ, ะบะพะฝัะตะบัั ัะพะฑะธัะฐะตััั ะฟะพ ัะฐะบัั.

ะััะธ ะบ ะดะฐะฝะฝัะผ (`klaw.db`, `scheduler.db`, `conversations/`) ะฝะต ัะบะฐะทัะฒะฐัััั ะฒ ะบะพะฝัะธะณะฐั โ ะฒััะธัะปััััั ะธะท XDG-ะฟะตัะตะผะตะฝะฝัั ะฐะฒัะพะผะฐัะธัะตัะบะธ.

---

## 10. ะัะตะฝะบะฐ ะพะฑััะผะฐ ัะฐะฑะพั

### MVP (2โ3 ะฝะตะดะตะปะธ)

| ะะพะผะฟะพะฝะตะฝั | ะกััะพะบะธ (ะพัะตะฝะบะฐ) | ะัะธะพัะธัะตั |
|-----------|-----------------|-----------|
| ะะฑัะธะต ะผะพะดะตะปะธ, ัะตัะธะฐะปะธะทะฐัะธั, ััะธะปะธัั | ~500 | P0 |
| LLM ะฐะฑัััะฐะบัะธั: Client/Provider/Router | ~350 | P0 |
| LLM ะบะปะธะตะฝั: OpenAiCompatibleClient | ~200 | P0 |
| Socket server (Engine) + protocol | ~300 | P0 |
| Socket client (Gateway โ Engine) + buffer | ~200 | P0 |
| Engine: ะบะพะฝัะตะบััะฝะฐั ัะฑะพัะบะฐ + ััะฑะฐะณะตะฝัั | ~500 | P0 |
| Engine: ะพัะฝะพะฒะฝะพะน ัะธะบะป + tool call loop + debounce | ~400 | P0 |
| Tools: memory (search, save, core CRUD) | ~300 | P0 |
| Tools: file (read, write, list) | ~150 | P0 |
| Tools: docs (search, read, list + ะธะฝะดะตะบัะฐัะธั) | ~200 | P0 |
| Tools: skills (load, list + discovery) | ~150 | P0 |
| Tools: schedule, subagent_spawn, time, send_message | ~200 | P0 |
| Memory: sqlite-vec + FTS5 + ะณะธะฑัะธะดะฝัะน ะฟะพะธัะบ | ~400 | P0 |
| Memory: ONNX embedding service | ~200 | P0 |
| Memory: core memory (JSON, tool calls) | ~150 | P0 |
| Memory: ัะฐะฝะบะธะฝะณ (Markdown-aware) | ~200 | P0 |
| OpenClaw workspace loader (SOUL/IDENTITY/USER/AGENTS.md + HEARTBEATโQuartz + core_memory.json) | ~500 | P0 |
| Gateway: Telegram (Micronaut) | ~200 | P0 |
| Scheduler: Quartz + SQLite delegate + HEARTBEAT.md ะธะผะฟะพัั (ะผะพะดัะปั Engine) | ~300 | P0 |
| Code execution (Docker sandbox + sandboxing) | ~300 | P0 |
| CLI: status, schedule, memory, reindex, logs (Kotlin/Native) | ~250 | P0 |
| **ะัะพะณะพ MVP** | **~5900** | |

### Post-MVP

| ะะพะผะฟะพะฝะตะฝั | ะัะธะพัะธัะตั |
|-----------|-----------|
| Gateway: Discord | P1 |
| ะคะพะฝะพะฒะฐั ััะผะผะฐัะธะทะฐัะธั | P1 |
| OpenClaw import (`klaw import`) | P1 |
| OpenClaw ะพะฑัะฐัะฝะฐั ะทะฐะฟะธัั (MEMORY.md, daily logs) | P1 |
| BOOT.md ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ััะฐััะต | P1 |
| Skill: code-execute (SKILL.md ั best practices ะดะปั code execution) | P1 |
| LLM ะบะปะธะตะฝั: AnthropicClient (~150 ัััะพะบ) | P1 |
| LLM ะบะปะธะตะฝั: GeminiClient (~150 ัััะพะบ) | P2 |
| LLM streaming (SSE) ัะตัะตะท Micronaut HTTP Client | P2 |
| Skill: web-search (SearXNG) | P2 |
| BOOTSTRAP.md โ ะธะฝัะตัะฐะบัะธะฒะฝัะน ะพะฝะฑะพัะดะธะฝะณ | P2 |
| CLI: import, export, doctor, init | P2 |
| Temporal decay ะดะปั ะฟะพะธัะบะฐ (ัะฒะตะถะตะต = ัะตะปะตะฒะฐะฝัะฝะตะต) | P2 |
| Soul Spec v0.5 โ ะฟะพะดะดะตัะถะบะฐ soul.json | P3 |
| ะะตััะธะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณ | P3 |

---

## 11. ะขะตััะธัะพะฒะฐะฝะธะต

### ะกััะฐัะตะณะธั

| ะฃัะพะฒะตะฝั | Scope | ะะฝััััะผะตะฝัั | ะงัะพ ะฟะพะบััะฒะฐะตั |
|---------|-------|-------------|---------------|
| **Unit** | common, engine logic | kotlin.test, KMP-ัะพะฒะผะตััะธะผัะต | ะะพะดะตะปะธ ะดะฐะฝะฝัั, ัะตัะธะฐะปะธะทะฐัะธั JSONL/YAML, ัะฑะพัะบะฐ ะบะพะฝัะตะบััะฐ, ัะฐะฝะบะธะฝะณ, ะณะธะฑัะธะดะฝัะน ะฟะพะธัะบ (mock SQLite), ะฟะฐััะธะฝะณ workspace-ัะฐะนะปะพะฒ |
| **Integration** | engine + SQLite + sqlite-vec | Testcontainers / in-memory SQLite | ะะพะปะฝัะน ัะธะบะป: ัะพะพะฑัะตะฝะธะต โ ะบะพะฝัะตะบัั โ mock LLM โ tool call โ ะพัะฒะตั. ะะฐะฟะธัั/ััะตะฝะธะต JSONL. ะะฝะดะตะบัะฐัะธั ะฒ sqlite-vec |
| **LLM contract tests** | LLM clients | WireMock / ะทะฐะฟะธัะฐะฝะฝัะต ะพัะฒะตัั | OpenAI-compatible, Anthropic, Gemini: ะบะพััะตะบัะฝัะน ะผะฐะฟะฟะธะฝะณ ะทะฐะฟัะพัะพะฒ/ะพัะฒะตัะพะฒ, tool calling ัะพัะผะฐั, ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ, ัััะธะผะธะฝะณ |
| **Socket protocol tests** | Gateway โ Engine | Loopback | JSONL protocol, reconnection, buffer drain, registration handshake |
| **E2E (smoke)** | Gateway โ Engine โ Gateway | Docker Compose | Telegram webhook mock โ ะฟะพะปะฝัะน ัะธะบะป โ ะฟัะพะฒะตัะบะฐ ะพัะฒะตัะฐ |

### ะัะธะฝัะธะฟั

- **Mock LLM ะฟะพ ัะผะพะปัะฐะฝะธั** โ ัะตััั ะฝะต ัะพะดัั ะฒ ัะตะฐะปัะฝัะต API. ะะฐะฟะธัะฐะฝะฝัะต (fixture) ะพัะฒะตัั ะดะปั ะบะฐะถะดะพะณะพ ะฟัะพะฒะฐะนะดะตัะฐ.
- **common ัะตััะธััะตััั ะฝะฐ ะพะฑะพะธั ัะฐัะณะตัะฐั** โ JVM ะธ Native, ััะพะฑั ะปะพะฒะธัั platform-specific ะฑะฐะณะธ (ะพัะพะฑะตะฝะฝะพ SQLite/SqlDelight).
- **Regression-ัะตััั ะฝะฐ function calling** โ ะดะปั ะบะฐะถะดะพะน ะฟะพะดะดะตัะถะธะฒะฐะตะผะพะน ะผะพะดะตะปะธ ัะธะบัะธััะตััั ัะพัะผะฐั tool_call ะธ ะฟัะพะฒะตััะตััั ะฟะฐััะธะฝะณ. ะะธัะฐะนัะบะธะต LLM ัะฐััะพ ะปะพะผะฐัั ัะพัะผะฐั ะผะตะถะดั ะฒะตััะธัะผะธ.
- **ะขะตััั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั** โ `klaw reindex` ะบะพััะตะบัะฝะพ ะฟะตัะตัะพะฑะธัะฐะตั `klaw.db` ะธะท JSONL; sessions ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐัััั; misfire recovery Quartz.
- **Quartz + SQLite** โ misfire recovery ะฟะพัะปะต ะฟัะพััะพั Engine (2+ ัะฐัะฐ, 4+ ะฟัะพะฟััะตะฝะฝัั ะทะฐะดะฐัะธ); ะบะฐััะพะผะฝัะน `SQLiteDelegate` (`BEGIN IMMEDIATE` ะฒะผะตััะพ row-level locking); single-node mode ะฑะตะท `QRTZ_LOCKS`.

---

## 12. ะะธัะบะธ ะธ ะผะธัะธะณะฐัะธั

| ะะธัะบ | ะะตัะพััะฝะพััั | ะะปะธัะฝะธะต | ะะธัะธะณะฐัะธั |
|------|-------------|---------|-----------|
| Rabbit hole: ัะพัะตััั ะดะพะฑะฐะฒะธัั UI, multi-agent, ัะฒะพะน ะฒะตะบัะพัะฝัะน ะธะฝะดะตะบั | ะััะพะบะฐั | ะัะธัะธัะตัะบะพะต | ะัััะบะธะน scope: ะพัะบะตัััะฐัะพั + ะธะฝัะตะณัะฐัะธะธ, ะฝะต ะฟะปะฐััะพัะผะฐ |
| ะะธัะฐะนัะบะธะต LLM ะฟะปะพัะพ ะดะตัะถะฐั function calling | ะกัะตะดะฝัั | ะััะพะบะพะต | Fallback ะฝะฐ DeepSeek-V3 (ะปัััะธะน function calling ััะตะดะธ ะบะธัะฐะนัะบะธั ะผะพะดะตะปะตะน). ะขะตััั ะฝะฐ ะบะฐะถะดัั ะผะพะดะตะปั |
| ONNX Runtime ะฝะฐ ARM64 ัะพัะผะพะทะธั | ะะธะทะบะฐั | ะกัะตะดะฝะตะต | Fallback: Ollama `all-minilm` ะดะปั ัะผะฑะตะดะดะธะฝะณะพะฒ ัะตัะตะท HTTP |
| Docker overhead ะฝะฐ ARM ะดะปั ะบะฐะถะดะพะณะพ code_execute ะฒัะทะพะฒะฐ | ะกัะตะดะฝัั | ะััะพะบะพะต | Keep-alive ะบะพะฝัะตะนะฝะตั: `docker exec` ะฒะผะตััะพ `docker run --rm` (2โ5 ัะตะบ โ ~100ms). ะะตัะตัะพะทะดะฐะฝะธะต ะบะฐะถะดัะต 50 ะฒัะทะพะฒะพะฒ ะธะปะธ 10 ะผะธะฝ ะฑะตะทะดะตะนััะฒะธั. ะะพะฝัะธะณััะธััะตะผะพ: `keepAlive: false` ะดะปั ะผะฐะบัะธะผะฐะปัะฝะพะน ะธะทะพะปััะธะธ |
| JSONL ัะฐะนะปั ัะฐะทัะฐััะฐัััั | ะะธะทะบะฐั | ะะธะทะบะพะต | ะะพัะฐัะธั ะฟะพ ะผะตัััะฐะผ, ะฐััะธะฒะฐัะธั ััะฐััั. ะัะธ 1000 ัะพะพะฑัะตะฝะธะน/ะดะตะฝั โ 1MB/ะดะตะฝั |
| KMP common ะพะณัะฐะฝะธัะธะฒะฐะตั ะฒัะฑะพั ะฑะธะฑะปะธะพัะตะบ | ะกัะตะดะฝัั | ะกัะตะดะฝะตะต | ะะพะปััะธะฝััะฒะพ kotlinx-* ัะถะต KMP. SqlDelight ะทัะตะปัะน. JVM-only ะทะฐะฒะธัะธะผะพััะธ ะพััะฐัััั ะฒ ัะฒะพะธั ะผะพะดัะปัั |
| ะัะธะฑะปะธะถัะฝะฝัะน ะฟะพะดัััั ัะพะบะตะฝะพะฒ (ยฑ15%) | ะกัะตะดะฝัั | ะกัะตะดะฝะตะต | Safety margin 10% ะฒ contextBudget. Tech debt: ะทะฐะผะตะฝะธัั ะฝะฐ HuggingFace Tokenizer (Post-MVP). ะะพะฝะธัะพัะธัั API-ะพัะธะฑะบะธ `context_length_exceeded` โ ะธะฝะดะธะบะฐัะพั ะฝะตะดะพะพัะตะฝะบะธ |
| Quartz + SQLite: ะฝะตั ะพัะธัะธะฐะปัะฝะพะณะพ ะดะธะฐะปะตะบัะฐ | ะกัะตะดะฝัั | ะกัะตะดะฝะตะต | ะะฐััะพะผะฝัะน `SQLiteDelegate` extends `StdJDBCDelegate`, ะทะฐะผะตะฝัะตั `SELECT ... FOR UPDATE` ะฝะฐ `BEGIN IMMEDIATE`. Single-node mode (`isClustered = false`), ะฑะตะท `QRTZ_LOCKS`. ะัะดะตะปัะฝัะต ัะตััั ะฝะฐ misfire recovery ะฟะพัะปะต ะฟัะพััะพั |

---

## 13. ะัะธะฝัะธะฟั ัะฐะทัะฐะฑะพัะบะธ

1. **ะคะฐะนะปั > ะฑะฐะทั ะดะฐะฝะฝัั** ะดะปั ะฒัะตะณะพ, ััะพ ัะตะปะพะฒะตะบ ะผะพะถะตั ะทะฐัะพัะตัั ะฟัะพัะธัะฐัั ะธะปะธ ะพััะตะดะฐะบัะธัะพะฒะฐัั
2. **SQLite ัะพะปัะบะพ ะบะฐะบ ะบัั/ะธะฝะดะตะบั**, ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผัะน ะธะท ัะฐะนะปะพะฒ
3. **ะัะพัะตััั ะฝะต ะดะตะปัั ัะพััะพัะฝะธะต** โ ะบะฐะถะดัะน ะฒะปะฐะดะตะตั ัะฒะพะธะผะธ ะดะฐะฝะฝัะผะธ, ะพะฑัะฐัััั ัะตัะตะท Unix domain sockets
4. **ะะปะฐะฝะธัะพะฒัะธะบ ะฝะต ะฒัะทัะฒะฐะตั LLM ะฝะฐะฟััะผัั** โ ะพะฝ ะฟะตัะตะดะฐัั ะฟะฐัะฐะผะตััั (ะฒะบะปััะฐั ะผะพะดะตะปั) ะฒ Engine, ะบะพัะพััะน ะฒัะฟะพะปะฝัะตั ะฒัะทะพะฒ
5. **Convention over Configuration** โ ะผะธะฝะธะผัะผ ะผะฐะณะธะธ, ะผะฐะบัะธะผัะผ ะฟัะตะดัะบะฐะทัะตะผะพััะธ
6. **ะะพะฝัะตะบัั ัะพะฑะธัะฐะตััั ะฝะฐ ะปะตัั** โ ะฝะธะบะฐะบะพะน ะผััะฐัะธะธ ะธััะพัะธะธ
7. **Append-only** โ ัะพะพะฑัะตะฝะธั ะฝะธะบะพะณะดะฐ ะฝะต ัะดะฐะปััััั ะธ ะฝะต ะผะพะดะธัะธัะธัััััั
8. **ะะฐะถะดัะน ะฟัะพัะตัั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ** โ ะฟัะธ ะฟะฐะดะตะฝะธะธ/ะฟะพะฒัะตะถะดะตะฝะธะธ ะดะฐะฝะฝัั ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท ัะฐะนะปะพะฒ ะธะปะธ misfire recovery
