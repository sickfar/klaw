# Where Klaw Data Lives

## Configuration

**Base path:** `$XDG_CONFIG_HOME/klaw/` (typically `~/.config/klaw/`)

| File | Description |
|------|-------------|
| `gateway.json` | Gateway configuration: channels, tokens, allowedChatIds, commands |
| `engine.json` | Engine configuration: LLM providers, models, routing, memory, scheduling, code execution |
| `deploy.conf` | Deployment mode (`native`, `hybrid`, or `docker`) and Docker image tag. Written by `klaw init`; read by CLI service commands. |
| `docker-compose.json` | (hybrid mode only) Docker Compose file with bind mounts to host XDG paths. Generated by `klaw init` when hybrid mode is selected. |
| `.env` | API keys (Telegram token, LLM API key). Created with `0600` permissions. |

Configuration files are read-only from the agent's perspective. The user must edit them directly.

---

## Conversations

**Path:** `$XDG_DATA_HOME/klaw/conversations/{chatId}/YYYY-MM-DD.jsonl`
(typically `~/.local/share/klaw/conversations/`)

- One JSONL file per day per chat
- Append-only; never modified after writing
- Written exclusively by the Gateway process
- Example: `conversations/telegram_123456/2026-02-24.jsonl`
- Each line is a JSON object with `id`, `ts`, `role`, `content` fields
- Role is `"user"` for incoming messages, `"assistant"` for engine replies

---

## Summaries

**Path:** `$XDG_DATA_HOME/klaw/summaries/{chatId}/YYYY-MM-DD_msg_{from}_{to}.md`
(typically `~/.local/share/klaw/summaries/`)

- Human-readable Markdown summaries of conversation segments
- Generated by background summarization (post-MVP feature)
- Also indexed in archival memory for long-term retrieval

---

## Skills

**System skills path:** `$XDG_DATA_HOME/klaw/skills/`
(typically `~/.local/share/klaw/skills/`)

- Skills installed system-wide
- Lower priority than workspace skills with the same name when names collide

**Workspace skills path:** `$KLAW_WORKSPACE/skills/`

- Skills specific to the active workspace
- Take priority over system skills

---

## Databases

| File | Owner | Contents |
|------|-------|----------|
| `~/.local/share/klaw/klaw.db` | Engine (exclusive) | Messages, sessions, vector embeddings (sqlite-vec), FTS5 indexes |
| `~/.local/share/klaw/scheduler.db` | Engine (exclusive) | Quartz scheduler jobs and triggers |

Both databases are caches/indexes only. The source of truth is the JSONL files. Databases can be rebuilt via `klaw reindex`.

---

## IPC and Buffers

| Item | Description |
|------|-------------|
| TCP port `7470` on `127.0.0.1` | Engine listens for IPC connections; port is open only while Engine is running |
| `~/.local/state/klaw/gateway-buffer.jsonl` | Messages buffered by Gateway when Engine was unavailable; drained automatically on reconnect |

The engine TCP port is configurable via `KLAW_ENGINE_PORT` (default `7470`). The bind address is configurable via `KLAW_ENGINE_BIND` (default `127.0.0.1`). Clients (gateway, CLI) connect to `KLAW_ENGINE_HOST` (default `127.0.0.1`).

In Docker containers, the engine binds to `0.0.0.0` (`KLAW_ENGINE_BIND=0.0.0.0`) so other containers can reach it via the Docker network. The gateway uses `KLAW_ENGINE_HOST=engine` (Docker service name). The host can reach the engine via port mapping `127.0.0.1:7470:7470`.

If the engine port is not reachable, Engine is not running. Start it with:

```bash
systemctl --user start klaw-engine
# or directly:
klaw-engine
```

---

## Logs

**Path:** `~/.local/state/klaw/logs/`

| File | Description |
|------|-------------|
| `engine.log` | Engine (JVM) — rolling file, DEBUG level for `io.github.klaw`, INFO for root |
| `gateway.log` | Gateway (JVM) — same configuration as Engine |
| `cli.log` | CLI (Native) — append-only file log. INFO by default, DEBUG with `klaw -v`. Falls back to `/tmp/klaw/cli.log` if the logs directory does not yet exist (e.g. before `klaw init`). |

```bash
# View recent Engine logs
tail -f ~/.local/state/klaw/logs/engine.log

# View recent Gateway logs
tail -f ~/.local/state/klaw/logs/gateway.log

# View recent CLI logs
tail -f ~/.local/state/klaw/logs/cli.log
```

---

## Model Cache

**Path:** `$XDG_CACHE_HOME/klaw/models/` (typically `~/.cache/klaw/models/`)

- ONNX model files (~80 MB for all-MiniLM-L6-v2)
- Managed automatically by Engine on first startup
- Safe to delete; re-downloaded on next Engine start

---

## Workspace

**Path:** `$KLAW_WORKSPACE` (default `~/klaw-workspace/`)

The agent has read/write access here via file tools. Standard workspace files:

| File/Dir | Description |
|----------|-------------|
| `SOUL.md` | Agent identity and values |
| `IDENTITY.md` | Working identity for the current context |
| `AGENTS.md` | Subagent definitions |
| `MEMORY.md` | Active working memory |
| `HEARTBEAT.md` | Heartbeat log |
| `skills/` | Workspace-local skills |
| `memory/` | Additional memory files |

The agent cannot read or write files outside this directory via file tools (path traversal protection).
