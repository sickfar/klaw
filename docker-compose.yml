services:
  engine:
    image: ghcr.io/sickfar/klaw-engine:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/engine/Dockerfile
    env_file: ~/.config/klaw/.env
    environment:
      - KLAW_WORKSPACE=/workspace
    volumes:
      - klaw-state:/root/.local/state/klaw
      - ~/.local/share/klaw:/root/.local/share/klaw
      - ~/workspace:/workspace
      - ~/.config/klaw:/root/.config/klaw:ro
    restart: unless-stopped

  gateway:
    image: ghcr.io/sickfar/klaw-gateway:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/gateway/Dockerfile
    env_file: ~/.config/klaw/.env
    depends_on:
      - engine
    ports:
      - "37474:37474"
    volumes:
      - klaw-state:/root/.local/state/klaw
      - ~/.local/share/klaw:/root/.local/share/klaw
      - ~/.config/klaw:/root/.config/klaw:ro
    restart: unless-stopped

  cli:
    image: ghcr.io/sickfar/klaw-cli:${KLAW_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: docker/cli/Dockerfile
    env_file: ~/.config/klaw/.env
    environment:
      - KLAW_WORKSPACE=/workspace
      - KLAW_IMAGE_TAG=${KLAW_IMAGE_TAG:-latest}
    volumes:
      - klaw-state:/root/.local/state/klaw
      - ~/.local/share/klaw:/root/.local/share/klaw
      - ~/workspace:/workspace
      - ~/.config/klaw:/root/.config/klaw
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.yml:/app/docker-compose.yml:ro
    profiles:
      - cli
    stdin_open: true
    tty: true

volumes:
  klaw-state:
    name: klaw-state
